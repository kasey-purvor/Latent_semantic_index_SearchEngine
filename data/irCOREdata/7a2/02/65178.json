{"doi":"10.1109\/LICS.2004.1319617","coreId":"65178","oai":"oai:dro.dur.ac.uk.OAI2:6680","identifiers":["oai:dro.dur.ac.uk.OAI2:6680","10.1109\/LICS.2004.1319617"],"title":"First-order definable retraction problems for posets and reflexive graphs.\\ud","authors":["Dalmau,  V.","Krokhin,  A.","Larose,  B."],"enrichments":{"references":[],"documentType":{"type":1}},"contributors":[],"datePublished":"2004-01-01","abstract":"A retraction from a structure P to its substructure Q is a homomorphism from P onto Q that is the identity on Q. We present an algebraic condition which completely characterises all posets and all reflexive graphs Q with the following property: the class of all posets or reflexive graphs, respectively, that admit a retraction onto Q is first-order definable.\\u","downloadUrl":"https:\/\/core.ac.uk\/download\/pdf\/65178.pdf","fullTextIdentifier":"http:\/\/dro.dur.ac.uk\/6680\/1\/6680.pdf","pdfHashValue":"d0fe5c7ec6541199c21b62d900d0c36073d67581","publisher":"IEEE","rawRecordXml":"<record><header><identifier>\n  \n    \n      oai:dro.dur.ac.uk.OAI2:6680<\/identifier><datestamp>\n      2011-12-14T09:59:34Z<\/datestamp><\/header><metadata><oai_dc:dc xmlns:oai_dc=\"http:\/\/www.openarchives.org\/OAI\/2.0\/oai_dc\/\" xmlns:dc=\"http:\/\/purl.org\/dc\/elements\/1.1\/\" xmlns:xsi=\"http:\/\/www.w3.org\/2001\/XMLSchema-instance\" xsi:schemaLocation=\"http:\/\/www.openarchives.org\/OAI\/2.0\/oai_dc\/ http:\/\/www.openarchives.org\/OAI\/2.0\/oai_dc.xsd\" ><dc:title>\n    \n      \n        First-order definable retraction problems for posets and reflexive graphs.\\ud\n<\/dc:title><dc:creator>\n        Dalmau,  V.<\/dc:creator><dc:creator>\n        Krokhin,  A.<\/dc:creator><dc:creator>\n        Larose,  B.<\/dc:creator><dc:description>\n        A retraction from a structure P to its substructure Q is a homomorphism from P onto Q that is the identity on Q. We present an algebraic condition which completely characterises all posets and all reflexive graphs Q with the following property: the class of all posets or reflexive graphs, respectively, that admit a retraction onto Q is first-order definable.\\ud\n<\/dc:description><dc:publisher>\n        IEEE<\/dc:publisher><dc:source>\n        (2004). 19th annual IEEE symposium on logic in computer science, LICS'04, 13-17 July 2004, Turku, Finland ; proceedings. : IEEE, pp. 232-241<\/dc:source><dc:date>\n        2004-01-01<\/dc:date><dc:type>\n        Book chapter<\/dc:type><dc:type>\n        PeerReviewed<\/dc:type><dc:identifier>\n        dro:6680<\/dc:identifier><dc:identifier>\n        http:\/\/dro.dur.ac.uk\/6680\/<\/dc:identifier><dc:identifier>\n        http:\/\/dx.doi.org\/10.1109\/LICS.2004.1319617 <\/dc:identifier><dc:format>\n        application\/pdf<\/dc:format><dc:identifier>\n        http:\/\/dro.dur.ac.uk\/6680\/1\/6680.pdf<\/dc:identifier><dc:rights>\n        \u00a92004 IEEE. This material is presented to ensure timely dissemination of scholarly and technical work. Copyright and all rights therein are retained by authors or by other copyright holders. All persons copying this information are expected to adhere to the terms and constraints invoked by each author's copyright. In most cases, these works may not be reposted without the explicit permission of the copyright holder.\\ud\n\\ud\nPersonal use of this material is permitted. However, permission to reprint\/republish this material for advertising or promotional purposes or for creating new collective works for resale or redistribution to servers or lists, or to reuse any copyrighted component of this work in other works must be obtained from the IEEE.\\ud\n<\/dc:rights><dc:accessRights>\n        info:en-repo\/semantics\/openAccess<\/dc:accessRights><\/oai_dc:dc><\/metadata><\/record>","journals":null,"language":{"code":"en","id":9,"name":"English"},"relations":[],"year":2004,"topics":[],"subject":["Book chapter","PeerReviewed"],"fullText":"Durham Research Online\nDeposited in DRO:\n06 April 2010\nVersion of attached file:\nPublished Version\nPeer-review status of attached file:\nPeer-reviewed\nCitation for published item:\nDalmau, V. and Krokhin, A. and Larose, B. (2004) \u2019First-order definable retraction problems for posets and\nreflexive graphs.\u2019, in 19th annual IEEE symposium on logic in computer science, LICS\u201904, 13-17 July 2004,\nTurku, Finland ; proceedings. , pp. 232-241.\nFurther information on publisher\u2019s website:\nhttp:\/\/dx.doi.org\/10.1109\/LICS.2004.1319617\nPublisher\u2019s copyright statement:\n2004 IEEE. This material is presented to ensure timely dissemination of scholarly and technical work. Copyright and\nall rights therein are retained by authors or by other copyright holders. All persons copying this information are\nexpected to adhere to the terms and constraints invoked by each author\u2019s copyright. In most cases, these works may\nnot be reposted without the explicit permission of the copyright holder. Personal use of this material is permitted.\nHowever, permission to reprint\/republish this material for advertising or promotional purposes or for creating new\ncollective works for resale or redistribution to servers or lists, or to reuse any copyrighted component of this work in\nother works must be obtained from the IEEE.\nAdditional information:\nUse policy\nThe full-text may be used and\/or reproduced, and given to third parties in any format or medium, without prior permission or charge, for\npersonal research or study, educational, or not-for-profit purposes provided that:\n\u2022 a full bibliographic reference is made to the original source\n\u2022 a link is made to the metadata record in DRO\n\u2022 the full-text is not changed in any way\nThe full-text must not be sold in any format or medium without the formal permission of the copyright holders.\nPlease consult the full DRO policy for further details.\nDurham University Library, Stockton Road, Durham DH1 3LY, United Kingdom\nTel : +44 (0)191 334 3042 \u2014 Fax : +44 (0)191 334 2971\nhttp:\/\/dro.dur.ac.uk\n  \n \nDurham Research Online \n \nDeposited in DRO: \n06 April 2010 \n \nPeer-review status: \nPeer-reviewed \n \nPublication status: \nPublished version \n \nCitation for published item: \nDalmau, V. and Krokhin, A. and Larose, B. (2004) 'First-order definable retraction problems \nfor posets and reflexive graphs.', in 19th annual IEEE symposium on logic in computer \nscience, LICS'04, 13-17 July 2004, Turku, Finland ; proceedings. , pp. 232-241. \n \nFurther information on publisher\u2019s website: \nhttp:\/\/dx.doi.org\/10.1109\/LICS.2004.1319617 \n \nPublisher\u2019s copyright statement: \n\u00a92004 IEEE. This material is presented to ensure timely dissemination of scholarly and \ntechnical work. Copyright and all rights therein are retained by authors or by other copyright \nholders. All persons copying this information are expected to adhere to the terms and \nconstraints invoked by each author's copyright. In most cases, these works may not be \nreposted without the explicit permission of the copyright holder. \n \nPersonal use of this material is permitted. However, permission to reprint\/republish this \nmaterial for advertising or promotional purposes or for creating new collective works for \nresale or redistribution to servers or lists, or to reuse any copyrighted component of this work \nin other works must be obtained from the IEEE. \n \n \nUse policy \n \nThe full-text may be used and\/or reproduced, and given to third parties in any format or medium, without prior \npermission or charge, for personal research or study, educational, or not-for-profit purposes provided that : \n \n\uf0a7 a full bibliographic reference is made to the original source \n\uf0a7 a link is made to the metadata record in DRO \n\uf0a7 the full-text is not changed in any way \n \nThe full-text must not be sold in any format or medium without the formal permission of the copyright holders. \n \nPlease consult the full DRO policy for further details. \n \nDurham University Library, Stockton Road, Durham DH1 3LY, United Kingdom \nTel : +44 (0)191 334 2975 | Fax : +44 (0)191 334 2971 \nhttp:\/\/dro.dur.ac.uk \nFirst-order definable retraction problems\nfor posets and reflexive graphs\u2217\nV\u0131\u00b4ctor Dalmau\nDepartment of Technology\nUniversity Pompeu Fabra\nBarcelona 08003, Spain\nvictor.dalmau@upf.edu\nAndrei Krokhin\nDepartment of Computer Science\nUniversity of Durham\nDurham, DH1 3LE, UK\nandrei.krokhin@durham.ac.uk\nBenoit Larose\nDepartment of Mathematics and Statistics\nConcordia University\nMontre\u00b4al, Canada H3G 1M8\nlarose@mathstat.concordia.ca\nNovember 10, 2005\nAbstract\nA retraction from a structure P to its substructure Q is a homomorphism from P onto Q that is\nthe identity on Q. We present an algebraic condition which completely characterises all posets and all\nreflexive graphs Q with the following property: the class of all posets or reflexive graphs, respectively,\nthat admit a retraction onto Q is first-order definable.\nKeywords: retraction, homomorphism, graphs, posets, first-order definability\n1 Introduction\nLet \u03c0 be a vocabulary that may contain only relation and constant symbols. Throughout the paper we use\nthe same boldface and slanted capital letters to denote a structure and its universe, respectively. Recall that\na homomorphism from a \u03c0-structure P to a \u03c0-structure Q is a mapping h from P to Q such that, for any\nrelation symbol R in \u03c0, we have h(x) \u2208 RQ whenever x \u2208 RP, and, for any constant symbol c \u2208 \u03c0, we\nhave h(cP) = cQ. If, in addition, Q is a substructure of P and h fixes every element of Q then h is said to\nbe a retraction.\nHomomorphism and retraction problems have been an object of intensive study in combinatorics, logic,\nand computer science. The homomorphism problem for a fixed \u03c0-structure Q (denoted Hom(Q)) is whether\na given \u03c0-structure P admits a homomorphism to Q. The retraction problem for Q (denoted Ret(Q)) is\ndefined similarly. The homomorphism and retraction problems are equivalent to constraint satisfaction\nproblems that are much studied in computer science (and, in particular, in finite model theory) and artificial\nintelligence (see, e.g., [5, 7, 14, 33]).\nNote that Hom(Q) and Ret(Q) can be viewed as classes of structures that admit a homomorphism or\nretraction, respectively, to Q. Hence one can try to describe these classes (or their complements \u00acHom(Q)\n\u2217A short version of this paper appeared in the Proceedings of the 19th Symposium on Logic in Computer Science (LICS 2004).\n1\nand \u00acRet(Q)) in various logics (see, e.g., [1, 8, 9, 14, 22]). In this paper, we will describe the complements\nbecause they are homomorphism-closed and it is perhaps more customary to consider homomorphism-\nclosed classes (see, e.g., [14, 15]). If Q is a structure over the relational vocabulary \u03c0, and Q = {q1, . . . , qk}\nthen, in order to describe Ret(Q) or \u00acRet(Q) in logics, it is natural to consider structures over the vo-\ncabulary \u03c3 = \u03c0 \u222a {c1, . . . , ck} obtained from \u03c0 by adding k constant symbols c1, . . . , ck, viewing Q as a\n\u03c3-structure such that cQi = qi for all i, and assuming that all \u03c3-structures P under consideration contain Q,\nthat is, the constants interpret in P as a substructure isomorphic to Q under the map cPi \u0005\u2192 qi. A closely\nrelated problem to Ret(Q) is the one-or-all list homomorphism problem which can be viewed as the ho-\nmomorphism problem, where, in addition, each element of the input structure is assigned a list of possible\ntarget values in Q, and each of these lists consists either of a single element or of Q itself. More formally,\nlet \u03c4 = \u03c0 \u222a {R1, . . . , Rk} where R1, . . . , Rk are unary relation symbols, and view Q as a \u03c4 -structure with\nR\nQ\ni = {qi} for all i. We denote by Hom\u03c4 (Q) the class of all \u03c4 -structures P admitting a homomorphism to\nQ (as a \u03c4 -structure). Such problems have been considered for graphs (see, e.g., [13]). It is easy to notice that\nfrom the computational complexity point of view Ret(Q) and Hom\u03c4 (Q) are always equivalent. However,\nit is not so evident, if true at all, that these problems have the same descriptive complexity (that is, for any\nlogic L, they are definable or not definable in L simultaneously).\nIn this paper we will consider two important special cases of problems Ret(Q) and Hom\u03c4 (Q): those\nwhere \u03c0 consists of a single binary relation symbol and Q is either a poset or a reflexive (undirected) graph.\n(Note that Hom(Q) for such structures is trivial). Retractions play an important role in the structure theory\nof graphs and orders [11, 17, 18]. The computational complexity of these problems has been extensively\nstudied [13, 14, 16, 23, 27, 31] in an attempt to distinguish tractable cases from NP-complete ones. However,\nthis seems to be a very difficult problem in general because it is known [13, 14] that every constraint satisfac-\ntion problem can be encoded as Ret(Q) for a suitable poset or for a suitable reflexive graph Q, and general\nconstraint satisfaction problems are known to be very difficult to classify. Here we will study the descriptive\ncomplexity of these problems: classify problems Ret(Q) and Hom\u03c4 (Q) (for all possible Q) with respect\nto definability in a given logic L. More specifically, we take L to be the most studied logic FO (first-order\nlogic), and we give a complete classification for this case. Atserias [1] characterized all first-order defin-\nable problems of the form Hom(Q), where Q is any finite structure, as those having finitary duality (see\nalso [29]). The results of [1] concern a larger class of problems than the one considered in this paper, but our\ncharacterization is different and more explicit \u2013 in particular, it implies that reflexive graphs and posets Q\nfor which problems Ret(Q) and Hom\u03c4 (Q) are first-order definable can be recognized in polynomial time.\nWe remark that our results are also similar in spirit to the classification of Fixed Subgraph Homeomorphism\nproblems for directed graphs with respect to definability in logical program language Datalog( \u0007=) and in the\ninfinitary logic L\u03c9\u221e,\u03c9(\u0007=) [20, 21].\nOur proofs are based on algebraic and combinatorial characterisations of certain graphs and posets [24,\n25, 26] and on the Ehrenfeucht-Fra\u0131\u00a8sse\u00b4 method for proving inexpressibilty in FO [12, 20]. An n-ary op-\neration f on a relational structure Q is said to be a polymorphism of Q if it is a homomorphism from the\nCartesian power Qn to Q. For posets and graphs, this means that if a, b \u2208 Qn are such that (ai, bi) \u2208 \u03b8 for all\ni (where \u03b8 is the relation in Q) then we also have (f(a), f(b)) \u2208 \u03b8. If f is a polymorphism of a poset then f\nis also said to be monotone on it. We now define operations that play a most important role in this paper. An\nn-ary (n \u2265 3) operation f satisfying the condition that, for any a, f(x1, . . . , xn) = a whenever at least n\u22121\nof the xi\u2019s are equal to a is called a near-unanimity (NU) operation. It is known that, for relational struc-\ntures with a NU polymorphism, the problem Hom(Q) can be solved in polynomial time [14, 19]. For the\nsake of brevity, we shall call posets or graphs with a NU polymorphism NU-posets and NU-graphs. Along\nwith connectedness, this will be the property responsible for FO-definability (see Theorems 3.1 and 4.1).\nIt was shown in [24, 25, 26] that for connected posets and reflexive graphs, this property is equivalent on\nthe one hand to the finiteness of obstructions for Hom\u03c4 (Q), which we use to prove FO-definability, and\n2\non the other hand to connectedness of certain substructures in powers of Q, which we use together with the\nEhrenfeucht-Fra\u0131\u00a8sse\u00b4 method to show that the NU property is also a necessary condition for FO-definability.\nThe NU property has attracted much attention in algebra and combinatorics (see, e.g., [4, 10, 19, 24, 25,\n26, 34]). Examples of reflexive NU-graphs include all chordal reflexive graphs while no reflexive cycle of\nlength at least 4 has a NU polymorphism [4]. A poset is called a lattice if every pair of its elements has a\nleast upper bound and a greatest lower bound. Lattices are the simplest examples of NU-posets. Examples\nof posets without NU polymorphisms are non-dismantlable posets, including all posets in which every non-\nminimal element covers at least two elements, and every non-maximal element is covered by at least two\nelements (e.g., crowns in Fig. 2) [26]. A combinatorial characterisation of (reflexive) NU graphs and NU\nposets was obtained in [25, 26] (see Theorem 2.1).\nNote that it is not possible to bound the arity of NU polymorphisms to define NU-graphs or NU-posets,\nsince by results of [4, 10], for every n \u2265 3, there is a NU-poset and a reflexive NU-graph having no NU\npolymorphisms of arity less than n. On the positive note, NU-graphs and NU-posets can be recognized in\npolynomial time (in the size of the structure) [24, 25].\n2 Preliminaries\nFix a structure Q = \u3008Q; \u03b8\u3009 where Q = {q1, . . . , qk} and \u03b8 is a binary relation on Q. There are two\nvocabularies that we consider throughout:\n\u2022 \u03c3 = {E, c1, . . . , ck} consisting of one binary relation symbol E and k constant symbols c1, . . . , ck;\nand\n\u2022 \u03c4 = {E,R1, . . . , Rk} consisting of one binary relation symbol E and k unary relation symbols\nR1, . . . , Rk.\nThe structure Q will also be interpreted both as a \u03c3-structure and a \u03c4 -structure, where EQ is \u03b8, cQi is qi\nand RQi is {qi} for all 1 \u2264 i \u2264 k. It will always be clear from the context which vocabulary is assumed.\nSimilarly, any \u03c3-structure P can be viewed as a \u03c4 -structure with RPi = {cPi }.\nAs mentioned above, we consider the following two cases forQ: (A)Q is a graph, which we assume to\nbe reflexive (i.e. with all loops) and symmetric (i.e. undirected) or (B)Q is a poset, i.e. where \u03b8 is reflexive,\nanti-symmetric and transitive.\nA \u03c3-structure P is said to contain Q if the constants interpret in P as a substructure isomorphic to Q\nunder the map cPi \u0005\u2192 qi.\nOur results will rely on the following concept of obstruction (also called zig-zag in the case of posets)\nintroduced in [34]. We define a partial ordering on \u03c4 -structures as follows: we write that H \f H\u2032 if (i)\nH \u2286 H \u2032, (ii) EH \u2286 EH\u2032 and (iii) RHi = RH\n\u2032\ni \u2229H for all 1 \u2264 i \u2264 k. Clearly ifH \f H\u2032 then the inclusion\nmap is a homomorphism fromH toH\u2032.\nAn obstruction for the graph (resp. poset)Q is a \u03c4 -structureHwhereH is a graph (resp. poset) such that\n(1) there is no homomorphism (of \u03c4 -structures) fromH toQ, (2)H is minimal with respect to property (1)\n(in the ordering \f) and (3) the unary relations inH are pairwise disjoint. It is clear that for any \u03c4 -structure\nP which is a graph or poset, there is no homomorphism from P toQ if and only if some unary relations of\nP intersect or H \f P for some obstruction H for Q. Note that there are other notions of obstruction used\nin the study of homomorphisms (see, e.g., [8]).\nWe shall also need the following notion from universal algebra: let Q be a graph (resp. poset) and\nlet n \u2265 1: Qn denotes the Cartesian power of Q, that is, (a, b) \u2208 EQn if and only if (ai, bi) \u2208 \u03b8 for\nall 1 \u2264 i \u2264 n. An idempotent subalgebra of Qn is a subset X \u2286 Qn that can be described as follows:\nthere exists a triple (Y, (y1, . . . , yn), \u03b3) where Y is a graph (resp. poset), yi \u2208 Y for all i = 1, . . . , n and\n3\n\u03b3 is a partial map from Y to Q with domain Y \u2032 with the following property: X consists of all n-tuples\n(\u03b4(y1), . . . , \u03b4(yn)) where \u03b4 : Y \u2192 Q runs through all edge-preserving (resp. monotone) maps whose\nrestriction to Y \u2032 is equal to \u03b3.\nThe name \u201cidempotent subalgebra\u201d comes from an equivalent algebraic description which goes as fol-\nlows. An m-ary operation f onQ is called idempotent if f(x, . . . , x) = x for all x \u2208 Q. A subset X \u2286 Qn\nis an idempotent subalgebra ofQn if and only if it is preserved by all idempotent polymorphisms ofQ, that\nis, f(a1, . . . , am) \u2208 X for all m-ary idempotent polymorphisms f of Q and all a1, . . . , am \u2208 X , m \u2265 1,\nwhere f acts on tuples componentwise.\nAnother equivalent defintion for idempotent subalgebras is that they are exactly those subsets X of Qn,\nn \u2265 1, which can be defined by primitive positive first-order formulas (with n free variables) in Q (as a\n\u03c4 -structure). Equivalence of the last two definitions follows from Theorems 1.2.3 and 2.1.3 in [30], while\nequivalence of the first and the third definitions is rather straightforward.\nA combinatorial characterisation of NU posets and NU graphs is based on the notion of dismantling. A\ngraphG1 is said to dismantle to its subgraphG2 if there is a sequenceG\u20321, . . . ,G\u2032n of subgraphs ofG1 such\nthatG\u20321 = G1,G\u2032n = G2, and, for i = 1, . . . n\u2212 1,G\u2032i+1 is obtained fromG\u2032i by removing a vertex vi such\nthat vi is dominated by some other vertex ui in G\u2032i (i.e., every neighbour of vi, including vi itself, in Gi is\nalso a neighbour of ui). Similarly, a poset P1 is said to dismantle to its subposet P2 if there is a sequence\nP\u20321, . . . ,P\u2032n of subposets of P1 such that P\u20321 = P1, P\u2032n = P2, and, for i = 1, . . . n \u2212 1, P\u2032i+1 is obtained\nfrom P\u2032i by removing a vertex vi such that vi is dominated by some other vertex ui in the comparability\ngraph of P\u2032i. If Q is a graph or a poset, then the diagonal of Q2 is its subgraph (subposet, respectively)\ninduced by all nodes of the form (x, x). It is easy to see that the diagonal ofQ2 is isomorphic toQ.\nThe following result was proved in [24, 26] for posets and in [25] for graphs.\nTheorem 2.1 LetQ be a connected graph or poset. Then the following are equivalent:\n1. there are finitely many obstructions forQ;\n2. Q admits an NU polymorphism (of some arity);\n3. for every n \u2265 1, every idempotent subalgebra ofQn is connected;\n4. Q2 dismantles to its diagonal.\nNote that, for posets, it is enough to take to n = 1 in condition 3 of the above theorem [26], but, for\ngraphs, we need to consider all n \u2265 1 [25].\nWe also need the following: if P is a \u03c3- or \u03c4 -structure, let P denote its symmetric, reflexive closure, i.e.\nthe similar structure on the same universe such that (x, x) \u2208 EP for all x \u2208 P and (x, y) \u2208 EP whenever\n(x, y) \u2208 EP or (y, x) \u2208 EP. The following is immediate: there is a homomorphism from P to the graph\nQ if and only if there is a homomorphism from P toQ; and if there is a homomorphism from P to P\u2032 then\nthere is one from P to P\u2032.\nFinally, we define for each \u03c4 -structure a sentence in the language of \u03c4 which will encode the given\nstructure, see [6] and [9]: letH be a \u03c4 -structure and let H = {h1, . . . , hl}. Denote by TH the \u03c4 -sentence\n\u2203xh1 . . .\u2203xhl(\n\u2227\nE(xh, xh\u2032)) \u2227 (\n\u2227\nRi(xh))\nwhere the first conjunction is taken over all pairs (h, h\u2032) \u2208 EH and the second over all h \u2208 RHi and all\n1 \u2264 i \u2264 k.\nWhen the structure has the property that its unary relations are pairwise disjoint and each contain at most\none element, we can define a sentence in the language of \u03c3 which will encode the given structure: letH be\nsuch a \u03c4 -structure. Denote by H \u2032 the set of all h \u2208 H such that h \u0007\u2208 RHi for all i. For every h \u2208 H , set\n4\nhf = xh if h \u2208 H \u2032 and hf = ci, where h \u2208 RHi otherwise. Suppose H \u2032 = {h1, . . . , hs}. Denote by SH the\n\u03c3-sentence\n\u2203xh1 . . .\u2203xhs(\n\u2227\nE(hf , h\u2032f ))\nwhere the conjunction is taken over all pairs (h, h\u2032) such that (h, h\u2032) \u2208 EH.\nThe first statement in the next lemma is a special case of a result in [6]. Both proofs are staightforward.\nLemma 2.2 LetH and P be \u03c4 -structures and let P\u2032 be a \u03c3-structure.\n1. the sentence TH is true in P if and only if there is a homomorphism fromH to P;\n2. if cP\u2032i \u0007= cP\n\u2032\nj whenever qi \u0007= qj , and RHi contains at most one element for all 1 \u2264 i \u2264 k, then the\nsentence SH is true in P\u2032 if and only if there is a \u03c4 -homomorphism fromH to P\u2032.\n3 Graph retraction problems in FO\nIn this sectionQ is a graph. Recall that by a graph we always mean a reflexive graph. Let \u00acRet(Q) denote\nthe class of all \u03c3-structures that containQ but do not retract ontoQ. Let \u00acHom\u03c4 (Q) denote the class of all\n\u03c4 -structures that do not admit a \u03c4 -homomorphism toQ.\nOur main result for graphs is the following:\nTheorem 3.1 LetQ be a graph. Then the following conditions are equivalent:\n(1) the class \u00acRet(Q) is FO-definable;\n(2) the class \u00acHom\u03c4 (Q) is FO-definable;\n(3) Q is a connected NU-graph.\nMoreover, if any of these conditions holds then both of the above classes can be defined by a first-order\nformula that contains neither negation nor universal quantification.\nNote that the last statement of the theorem can also be obtained by combining the first part of the theorem\nwith the Finite Homomorphism Preservation Theorem [32] recently proved by Rossman.\nWe shall require the following notion from finite model theory (see [12] Definition 2.3.1):\nDefinition. Let A and A\u2032 be two structures over the same vocabulary, and let m be a non-negative\ninteger. We say that A and A\u2032 are said to be m-isomorphic if there exists a sequence (Ij)j\u2264m with the\nfollowing properties:\n1. Every Ij is a non-empty set of partial isomorphisms fromA toA\u2032;\n2. (Forth property) For every j < m, p \u2208 Ij+1 and a \u2208 A there is a q \u2208 Ij such that q is an extension of\np and a is in the domain of q;\n3. (Back property) For every j < m, p \u2208 Ij+1 and b \u2208 A\u2032 there is a q \u2208 Ij such that q is an extension of\np and b is in the range of q.\nThe following result is well known (see Theorem 2.2.12 and Corollary 2.3.4 of [12]).\nProposition 3.2 Let K be a class of finite structures such that, for every m \u2265 1, there are m-isomorphic\nstructuresAm andA\u2032m withAm \u2208 K andA\u2032m \u0007\u2208 K. Then K is not FO-definable.\nThe main technical result used in the proof is the following lemma:\n5\nProposition 3.3 Let Q be a graph. If Q is not connected or admits no NU polymorphism then, for every\ninteger m \u2265 1, there exist graphs P and P\u2032 with the following properties:\n(i) P and P\u2032 containQ;\n(ii) P and P\u2032 are m-isomorphic (as \u03c3- or \u03c4 -structures);\n(iii) P retracts ontoQ but P\u2032 does not.\nThe proof of Proposition 3.3 is found in Section 5.\nProof of Theorem 3.1. It follows from Propositions 3.2 and 3.3 that if Q is either disconnected or does\nnot admit an NU polymorphism then none of the two classes are FO-definable. So now assume that Q is\nconnected and admits an NU polymorphism. First we show that (2) holds. We build a sentence as follows:\nby Theorem 2.1, there exist finitely many obstructions for Q, say H1, . . . ,Hm. Note that the Hi\u2019s are\nobstructions in the class of all reflexive graphs, and general \u03c4 -structures are not necessarily reflexive graphs\n(with added unary relations), hence we consider the following sets. For every 1 \u2264 i \u2264 m, let L(Hi) denote\nthe set of all \u03c4 -structuresG such thatG = Hi. Consider the sentence\n(\nm\u2228\ni=1\n\u2228\nG\u2208L(Hi)\nTG) \u2228 (\u2203x(\n\u2228\n1\u2264i\u0006=j\u2264k\n(Ri(x) \u2227Rj(x))),\nwhere TG is as defined in Section 2. We claim that this sentence captures precisely those \u03c4 -structures that\nadmit no homomorphism to Q. Indeed, suppose that the sentence is true in a structure P. If the second\npart of this sentence is true in P then trivially there is no homomorphism from P to Q. Assume that the\nsecond part is false. This means that TG is true in P for some structure G such that G = Hi for some\ni. Hence by Lemma 2.2 there exists a \u03c4 -homomorphism fromG to P, and consequently a homomorphism\nfrom Hi to P. It follows that we cannot have a \u03c4 -homomorphism from P to Q. Conversely, suppose that\nthere is no homomorphism from P to Q and that the unary relations in P are pairwise disjoint; thus there\nis no homomorphism from P to Q and hence there exists some i such that Hi \f P. We show that there\nexists some G \u2208 L(Hi) that admits a homomorphism in P. Indeed, we create a substructure G of Hi by\nsetting G = Hi, EG = EHi \u2229 EP and RGj = RHij for all 1 \u2264 j \u2264 k. ClearlyG is a substructure of P and\nfurthermore G = Hi, since for each edge (x, y) \u2208 EHi with x \u0007= y, we have that either (x, y) or (y, x) is\nin EP. Thus the sentence TG is true in P.\nNext we show that (1) holds. Let L\u2032(Hi) denote the set of all \u03c4 -structures G such that G = Hi, and\nsuch that each RGi contains at most one element of G. Consider the sentence\nm\u2228\ni=1\n\u2228\nG\u2208L\u2032(Hi)\nSG,\nwhere SG is as defined in Section 2. We claim that a \u03c3-structure P containingQ does not retract ontoQ if\nand only if this sentence is true in P. Suppose that SG is true in P for some \u03c4 -structure G \u2208 L\u2032(Hi). By\nLemma 2.2 there is a \u03c4 -homomorphism fromG to P, and hence from Hi to P; consequently there cannot\nbe a \u03c4 -homomorphism from P toQ; and hence no retraction either.\nFor the converse, suppose that there is no retraction ofP ontoQ, i.e. there is no \u03c3-homomorphism from\nP to Q; then there is no \u03c4 -homomorphism either, and so there is no \u03c4 -homomorphism from P to Q. Now\nproceed exactly as in the proof of (2): there exists an obstruction Hi of Q such that Hi \f P; and simply\nnotice that, since P is a \u03c3-structure, the \u03c4 -structure G produced as above will have at most one element in\neach unary relation.\n6\n4 Poset retraction problems in FO\nIn this sectionQ is a poset. Let \u00acPoRet(Q) denote the class of all posets that containQ that do not retract\nontoQ. Let \u00acPoHom\u03c4 (Q) denote the class of all posets that do not admit a \u03c4 -homomorphism toQ.\nWe consider PoRet(Q) rather than Ret(Q) for the following reason: Ret(Q) is not FO-definable for\nany poset Q with more than one element. Indeed, it follows from the proof of Theorem 4.1 that if Q is\nnot connected then Ret(Q) is not FO-definable. Assume that Q is connected and fix elements a < b in\nQ such that a is minimal and b is maximal. One can slightly modify the construction in Exercise 2.3.9\nof [12] to obtain m-isomorphic structures with the desired properties. Let Pn be the structure obtained\nfrom Q by adding to EQ pairs forming two sufficiently long oriented (reflexive) paths an, . . . , a1 = a and\nb = b1, . . . , bn and also add a sufficiently long oriented (reflexive) cycle C not connected with the rest of\nthe digraph. Let P\u2032n be the structure obtained from Pn by adding the pair (bn, an) to EPn and removing one\narc from the cycle C. Clearly, Pn retracts onto Q (by sending all ai\u2019s to a and all bi\u2019s and C to b) while P\u2032n\ndoes not (because it contains a cycle with a and b in it). One can show that, for every m \u2265 0, there is a\nsufficiently large n such that Pn and P\u2032n are m-isomorphic, which implies that, by Proposition 3.2, Ret(Q)\nis not FO-definable.\nThe problem PoRet(Q) has been studied in connection with type reconstruction [2, 28] and constraint\nsatisfaction [14, 23], and is a natural choice for a restriction of Ret(Q).\nOur main result for posets is the following:\nTheorem 4.1 LetQ be a poset. The following conditions are equivalent:\n1. the class \u00acPoRet(Q) is FO-definable;\n2. the class \u00acPoHom\u03c4 (Q) is FO-definable;\n3. Q is a connected NU-poset.\nMoreover, if any of these conditions holds then both of the above classes can be defined by a first-order\nformula that contains neither negation nor universal quantification.\nSimilarly to Theorem 3.1, the last statement of the theorem can also be obtained by combining the first\npart of the theorem with the Finite Homomorphism Preservation Theorem.\nThe proof of the result is similar to the graph case, with two notable differences: first, the glueing\nconstruction we use in the poset case is more involved than in the case of graphs, because we must guarantee\nthat the resulting structure is transitive. On the other hand, it has been shown in [24] that if a connected poset\nQ admits no NU polymorphism then it has a disconnected idempotent subalgebra, so we do not need to\nconsider higher powers ofQ (this result is not valid for graphs, see [25]). The rest of the proof of Theorem\n4.1 is quite similar to that of Theorem 3.1 (and is in fact slightly simpler because there is no need to consider\nsymmetric reflexive closures of relations). The main technical result used in the proof is the following\nproposition, proven in Section 6.\nProposition 4.2 Let Q be a poset. If Q is not connected or admits no NU polymorphism then, for every\ninteger m \u2265 1, there exist posets P and P\u2032 with the following properties:\n1. P and P\u2032 containQ;\n2. P and P\u2032 are m-isomorphic (as \u03c3- or \u03c4 -structures);\n3. P retracts ontoQ but P\u2032 does not.\n7\nProof of Theorem 4.1. Just as in Theorem 3.1 it is immediate from Lemma 4.2 that if Q is either dis-\nconnected or admits no NU polymorphism then \u00acPoRet(Q) and \u00acPoHom\u03c4 (Q) are not FO-definable.\nSo now assume that Q is connected and admits an NU polymorphism. First we show that (2) holds. We\nbuild a sentence as follows: by Theorem 2.1, there exist finitely many obstructions forQ, sayH1, . . . ,Hm.\nConsider the sentence\n(\nm\u2228\ni=1\nTHi) \u2228 (\u2203x(\n\u2228\n1\u2264i\u0006=j\u2264k\n(Ri(x) \u2227Rj(x))).\nWe claim that this sentence captures precisely those posets that admit no \u03c4 -homomorphism to Q. Indeed,\nsuppose that the sentence is true in the structure P. If the second part of this sentence is true then trivially\nthere is no homomorphism, so assume that is is false. This means that THi is true in P for some i. Hence\nthere exists a \u03c4 -homomorphism from Hi to P. It follows that we cannot have a \u03c4 -homomorphism from P\nto Q. Conversely, suppose that there is no homomorphism from P to Q and the unary relations in P are\npairwise disjoint; thus there exists some i such thatHi \f P. Thus the sentence THi is true in P.\nNext we show that (1) holds. Let H1, . . . ,Hl denote all the obstructions for Q such that each RHii\ncontains at most one element of Hi. Consider the sentence\nl\u2228\ni=1\nSHi .\nWe claim that a poset P containing Q does not retract onto Q if and only if this sentence is true in P.\nSuppose that SHi is true in P for some i. This implies that there is a \u03c4 -homomorphism from Hi to P\n(viewed as a \u03c4 -structure), and consequently there cannot be a \u03c4 -homomorphism fromP toQ; it follows that\nthere is no \u03c3-homomorphism either.\nFor the converse, suppose that P does not retract onto Q; this means that there is no \u03c3-homomorphism\nof P to Q, and no \u03c4 -homomorphism either. Now proceed exactly as in the proof of (2): there exists an\nobstructionHi ofQ such thatHi \f P; and simply notice that, since P is a \u03c3-structure, the obstructionHi\nwill have at most one element in each unary relation.\n5 Proof of Proposition 3.3\nWe shall begin with a general construction akin to the well-known attaching construction in topology (see,\ne.g., Definition 13.13 in [3]). Let T and Q be graphs, let C \u2286 T be a subgraph of T and let \u03c6 : C \u2192 Q\nbe edge-preserving. We construct a new graph T\u03c6 obtained by glueing T andQ, identifying elements of C\nwith their corresponding images in Q. More formally, let K denote the disjoint union of the graphs T and\nQ, and define a partial function \u03c6\u2032 from K to Q by\n\u03c6\u2032(x) =\n{\nx, if x \u2208 Q,\nq, if \u03c6(x) = q.\nLet C \u2032 denote the domain of \u03c6\u2032. Notice that by definition \u03c6\u2032(x) = \u03c6(x) for all x \u2208 C. It is clear that \u03c6\u2032 is\nedge-preserving on C \u2032. Define an equivalence relation on K as follows: let x \u223c y if x = y or \u03c6\u2032(x) = \u03c6\u2032(y).\nThe base set of the graph T\u03c6 is the set of equivalence classes of the relation \u223c; denote the class of element\nx by [x]. We declare [x][y] to be an edge of T\u03c6 if uv is an edge of K for some u \u2208 [x] and some v \u2208 [y]. (It\nis immediate that the resulting binary relation is reflexive and symmetric.)\nFact 5.1 (i) T\u03c6 contains a copyQ\u2032 ofQ;\n(ii) T\u03c6 retracts ontoQ\u2032 if and only if there exists a homomorphism \u03c6 : T\u2192 Q that extends \u03c6.\n8\nProof. (i) Let q1, q2 \u2208 Q. Then obviously [q1] = [q2] if and only if q1 = q2. Now suppose that\n[q1][q2] is an edge of T\u03c6. This means there exist q1 \u223c u and v \u223c q2 where uv is an edge of K; but then\nq1 = \u03c6\u2032(u) and \u03c6\u2032(v) = q2 implies that q1q2 is an edge of Q. (ii) If r is a retraction of T\u03c6 onto Q\u2032 define\n\u03c6(x) = i(r([x])) where i is the isomorphism from Q\u2032 to Q; it is easy to verify that this is the desired map.\nConversely, let \u03c6 be an extension of \u03c6. Clearly \u03c6 is an extension of \u03c6\u2032 when this last map is restricted to T .\nDefine r([x]) = [\u03c6(x)] if x \u0007\u2208 Q and r([x]) = [x] otherwise. This is well defined: indeed, if [x] = [y] and\nwithout loss of generality x \u0007\u2208 Q, then \u03c6\u2032(x) = \u03c6\u2032(y) and clearly we have \u03c6(x) = \u03c6(y) if y \u0007\u2208 Q; otherwise\nwe certainly have \u03c6\u2032(x) = y = \u03c6(x). Now we show that r is a homomorphism: let [x][y] be an edge, i.e.\nx \u223c u and v \u223c y where uv is an edge ofK. But then r([x]) = [\u03c6(u)] and [\u03c6(v)] = r([y]) and we are done.\n5.1 The construction of the graphs\nLet Q be a graph which is either disconnected or does not admit an NU polymorphism. By Theorem 2.1\nthere exists an idempotent subalgebra X of a finite power ofQ which is not connected (ifQ is disconnected\ntake X = Q). More precisely, there exists a triple (Y, (y1, . . . , yn), \u03b3) where Y is a graph, yi \u2208 Y for all\ni = 1, . . . , n and \u03b3 is a partial map from Y to Q with domain Y \u2032 with the following property: if X denotes\nthe subset of Qn that consists of all n-tuples\n(\u03b4(y1), . . . , \u03b4(yn))\nwhere \u03b4 : Y \u2192 Q runs through homomorphisms whose restriction to Y \u2032 is equal to \u03b3, then X is not\nconnected. Let (x1, . . . , xn) and (x\u20321, . . . , x\u2032n) be in distinct components of X .\nNotice that by choosing n as small as possible we may assume that yi \u0007\u2208 Y \u2032 for all 1 \u2264 i \u2264 n; for\notherwise we could simply project X onto the remaining coordinates to obtain a disconnected idempotent\nsubalgebra in a smaller power ofQ.\nLet l = 2p \u2265 2 be an even integer, and let Cl denote the reflexive cycle on l elements, i.e. the graph on\nthe set {0, 1, . . . , l\u22121}where ij is an edge if and only if |i\u2212j| \u2264 1 (sum modulo l). Consider also the graph\nCp\n\u00b7\u222a Cp, the disjoint union of two cycles on p elements. We shall assume that the underlying set of vertices\nof this graph is the same as that of Cl, where {0, . . . , p\u2212 1} will be one copy of Cp and {p, . . . , 2p\u2212 1} the\nother.\nLemma 5.2 Let m \u2265 1, l = 2 \u00b7 3m+3, and p = 3m+3. Then the graphs Cl and Cp\n\u00b7\u222a Cp are m-isomorphic\nvia a sequence (Ij)j\u2264m such that f(0) = 0 and f(p) = p for all f \u2208 Ij and all j.\nProof: LetA and A\u2032 be obtained from Cl and Cp\n\u00b7\u222a Cp, respectively, by endowing both of them with two\nunary relations {0} and {p}. By Hanf\u2019s Locality Lemma (see [12] Theorem 2.4.1) structuresA andA\u2032 are\n(m + 2)-isomorphic. To see this, notice that both graphs have exactly the same number of occurrences of\nevery 3m+2-ball type: one, if the ball is centered at 0 or p, two if it is not centered at 0 or p but contains\none of them and finally (2 \u00b7 3m+3 \u2212 4 \u00b7 3m+2 \u2212 2) if the ball does not contain 0 or p. Let (I \u2032j)j\u2264m+2 be the\nsequence whose existence is guaranteed by Hanf\u2019s Lemma. For any 0 \u2264 j \u2264 m, let Ij contain those f in I \u2032j\nsuch that f(0) = 0 and f(p) = p. By applying the forth property on I \u2032m+2 with 0 and in I \u2032m+1 with p we\ncan guarantee that Im (and consequently (Ij), j \u2264 m) is nonempty.\nWe shall now construct graphs S and T starting from the above graphs. We shall take n disjoint copies\nof the cycle Cl (respectively the union of cycles Cp\n\u00b7\u222a Cp) and we glue l copies of Y in the following manner\n9\n(see Fig. 1): the element yi of the j-th copy of Y is identified to the element j of the i-th cycle (respectively,\nof the i-th union of cycles Cp\n\u00b7\u222a Cp). More precisely, let U be the disjoint union of l copies of Y, say Y\u00d7{z}\nfor z \u2208 {0, . . . , l \u2212 1}. Let C (resp. D) denote the disjoint union of n cycles Cl (respectively the union of\ncycles Cp\n\u00b7\u222a Cp), say {t} \u00d7 Cl (resp. {t} \u00d7 (Cp\n\u00b7\u222a Cp) ) for t \u2208 {1, . . . , n}. Let \u03bc (resp. \u03bd) be the partial\nmap from U to C (respectively to D) that sends (yi, z) to (i, z); then S is the graph U\u03bc, and T is the graph\nU\u03bd .\ny1\ny2\nyn\n.\n.\n.\ny1\ny2\nyn\n.\n.\n.\ny1\ny2\nyn\n.\n.\n.\ny1\ny2\nyn\n.\n.\n.\ny\n1\ny\n2\ny\nn\n.\n.\n.\ny1\ny2\nyn\n.\n.\n.\ny1\ny2\ny\nn\n.\n.\n.\ny 1 y\n2 y n... y1y2yn ...\nY x {0} Y x {1} Y x ...\nFigure 1: A partial view of the coloured graphsY glued to the n cyclesCl.\nAnother way of viewing this: the graph S (and similarly for T) is obtained from the disjoint copies\nY \u00d7 {z} by adding the edges (yi, j)(yi, k) when jk is an edge in Cl.\nDefine partial maps \u03c6 and \u03c8 from S and T, respectively, to Q as follows:\n\u03c6(t) = \u03c8(t) =\n\u23a7\u23a8\n\u23a9\n\u03b3(y), if t = (y, z) for some y \u2208 Y \u2032,\nxi, if t = (yi, 0),\nx\u2032i, if t = (yi, p).\nFact 5.3 The maps \u03c6 and \u03c8 are edge-preserving.\nProof. We prove the result for \u03c6. Let t1t2 be an edge in the domain of \u03c6. Notice that these elements\nmust be in the same copy of Y, i.e. t1 = (u, z) and t2 = (v, z) where uv is an edge of Y. If z \u0007= 0 and\nz \u0007= p then \u03c6 is equal to \u03b3 and we are done. If z = 0, let \u03b4 be an extension of \u03b3 such that \u03b4(yi) = xi for all\n1 \u2264 i \u2264 n: it must exist, since (x1, . . . , xn) \u2208 X . Clearly \u03c6 is a restriction of \u03b4 (on Y \u00d7 {0}) and hence is\nedge-preserving. The case z = p is identical.\nFact 5.4 (i) The map \u03c8 admits an edge-preserving extension toT; (ii) the map \u03c6 admits no edge-preserving\nextension to S.\nProof. (i) Since (x1, . . . , xn) and (x\u20321, . . . , x\u2032n) belong to X , there exist extensions \u03b4 and \u03b4\u2032 of \u03b3 fromY\ntoQ that map (y1, . . . , yn) to (x1, . . . , xn) and (x\u20321, . . . , x\u2032n) respectively. Define an extension \u03b2 of \u03c8 by\n10\n\u03b2(t) =\n{\n\u03b4(y), if t = (y, z) with z < p,\n\u03b4\u2032(y), if t = (y, z) with z \u2265 p.\nSince our graphs are reflexive, this is an edge-preserving extension of \u03c8.\n(ii) Suppose that there exists an edge-preserving extension \u03b2 of \u03c6; then for any 0 \u2264 z \u2264 l \u2212 1 the\nrestriction of \u03b2 to Y \u00d7 {z} can be seen an extension of \u03b3, and hence the tuple (\u03b2(y1, z), . . . , \u03b2(yn, z)) is in\nX . But then we have a path (\u03b2(y1, 0), . . . , \u03b2(yn, 0)), (\u03b2(y1, 1), . . . , \u03b2(yn, 1)), . . . , (\u03b2(y1, p), . . . , \u03b2(yn, p))\nin X from (x1, . . . , xn) to (x\u20321, . . . , x\u2032n), a contradiction with the choice of these two tuples.\nCorollary 5.5 The graph T\u03c8 retracts ontoQ\u2032; the graph S\u03c6 does not retract ontoQ\u2032.\nProof. Follows from Facts 5.1, 5.3 and 5.4.\n5.2 Proof ofm-isomorphism\nTo finish the proof of Proposition 3.3 we will show that T\u03c8 and S\u03c6 are the desired graphs P and P\u2032 (if we\nidentify Q with Q\u2032). It remains to prove that the graphs S\u03c6 and T\u03c8 are m-isomorphic. Let (Ij)j\u2264m be the\nsequence whose existence is guaranteed by Lemma 5.2: we proceed to construct a sequence (I\u02dcj)j\u2264m. Fix\n0 \u2264 j \u2264 m. For any f \u2208 Ij , define a partial map f\u02dc from S\u03c6 to T\u03c8 as follows: let B be any element of S\u03c6.\nIf B contains no element in the domain of \u03c6, then B = {(y, z)} and we put f\u02dc(B) = [(y, f(z))] provided\nz is in the domain of f , otherwise we leave f\u02dc(B) undefined; if B contains an element in the domain of \u03c6,\nthen it contains a unique element q \u2208 Q and we define f\u02dc(B) = [q]. Finally, define I\u02dcj = {f\u02dc : f \u2208 Ij} for all\n0 \u2264 j \u2264 m.\nLemma 5.6 The graphs S\u03c6 and T\u03c8 are m-isomorphic via (I\u02dcj)j\u2264m; moreover every partial isomorphism\nin every I\u02dcj in the sequence fixes every element of Q\u2032.\nProof. Fix some 0 \u2264 j \u2264 m and some f \u2208 Ij . It is clear that the function f\u02dc is well-defined and that it\nfixes all elements in Q\u2032, i.e. f\u02dc([q]) = [q] for all q \u2208 Q.\nClaim 1. Let B \u2208 S\u03c6. Then B \u2229Q \u0007= \u2205 if and only if f\u02dc(B) \u2229Q \u0007= \u2205.\nProof of Claim 1. One direction is obvious by definition of f\u02dc . Now suppose that f\u02dc(B) \u2229Q \u0007= \u2205 and let\n(y, z) \u2208 B. If (y, z) is in the domain of \u03c6 we are done. Otherwise f\u02dc(B) = [(y, f(z))] intersects Q so either\ny is in the domain of \u03b3, and hence (y, z) is in the domain of \u03c6, or else y = yi for some i and f(z) \u2208 {0, p};\nby the properties of f we get that z \u2208 {0, p} which again shows that (y, z) is in the domain of \u03c6. In both\ncases, we conclude by definition of S\u03c6 that B \u2229Q \u0007= \u2205.\nClaim 2. The map f\u02dc is injective.\nProof of Claim 2. Let f\u02dc(B) = f\u02dc(B\u2032). There are two cases: (i) if f\u02dc(B) = f\u02dc(B\u2032) intersects Q then by\nthe last claim both B and B\u2032 intersect Q; if q \u2208 B \u2229 Q and q\u2032 \u2208 B\u2032 \u2229 Q then by definition of f\u02dc we have\nthat [q] = f\u02dc(B) = f\u02dc(B\u2032) = [q\u2032] and hence q = q\u2032 so B = B\u2032. (ii) if f\u02dc(B) = f\u02dc(B\u2032) does not intersect Q\nthen we have by Claim 1 that B = {(y, z)} and B\u2032 = {(y\u2032, z\u2032)} for some y, y\u2032 \u2208 Y and z, z\u2032 \u2208 Cl. By\ndefinition of f\u02dc and the last claim we get that (y, f(z)) = (y\u2032, f(z\u2032)) and, since f is injective, we conclude\nthat (y, z) = (y\u2032, z\u2032) so we are done.\nClaim 3. The map f\u02dc is edge-preserving.\n11\nProof of Claim 3. Let BB\u2032 be an edge of S\u03c6, i.e. there exist u \u2208 B and v \u2208 B\u2032 such that uv is an edge\nof S; we show that f\u02dc(B)f\u02dc(B\u2032) is an edge in T\u03c8 (assuming both are defined). The result is obvious if both\nB and B\u2032 meet Q. Suppose next that neither meets Q: then B = {(y, z)} and B\u2032 = {(y\u2032, z\u2032)} and either (i)\nz = z\u2032, and yy\u2032 is an edge of Y so the result follows easily, or (ii) y = y\u2032 = yi for some 1 \u2264 i \u2264 n, zz\u2032 is\nan edge of Cl and z \u0007\u2208 {0, p}; thus f(z)f(z\u2032) is an edge and the result follows once again. By symmetry\nwe may now suppose without loss of generality that B = [q] and B\u2032 = {(y\u2032, z\u2032)}. Then (y, z) is adjacent\nto (y\u2032, z\u2032) for some (y, z) in the domain of \u03c6. Then there are two cases: (i) z = z\u2032, and yy\u2032 is an edge\nof Y. Then \u03c8((y, f(z))) = q, (y, f(z)) and (y\u2032, f(z)) are adjacent so f\u02dc(B)f\u02dc(B\u2032) is an edge in T\u03c8; (ii)\ny = y\u2032 = yi for some i, z \u2208 {0, p} and zz\u2032 is an edge of Cl. But f is edge-preserving so (yi, f(z)) is\nadjacent to (yi, f(z\u2032)) in T and, since f fixes 0 and p, we get that \u03c8((yi, f(z))) = q, so we are done.\nClaim 4. The inverse of the map f\u02dc is edge-preserving.\nProof of Claim 4. Suppose that f\u02dc(B)f\u02dc(B\u2032) is an edge in T\u03c8, i.e. there are elements u \u2208 f\u02dc(B) and\nv \u2208 f\u02dc(B\u2032) such that uv is an edge of T. We show that BB\u2032 is an edge of S\u03c6. Suppose first that both blocks\nmeet Q, say q \u2208 f\u02dc(B) and q\u2032 \u2208 f\u02dc(B\u2032) where q, q\u2032 \u2208 Q. Then of course qq\u2032 is an edge of Q, and by Claim\n1 and definition of f\u02dc we get that B = [q] is adjacent to [q\u2032] = B\u2032. Secondly, suppose that neither block\nmeets Q. Then f\u02dc(B) = {(y, f(z))} and f\u02dc(B\u2032) = {(y\u2032, f(z\u2032))} where (y, f(z))(y\u2032, f(z\u2032)) is an edge in\nT. This means that either (i) f(z) = f(z\u2032) and yy\u2032 is an edge of Y, and, since f is injective, we get that\nz = z\u2032 so (y, z)(y\u2032, z\u2032) is an edge of S, or (ii) y = y\u2032 = yi for some i and f(z)f(z\u2032) is an edge of Cp\n\u00b7\u222a Cp.\nSince f \u2208 Ij , we get that zz\u2032 is an edge of Cl and the rest follows easily. Finally suppose that f\u02dc(B) = [q]\nand f\u02dc(B\u2032) = {(y\u2032, f(z\u2032))}. Then there exists some (y, w) in the domain of \u03c8 such that \u03c8((y, w)) = q and\n(y, w)(y\u2032, f(z\u2032)) is an edge in T. If w = f(z\u2032) and yy\u2032 is an edge of Y, then by Claim 1 (y\u2032, z\u2032) \u2208 B\u2032\nand it is adjacent to (y, z\u2032) in S, and either y is in the domain of \u03b3 or y = yi and z\u2032 = f(z\u2032) \u2208 {0, p} so\n(y, z\u2032) \u2208 B and we are done. Otherwise we have that y = y\u2032 = yi for some i, wf(z\u2032) is an edge of Cp\n\u00b7\u222a Cp\nand w \u2208 {0, p}. But then f(w) = w and f is a partial isomorphism so wz\u2032 is an edge of Cl, and the rest\nfollows easily.\nWe have now proved that the sets I\u02dcj consist only of partial isomorphisms. Finally, we prove:\nClaim 5. The sequence (I\u02dcj)j\u2264m has the \u2018back and forth\u2019 property.\nProof of Claim 5. Let j < m and let f\u02dc \u2208 Ij+1. Let B \u2208 S\u03c6 (the other case, B\u2032 \u2208 T\u03c8, is identical.) If\nB intersects Q then it is in the domain of f\u02dc and we are done (we may certainly suppose that the sequence\n(I\u02dcj)j\u2264m is decreasing.) So now assume that B does not meet Q, so B = {(y, z)} where (y, z) is not in the\ndomain of f\u02dc , which means that z is not in the domain of f . By the back and forth property of the sequence\n(Ij)j\u2264m we can find g \u2208 Ij such that z is in its domain and g is an extension of f . But then it is clear that\n(y, z) is in the domain of g\u02dc \u2208 I\u02dcj and that g\u02dc is an extension of f\u02dc .\n6 Proof of Proposition 4.2\n6.1 A construction\nLet T and Q be posets, let C \u2286 T and let \u03c6 : C \u2192 Q be a monotone map. We construct a new poset T\u03c6\nobtained by glueingT andQ, identifying an element of C with its image in Q. More formally, letK denote\nthe disjoint union of the posets T and Q, and define a partial function \u03c6\u2032 from K to Q by\n\u03c6\u2032(x) =\n\u23a7\u23a8\n\u23a9\nx, if x \u2208 Q,\nq, if there exist u \u2264 x \u2264 v such that\n\u03c6(u) = \u03c6(v) = q.\n12\nLet C \u2032 denote the domain of \u03c6\u2032. Notice that by definition \u03c6\u2032(x) = \u03c6(x) for all x \u2208 C.\nA subset A of a poset P is called convex if b \u2208 A whenever a \u2264 b \u2264 c with a, c \u2208 A.\nFact 6.1 (i) \u03c6\u2032\u22121(q) is convex inK for all q \u2208 Q; (ii) \u03c6\u2032 is monotone on C \u2032.\nProof. (i) Let x \u2264 y \u2264 z with \u03c6\u2032(x) = \u03c6\u2032(z) = q. If any of x, y, z is equal to q then so are the others so\nwe are done. Otherwise, by definition of \u03c6\u2032 there exist u \u2264 x and z \u2264 v such that \u03c6(u) = \u03c6(v) = q hence\n\u03c6\u2032(y) = q. (ii) Let x \u2264 y in C \u2032. If one of these is in Q we are done. Otherwise, there exist u \u2264 x and y \u2264 v\nsuch that \u03c6\u2032(x) = \u03c6(u) \u2264 \u03c6(v) = \u03c6\u2032(y).\nDefine an equivalence relation on K as follows: let x \u223c y if x = y or \u03c6\u2032(x) = \u03c6\u2032(y). The base set of the\nposet T\u03c6 is the set of equivalence classes of the relation \u223c; denote the class of element x by [x]. We define\n[x] \u0014 [y] if u \u2264 v for some u \u2208 [x] and some v \u2208 [y]. The ordering on T\u03c6 is the transitive closure of the\nrelation \u0014. (In what follows, we shall denote the ordering on any poset by the same symbol \u2264, as usual.)\nFact 6.2 The relation \u0014 defines a partial order.\nProof. The relation is clearly reflexive and transitive so we must show that \u0014 is acyclic. Suppose that\nwe have a sequence of elements of K as follows:\nx1 \u223c y1 \u2264 x2 \u223c y2 \u2264 x3 \u00b7 \u00b7 \u00b7xn \u223c yn \u2264 xn+1 \u223c x1.\nWe must show that [x1] = [x2] = \u00b7 \u00b7 \u00b7 = [xn]. If xi = yi for all i but one then we are done. Otherwise, there\nexists some i < j such that xi \u0007= yi and xj \u0007= yj . Choose i < j as close to one another as possible in the\ncycle: then we get that yi \u2264 xi+1 \u2264 \u00b7 \u00b7 \u00b7 \u2264 xj\u22121 \u2264 xj so that \u03c6\u2032(xi) \u2264 \u03c6\u2032(xj) by Fact 1 (ii). Repeating this\nargument for all indices k such that xk \u0007= yk shows that \u03c6\u2032 is constant on those elements of the sequence\nwhere it is defined; and by Fact 1 (i) it follows that in fact \u03c6\u2032 is defined for all elements of the sequence.\nFact 6.3 (i)T\u03c6 contains a copyQ\u2032 ofQ; (ii)T\u03c6 retracts ontoQ if and only if there exists a monotone map\n\u03c6 : T\u2192 Q that extends \u03c6.\nProof. (i) Let q1, q2 \u2208 Q. Then obviously [q1] = [q2] if and only if q1 = q2. Now suppose that\n[q1] \u0014 [q2] in T\u03c6. This means there exist q1 \u223c u \u2264 v \u223c q2. But then q1 = \u03c6\u2032(u) \u2264 \u03c6\u2032(v) = q2. (ii) If r is\na retraction of T\u03c6 ontoQ define \u03c6(x) = r([x]); it is easy to verify that this is the desired map. Conversely,\nlet \u03c6 be an extension of \u03c6. Clearly \u03c6 is an extension of \u03c6\u2032 when this last map is restricted to T . Define\nr([x]) = [\u03c6(x)] if x \u0007\u2208 Q and r([x]) = [x] otherwise. This is well defined: indeed, if [x] = [y] and without\nloss of generality x \u0007\u2208 Q, then \u03c6\u2032(x) = \u03c6\u2032(y) and clearly we have \u03c6(x) = \u03c6(y) if y \u0007\u2208 Q; otherwise we\ncertainly have \u03c6\u2032(x) = y = \u03c6(x). Now we show that r is monotone. Let [x] \u0014 [y], i.e. x \u223c u \u2264 v \u223c y. But\nthen r([x]) = [\u03c6(u)] \u0014 [\u03c6(v)] = r([y]).\n13\n6.2 The construction of the posets\nLet Q be a poset which is either disconnected or does not admit an NU polymorphism. By Theorem 2.1\nthere exists an idempotent subalgebra X of some power Qn which is not connected (if Q is disconnected\ntake X = Q). In fact, by a result of [24] we may assume that n = 1. More precisely, there exists a triple\n(Y, y0, \u03b3) where Y is a poset, y0 \u2208 Y and \u03b3 is a partial map from Y to Q with domain Y \u2032 with the following\nproperty: if X denotes the subset of Q that consists of all \u03b4(y0) where \u03b4 : Y \u2192 Q runs through all monotone\nmaps whose restriction to Y \u2032 is equal to \u03b3, then X is not connected. Let x and x\u2032 be in distinct components\nof X .\nWe claim that we may choose (Y, y0, \u03b3) with the following properties: (i) if y \u2208 Y \u2032 is comparable to y0\nthen \u03b3(y) \u0007\u2208 {x, x\u2032} and (ii) if y < y\u2032 in Y \u2032 then \u03b3(y) < \u03b3(y\u2032).\nIndeed, the first condition follows from the fact that x and x\u2032 are both in X and are incomparable. For\nthe second statement: clearly \u03b3 is monotone on its domain (since X in nonempty) so if (ii) does not hold\nthen we have \u03b3(y) = \u03b3(y\u2032) = q for some y < y\u2032 in Y \u2032 and some q \u2208 Q. Obviously we may assume in\nthat case that \u03b3(u) = q for all y \u2264 u \u2264 y\u2032. It is easy to see that one may \u2018fuse\u2019 all these elements into one\nto obtain a new triple (Y1, y0, \u03b31) with the same properties as before, namely that X is the set of all \u03b4(y0),\nwhere \u03b4 ranges over the set of all monotone extensions of \u03b31 (simply define a partial map \u03b1 from Y to the\none-element poset with domain {u : y \u2264 u \u2264 y\u2032} and use the construction of section 6.1).\nLet p be an even integer and l = 2p. Let Cl denote the crown on l elements, that is, the poset on the\nset {0, 1, . . . , l \u2212 1} where i < j if and only if i is even and |i \u2212 j| = 1 (sum modulo l). Consider also\nthe graph Cp\n\u00b7\u222a Cp, the disjoint union of two crowns on p elements. We shall assume that the underlying\nset of vertices of this poset is the same as that of Cl, where {0, . . . , p \u2212 1} will be one copy of Cp and\n{p, . . . , 2p\u2212 1} the other (see Figure 2).\n0\n0 8\n8\nFigure 2: The posets C16 and C8\n\u00b7\u222a C8.\nWe now view the above as coloured posets, i.e. structures with one binary relation (their ordering) and\ntwo constants, namely 0 and p. We claim that these structures are m-isomorphic.\nLemma 6.4 Let m \u2265 1, l = 4 \u00b73m+3, and p = 2 \u00b73m+3. Then the posets Cl and Cp\n\u00b7\u222a Cp are m-isomorphic\nvia a sequence (Ij)j\u2264m such that f(0) = 0 and f(p) = p for all f \u2208 Ij and all j.\nProof. The proof is almost identical to that of Lemma 5.2 above. The only difference is that l and p are\ndoubled here, since the size of a crown is always an even number.\nWe shall now construct posets S and T starting from the above posets. We glue copies of Y (at y0) to\nevery element of the crown and the union of crowns. More precisely, let U be the disjoint union of l copies\n14\nof Y, say Y \u00d7 {z} for z \u2208 {0, . . . , l \u2212 1}. Let \u03bc (resp. \u03bd) be the partial map from U to Cl (respectively to\nCp\n\u00b7\u222a Cp) that sends (y0, z) to z; then S is the poset U\u03bc, and T is the poset U\u03bd .\n0\nY\nFigure 3: A coloured posetY, and a partial view of the poset S. Darkened vertices in the copies ofY are in\nthe domain of \u03c8.\nDefine partial maps \u03c6 and \u03c8 from S and T , respectively, to Q, as follows:\n\u03c6(t) = \u03c8(t) =\n\u23a7\u23a8\n\u23a9\n\u03b3(y), if t = (y, z) for some y \u2208 Y \u2032,\nx, if t = (y0, 0),\nx\u2032, if t = (y0, p).\nFact 6.5 The maps \u03c6 and \u03c8 are monotone.\nProof. We prove the result for \u03c6. Let t1 \u2264 t2 be in the domain of \u03c6. Suppose first that these elements are\nin the same copy of Y , i.e. t1 = (y1, z) and t2 = (y2, z) where y1 \u2264 y2. If neither is equal to y0 then\n\u03c6(t1) = \u03b3(y1) \u2264 \u03b3(y2) = \u03c6(t2). Otherwise suppose without loss of generality that y1 = y0 and that z = 0;\nwe must show that x \u2264 \u03b3(y2). But, since x \u2208 X , there exists an monotone extension \u03b3 of \u03b3 such that\n\u03b3(y0) = x so we are done.\nNow suppose that t1 and t2 are in different copies of Y . Then we have that t1 = (y1, z1) and t2 =\n(y2, z2) where y1 \u2264 y0 \u2264 y2 and z1 \u2264 z2. By definition of \u03c6 at most one of y1, y2 is equal to y0 and hence\nthe preceding argument applies here as well.\nFact 6.6 (i) The map \u03c8 admits a monotone extension toT; (ii) The map \u03c6 admits no monotone extension to\nS.\nProof. (i) Since x, x\u2032 \u2208 X , there exist extensions \u03b3x and \u03b3x\u2032 of \u03b3 from Y to Q that map y0 to x and x\u2032\nrespectively. Define an extension \u03b2 of \u03c8 by\n\u03b2(t) =\n{\n\u03b3x(y), if t = (y, z) with z < p,\n\u03b3x\u2032(y), if t = (y, z) with z \u2265 p.\nIt is easy to verify that this is a monotone extension of \u03c8.\n15\n(ii) Since x and x\u2032 are in distinct components of X and Cl is connected, clearly our claim will follow if\nwe can prove that any extension of \u03c6 must map every (y0, z) to X . And indeed, if \u03b2 is an extension of \u03c6\nthen its restriction to Y \u00d7 {z} is an extension of \u03b3, so we are done.\nCorollary 6.7 The poset T\u03c8 retracts ontoQ; the poset S\u03c6 does not retract ontoQ.\nProof. Follows from Facts 6.3, 6.5 and 6.6.\nWe require one last auxiliary result before prove the posets S\u03c6 andT\u03c8 are m-isomorphic. We show that\nthe blocks of the equivalence relation involved in the construction of the posets S\u03c6 and T\u03c8 have a simple\nstructure: the only blocks with more than one element are those that contain an element in the domain of \u03c6\n(\u03c8).\nLemma 6.8 Any element B of S\u03c6 (respectively T\u03c8) is of the following form: (i) B = {(y, z)} for some y\nwhich is not in the domain of \u03b3 and z \u0007\u2208 {0, p}, or (ii) B = {(y, z)} where z \u2208 {0, p} and y \u0007= y0 or (iii)\nB = {(y1, z1), . . . , (yn, zn), q} where {(y1, z1), . . . , (yn, zn)} = \u03c6\u22121(q) (respectively \u03c8\u22121(q)).\nProof. We consider only the case S\u03c6, the other is identical. Recall that the elements of S\u03c6 are the blocks\nof the equivalence defined by u \u223c v if u = v or \u03c6\u2032(u) = \u03c6\u2032(v). Suppose that \u03c6\u2032(u) = \u03c6\u2032(v) where u is\nin S; by definition of \u03c6\u2032 this means that there exist elements (y, z) \u2264 u \u2264 (y\u2032, z\u2032) and q \u2208 Q such that\n\u03c6((y, z)) = \u03c6((y\u2032, z\u2032)) = q. We have that y \u2264 y0 \u2264 y\u2032 and z \u2264 z\u2032. It follows easily from our claim on the\ntriple (Y, y0, \u03b3) that y = y\u2032 and z = z\u2032, and hence u is in the domain of \u03c6. The claim follows easily from\nthis fact.\nWe are now in a position to prove that the posets S\u03c6 and T\u03c8 are m-isomorphic. Let (Ij)j\u2264m be the\nsequence whose existence is guaranteed by Lemma 6.4: we proceed to construct a sequence (I\u02dcj)j\u2264m. Fix\n0 \u2264 j \u2264 m. For any f \u2208 Ij , define a partial map f\u02dc from S\u03c6 to T\u03c8 as follows: by Lemma 6.8, the elements\nof S\u03c6 are of two kinds: (a) if B contains no element in the domain of \u03c6, then B = {(y, z)} and we put\nf\u02dc(B) = [(y, f(z))] provided z is in the domain of f , otherwise we leave f\u02dc(B) undefined; (b) if B contains\nan element in the domain of \u03c6, then it contains a unique element q \u2208 Q and we define f\u02dc(B) = [q]. Finally,\ndefine I\u02dcj = {f\u02dc : f \u2208 Ij} for all 0 \u2264 j \u2264 m.\nLemma 6.9 The posets S\u03c6 and T\u03c8 are m-isomorphic via (I\u02dcj)j\u2264m; moreover every partial isomorphism in\nevery Ij of the sequence fixes every element of Q.\nProof. Fix some 0 \u2264 j \u2264 m and some f \u2208 Ij . It is clear that the function f\u02dc is well-defined and that it\nfixes all elements in Q, i.e. f\u02dc([q]) = [q] for all q \u2208 Q.\nClaim 1. Let B \u2208 S\u03c6. Then B \u2229Q \u0007= \u2205 if and only if f\u02dc(B) \u2229Q \u0007= \u2205.\nProof of Claim 1. One direction is obvious by definition of f\u02dc . Now suppose that f\u02dc(B) \u2229Q \u0007= \u2205 and let\n(y, z) \u2208 B. By Lemma 6.8 (y, f(z)) is in the domain of \u03c8, i.e. either y is in the domain of \u03b3, and hence\n(y, z) is in the domain of \u03c6, or else y = y0 and f(z) \u2208 {0, p}; by the properties of f we get that z \u2208 {0, p}\nwhich again shows that (y, z) is in the domain of \u03c6. In both cases, we conclude by definition of S\u03c6 that\nB \u2229Q \u0007= \u2205.\nClaim 2. The map f\u02dc is injective.\n16\nProof of Claim 2. Let f\u02dc(B) = f\u02dc(B\u2032). By Lemma 6.8 there are two cases: (i) if f\u02dc(B) = f\u02dc(B\u2032) intersects\nQ then by the last claim both B and B\u2032 intersect Q; if q \u2208 B \u2229Q and q\u2032 \u2208 B\u2032 \u2229Q then by definition of f\u02dc\nwe have that [q] = f\u02dc(B) = f\u02dc(B\u2032) = [q\u2032] and hence q = q\u2032 so B = B\u2032. (ii) if f\u02dc(B) = f\u02dc(B\u2032) do not intersect\nQ then we have by Claim 1 that B = {(y, z)} and B\u2032 = {(y\u2032, z\u2032)} for some y, y\u2032 \u2208 Y and z, z\u2032 \u2208 Cl. By\ndefinition of f\u02dc and the last claim we get that (y, f(z)) = (y\u2032, f(z\u2032)) and, since f is injective, we conclude\nthat (y, z) = (y\u2032, z\u2032) so we are done.\nClaim 3. The map f\u02dc is monotone.\nProof of Claim 3. Let B \u2264 B\u2032 in S\u03c6, i.e. let there be a sequence of blocks B = B1, . . . , Bn = B\u2032 and\nelements ui, vi \u2208 Bi such that\nu1 \u2264 v2 \u223c u2 \u2264 v3 \u00b7 \u00b7 \u00b7 vn\u22121 \u223c un\u22121 \u2264 vn.\nSuppose that the block Bi is not in the domain of f\u02dc . This implies that it cannot meet Q and hence by Lemma\n6.8 we have that\nui\u22121 \u2264 vi = ui \u2264 vi+1\nso that block Bi may actually be removed from the sequence. Hence it will suffice to prove that if B and B\u2032\nare such that there exist u \u2208 B and v \u2208 B\u2032 such that u \u2264 v then f\u02dc(B) \u2264 f\u02dc(B\u2032) in T\u03c8.\nThe result is obvious if both B and B\u2032 meet Q. Suppose now that neither meets Q: then B = {(y, z)}\nand B\u2032 = {(y\u2032, z\u2032)} where y \u2264 y0 \u2264 y\u2032 and z \u2264 z\u2032; thus f(z) \u2264 f(z\u2032) and the result follows easily.\nSuppose now that B = [q] and B\u2032 = {(y\u2032, z\u2032)}. Then (y, z) \u2264 (y\u2032, z\u2032) for some (y, z) in the domain of \u03c6.\nThis means that y \u2264 y0 \u2264 y\u2032 and z \u2264 z\u2032. If y is in the domain of \u03b3, then (y, f(z\u2032)) \u2264 (y\u2032, f(z\u2032)) in T\u03c6, and\n(y, f(z\u2032)) is in the domain of \u03c8; by definition of \u03c6 and \u03c8 we get that\n\u03c8((y, f(z\u2032)) = \u03b3(y) = \u03c6((y, z)) = q\nhence\nf\u02dc(B) = [q] = [(y, f(z\u2032))] \u2264 [(y\u2032, f(z\u2032))] = f\u02dc(B\u2032).\nOtherwise, we have that y = y0 and z \u2208 {0, p}; we suppose that z = 0 the other case being identical. By\nLemma 6.4 we have that 0 = f(0) \u2264 f(z\u2032) so (y, z) \u2264 (y\u2032, f(z\u2032)) and thus f\u02dc(B) \u2264 f\u02dc(B\u2032) in T\u03c8. The last\ncase, where B = {(y, z)} and B\u2032 = [q], is quite similar.\nClaim 4. The inverse of the map f\u02dc is monotone.\nProof of Claim 4. Suppose that f\u02dc(B) \u2264 f\u02dc(B\u2032) in T\u03c8, i.e. let there be a sequence of blocks f\u02dc(B) =\nB1, . . . , Bn = f\u02dc(B\u2032) and elements ui, vi \u2208 Bi such that\nu1 \u2264 v2 \u223c u2 \u2264 v3 \u00b7 \u00b7 \u00b7 vn\u22121 \u223c un\u22121 \u2264 vn.\nAs in Claim 3, it is easy to see that we may assume that every block Bi is in the image of f\u02dc ; and hence it will\nsuffice to prove the following assertion: if there exist elements u \u2208 f\u02dc(B) and v \u2208 f\u02dc(B\u2032) such that u \u2264 v then\nB \u2264 B\u2032 in S\u03c6. Suppose first that both blocks meet Q, say q \u2208 f\u02dc(B) and q\u2032 \u2208 f\u02dc(B\u2032) where q, q\u2032 \u2208 Q. Then\nof course q \u2264 q\u2032, and by Claim 1 and definition of f\u02dc we get that B = [q] \u2264 [q\u2032] = B\u2032. Secondly, suppose that\nneither block meets Q. Then f\u02dc(B) = {(y, f(z))} and f\u02dc(B\u2032) = {(y\u2032, f(z\u2032))} where (y, f(z)) \u2264 (y\u2032, f(z\u2032))\nin T. This means that y \u2264 y0 \u2264 y\u2032 in Y and f(z) \u2264 f(z\u2032) in Cp\n\u00b7\u222a Cp. Since f \u2208 Ij , we get that z \u2264 z\u2032\nand the rest follows easily. Thirdly suppose that f\u02dc(B) = [q] and f\u02dc(B\u2032) = {(y\u2032, f(z\u2032))}. Then there exists\nsome (y, w) in the domain of \u03c8 such that \u03c8((y, w)) = q and (y, w) \u2264 (y\u2032, f(z\u2032)) in T. This means that\ny \u2264 y0 \u2264 y\u2032 inY and w \u2264 f(z\u2032) in Cp\n\u00b7\u222a Cp. Suppose first that \u03b3(y) = q. But then (y, z\u2032) \u2264 (y\u2032, z\u2032) in S\nand, since \u03b3(y) = q, we obtain that\nB = [q] = [(y, z\u2032)] \u2264 [(y\u2032, z\u2032)] = B\u2032.\n17\nIf on the other hand y = y0 and w \u2208 {0, p}, we get that (assuming once again without loss of generality that\nw = 0) f(0) = 0 \u2264 f(z\u2032) and hence 0 \u2264 z\u2032; it follows that (y0, 0) \u2264 (y\u2032, z\u2032) in S and thus\nB = [q] = [(y0, 0)] \u2264 [(y\u2032, z\u2032)] = B\u2032.\nThe fourth case, where B\u02dc = {(y, z)} and B\u02dc\u2032 = [q] is similar.\nWe have now proved that the sets I\u02dcj consist only of partial isomorphisms. Finally, we prove:\nClaim 5. The sequence (I\u02dcj)j\u2264m has the \u2018back and forth\u2019 property.\nProof of Claim 5. Let j < m and let f\u02dc \u2208 Ij+1. Let B \u2208 S\u03c6 (the other case, B\u2032 \u2208 T\u03c8, is identical.) If\nB intersects Q then it is in the domain of f\u02dc and we are done (we may certainly suppose that the sequence\n(I\u02dcj)j\u2264m is decreasing.) So now assume that B does not meet Q, so B = {(y, z)} where (y, z) is not in the\ndomain of f\u02dc , which means that z is not in the domain of f . By the bach and forth property of the sequence\n(Ij)j\u2264m we may find g \u2208 Ij such that z is in its domain and g is an extension of f . But then it is clear that\n(y, z) is in the domain of g\u02dc \u2208 I\u02dcj and that g\u02dc is an extension of f\u02dc .\n7 Conclusion\nWe have completely characterised posets and reflexive graphs for which poset retraction and graph retrac-\ntion problems, respectively, are definable in first-order logic. We believe that this line of research can be\nsuccessfully continued by considering other logics and other classes of structures. The key to our results\nis Theorem 2.1 relating finiteness of obstructions and certain connectedness properties, which in the case\nof posets and reflexive graphs happens to be captured by NU polymorphisms. To make further progress in\nlooking for an algebraic desciption of homomorphism and retraction problems in FO, it seems necessary to\nobtain more information about how the two above properties are linked for more general structures. Results\nof [1, 29] may provide some insight into this.\nAcknowledgments\nWe are thankful to Christelle Vincent for helpful discussions. Victor Dalmau was partially supported by\nMCyT grants TIC2002-04470-C03 and TIC2002-04019-C03. Andrei Krokhin was partially supported by\nUK EPSRC grant GR\/R29598. Benoit Larose is partially funded by NSERC.\nReferences\n[1] A. Atserias. On digraph coloring problems and treewidth duality. In Proc. IEEE 20th Symp. on Logic\nin Computer Science, LICS\u201905, pages 106\u2013115, 2005.\n[2] M. Benke. Some complexity bounds for subtype inequalities. Theoretical Computer Science, 212:3\u2013\n27, 1999.\n[3] G. Bredon. Topology and Geometry. Springer-Verlag, third edition, 1995.\n[4] R. Brewster, T. Feder, P. Hell, J. Huang, and G. MacGillavray. Near-unanimity functions and varieties\nof graphs. submitted, 2004.\n18\n[5] A. Bulatov. Tractable conservative constraint satisfaction problems. In Proc. 18th IEEE Symp. on\nLogic in Computer Science, LICS\u201903, pages 321\u2013330, 2003.\n[6] A. Chandra and P. Merlin. Optimal implementation of conjunctive queries in relational databases. In\nProc. 9th ACM Symp. on Theory of Computing, STOC\u201977, pages 77\u201390, 1977.\n[7] N. Creignou, S. Khanna, and M. Sudan. Complexity Classifications of Boolean Constraint Satisfaction\nProblems, volume 7 of SIAM Monographs on Discrete Mathematics and Applications. 2001.\n[8] V. Dalmau. Linear Datalog and bounded path duality of relational structures Logical Methods in\nComputer Science (electronic), 1, 2005.\n[9] V. Dalmau, Ph. Kolaitis, and M. Vardi. Constraint satisfaction, bounded treewidth, and finite-variable\nlogics. In Proc. 8th Int. Conf. on Constraint Programming, CP\u201902, volume 2470 of LNCS, pages\n310\u2013326, 2002.\n[10] J. Demetrovics, L. Hanna\u00b4k, and L. Ro\u00b4nyai. Near-unanimity functions of partial orders. In Proc. 14th\nInt. Symp. on Multiple-Valued Logic, ISMVL\u201984, pages 52\u201356, 1984.\n[11] D. Duffus and I. Rival. A structure theory for ordered sets. Discrete Mathematics, 35:53\u2013118, 1981.\n[12] H.-D. Ebbinghaus and J. Flum. Finite Model Theory. Springer-Verlag, 1999.\n[13] T. Feder and P. Hell. List homomorphisms to reflexive graphs. Journal of Combinatorial Theory, Ser.B,\n72:236\u2013250, 1998.\n[14] T. Feder and M. Vardi. The computational structure of monotone monadic SNP and constraint satis-\nfaction: A study through Datalog and group theory. SIAM Journal on Computing, 28:57\u2013104, 1998.\n[15] T. Feder and M. Vardi. Homomorphism closed vs. existential positive. In Proc. 18th IEEE Symp. on\nLogic in Computer Science, LICS\u201903, pages 311\u2013320, 2003.\n[16] P. Hell. Algorithmic aspects of graph homomorphisms. In C. Wensley, editor, Surveys in Combina-\ntorics 2003, volume 307 of LMS Lecture Note Series, pages 239 \u2013 276. Cambridge University Press,\n2003.\n[17] P. Hell and J. Nes\u02c7etr\u02c7il. Graphs and Homomorphisms. Oxford University Press, 2004.\n[18] M. Jawhari, D. Misane, and M. Pouzet. Retracts: graphs and ordered sets from metric point of view.\nContemporary Mathematics, 57:175\u2013226, 1986.\n[19] P. Jeavons, D. Cohen, and M. Cooper. Constraints, consistency and closure. Artificial Intelligence,\n101(1-2):251\u2013265, 1998.\n[20] Ph. Kolaitis. On the expressive power of logics on finite models. In Finite Model Theory and its\nApplications, EATCS Series: Texts in Theoretical Computer Science. Springer, 2005. to appear.\n[21] Ph. Kolaitis and M. Vardi. On the expressive power of Datalog: tools and a case study. Journal of\nComputer and System Sciences, 51:110\u2013134, 1995.\n[22] Ph. Kolaitis and M. Vardi. Conjunctive-query containment and constraint satisfaction. Journal of\nComputer and System Sciences, 61:302\u2013332, 2000.\n[23] A. Krokhin and B. Larose. Solving order constraints in logarithmic space. In Proc. 20th Int. Symp. on\nTheoretical Aspects of Computer Science, STACS\u201903, volume 2607 of LNCS, pages 379\u2013390, 2003.\n19\n[24] G. Kun and C. Szabo\u00b4. Order varieties and monotone retractions of finite posets. Order, 18:79\u201388,\n2001.\n[25] B. Larose, C. Loten, and L. Za\u00b4dori. A polynomial-time algorithm to recognise near-unanimity graphs.\nJ. Algorithms, 55:177\u2013191, 2005.\n[26] B. Larose and L. Za\u00b4dori. Algebraic properties and dismantlability of finite posets. Discrete Mathemat-\nics, 163:89\u201399, 1997.\n[27] B. Larose and L. Za\u00b4dori. The complexity of the extendibility problem for finite posets. SIAM Journal\non Discrete Mathematics, 17(1):114\u2013121, 2003.\n[28] P. Lincoln and J. Mitchell. Algorithmic aspects of type interference with subtypes. In Proc. 19th ACM\nSymp. on Principles of Programming Languages, POPL\u201992, pages 293\u2013304, 1992.\n[29] J. Nes\u02c7etr\u02c7il and C. Tardif. Duality theorems for finite structures (characterising gaps and good charac-\nterisations). Journal of Combininatorial Theory, Ser.B, 80:80\u201397, 2000.\n[30] R. Po\u00a8schel and L. Kaluz\u02c7nin. Funktionen- und Relationenalgebren. DVW, Berlin, 1979.\n[31] V. Pratt and J. Tiuryn. Satisfiabilty of inequalities in a poset. Fundamenta Informaticae, 28:165\u2013182,\n1996.\n[32] B. Rossman. Existential positive types and preservation under homomorphisisms. In Proc. IEEE 20th\nSymp. on Logic in Computer Science, LICS\u201905, pages 467\u2013476, 2005.\n[33] N. Vikas. Compaction, retraction, and constraint satisfaction. SIAM Journal on Computing, 33:761\u2013\n782, 2004.\n[34] L. Za\u00b4dori. Relational sets and categorical equivalence of algebras. Int. Journal of Algebra and Com-\nputation, 7:561\u2013576, 1997.\n20\n"}