{"doi":"10.1137\/050634840","coreId":"65940","oai":"oai:dro.dur.ac.uk.OAI2:3987","identifiers":["oai:dro.dur.ac.uk.OAI2:3987","10.1137\/050634840"],"title":"Constraint satisfaction, logic and forbidden patterns.","authors":["Madelaine, F. R.","Stewart, I. A."],"enrichments":{"references":[],"documentType":{"type":1}},"contributors":[],"datePublished":"2007-04-01","abstract":"In the early nineties, Feder and Vardi attempted to find a large sub-class of NP which exhibits a dichotomy; that is,\\ud\nwhere every problem in the sub-class is either solvable in polynomial-time or NP-complete. Their studies resulted in a\\ud\ncandidate class of problems, namely those definable in the logic MMSNP. Whilst it remains open as to whether MMSNP exhibits a dichotomy, for various reasons it remains a strong\\ud\ncandidate. Feder and Vardi added to the significance of MMSNP by proving that although MMSNP strictly contains \\ud\nCSP, the class of constraint satisfaction problems, MMSNP and CSP are computationally equivalent. We introduce here a new class of combinatorial problems, the class of forbidden patterns problems FPP, and characterize MMSNP as the finite unions of problems from FPP. We use our characterization to detail exactly those problems that are in MMSNP but not in CSP. Furthermore, given a problem in MMSNP, we are able to decide whether the problem is in CSP\\ud\nor not (this whole process is effective). If the problem is in CSP then we can construct a template for this problem, otherwise for any given candidate for the role of template, we can build a counter-example (again, this process is effective)","downloadUrl":"https:\/\/core.ac.uk\/download\/pdf\/65940.pdf","fullTextIdentifier":"http:\/\/dro.dur.ac.uk\/3987\/1\/3987.pdf","pdfHashValue":"a778de3e69d0e9d6b6ce3d280300a12fcb4a5612","publisher":"Society for Industrial and Applied Mathematics","rawRecordXml":"<record><header><identifier>\n  \n    \n      oai:dro.dur.ac.uk.OAI2:3987<\/identifier><datestamp>\n      2011-09-01T10:51:16Z<\/datestamp><\/header><metadata><oai_dc:dc xmlns:oai_dc=\"http:\/\/www.openarchives.org\/OAI\/2.0\/oai_dc\/\" xmlns:dc=\"http:\/\/purl.org\/dc\/elements\/1.1\/\" xmlns:xsi=\"http:\/\/www.w3.org\/2001\/XMLSchema-instance\" xsi:schemaLocation=\"http:\/\/www.openarchives.org\/OAI\/2.0\/oai_dc\/ http:\/\/www.openarchives.org\/OAI\/2.0\/oai_dc.xsd\" ><dc:title>\n    \n      \n        Constraint satisfaction, logic and forbidden patterns.<\/dc:title><dc:creator>\n        Madelaine, F. R.<\/dc:creator><dc:creator>\n        Stewart, I. A.<\/dc:creator><dc:description>\n        In the early nineties, Feder and Vardi attempted to find a large sub-class of NP which exhibits a dichotomy; that is,\\ud\nwhere every problem in the sub-class is either solvable in polynomial-time or NP-complete. Their studies resulted in a\\ud\ncandidate class of problems, namely those definable in the logic MMSNP. Whilst it remains open as to whether MMSNP exhibits a dichotomy, for various reasons it remains a strong\\ud\ncandidate. Feder and Vardi added to the significance of MMSNP by proving that although MMSNP strictly contains \\ud\nCSP, the class of constraint satisfaction problems, MMSNP and CSP are computationally equivalent. We introduce here a new class of combinatorial problems, the class of forbidden patterns problems FPP, and characterize MMSNP as the finite unions of problems from FPP. We use our characterization to detail exactly those problems that are in MMSNP but not in CSP. Furthermore, given a problem in MMSNP, we are able to decide whether the problem is in CSP\\ud\nor not (this whole process is effective). If the problem is in CSP then we can construct a template for this problem, otherwise for any given candidate for the role of template, we can build a counter-example (again, this process is effective).<\/dc:description><dc:subject>\n        Finite model theory<\/dc:subject><dc:subject>\n         Constraint satisfaction<\/dc:subject><dc:subject>\n         Existential monadic second-order logic.<\/dc:subject><dc:publisher>\n        Society for Industrial and Applied Mathematics<\/dc:publisher><dc:source>\n        SIAM journal of computing, 2007, Vol.37(1), pp.132-163 [Peer Reviewed Journal]<\/dc:source><dc:date>\n        2007-04-01<\/dc:date><dc:type>\n        Article<\/dc:type><dc:type>\n        PeerReviewed<\/dc:type><dc:identifier>\n        dro:3987<\/dc:identifier><dc:identifier>\n        issn:0097-5397<\/dc:identifier><dc:identifier>\n        issn: 1095-7111<\/dc:identifier><dc:identifier>\n        doi:10.1137\/050634840<\/dc:identifier><dc:identifier>\n        http:\/\/dro.dur.ac.uk\/3987\/<\/dc:identifier><dc:identifier>\n        http:\/\/dx.doi.org\/10.1137\/050634840<\/dc:identifier><dc:format>\n        application\/pdf<\/dc:format><dc:identifier>\n        http:\/\/dro.dur.ac.uk\/3987\/1\/3987.pdf<\/dc:identifier><dc:rights>\n        \u00a9 Society for Industrial and Applied Mathematics \\ud\n<\/dc:rights><dc:accessRights>\n        info:en-repo\/semantics\/openAccess<\/dc:accessRights><\/oai_dc:dc><\/metadata><\/record>","journals":[{"title":null,"identifiers":["issn:0097-5397","0097-5397","issn: 1095-7111"," 1095-7111"]}],"language":{"code":"en","id":9,"name":"English"},"relations":[],"year":2007,"topics":["Finite model theory","Constraint satisfaction","Existential monadic second-order logic."],"subject":["Article","PeerReviewed"],"fullText":"Durham Research Online\nDeposited in DRO:\n07 October 2008\nVersion of attached file:\nPublished Version\nPeer-review status of attached file:\nPeer-reviewed\nCitation for published item:\nMadelaine, F. R. and Stewart, I. A. (2007) \u2019Constraint satisfaction, logic and forbidden patterns.\u2019, SIAM\njournal of computing., 37 (1). pp. 132-163.\nFurther information on publisher\u2019s website:\nhttp:\/\/dx.doi.org\/10.1137\/050634840\nPublisher\u2019s copyright statement:\nSociety for Industrial and Applied Mathematics\nAdditional information:\nUse policy\nThe full-text may be used and\/or reproduced, and given to third parties in any format or medium, without prior permission or charge, for\npersonal research or study, educational, or not-for-profit purposes provided that:\n\u2022 a full bibliographic reference is made to the original source\n\u2022 a link is made to the metadata record in DRO\n\u2022 the full-text is not changed in any way\nThe full-text must not be sold in any format or medium without the formal permission of the copyright holders.\nPlease consult the full DRO policy for further details.\nDurham University Library, Stockton Road, Durham DH1 3LY, United Kingdom\nTel : +44 (0)191 334 3042 \u2014 Fax : +44 (0)191 334 2971\nhttp:\/\/dro.dur.ac.uk\n Use policy \n \nThe full-text may be used and\/or reproduced, and given to third parties in any format or medium, without \nprior permission or charge, for personal research or study, educational, or not-for-profit purposes \nprovided that : \n \n\u0083 a full bibliographic reference is made to the original source \n\u0083 a link is made to the metadata record in DRO \n\u0083 the full-text is not changed in any way \n \nThe full-text must not be sold in any format or medium without the formal permission of the copyright \nholders.  \n \nPlease consult the full DRO policy for further details. \n \nDurham University Library, Stockton Road, Durham DH1 3LY, United Kingdom \nTel : +44 (0)191 334 2975 | Fax : +44 (0)191 334 2971 \nhttp:\/\/dro.dur.ac.uk \nDurham Research Online \n Deposited in DRO:\n07 October 2008\nVersion of attached file:\nPublished\nPeer-review status of attached file:\nPeer-reviewed\nCitation for published item:\nMadelaine, F. R. and Stewart, I. A. (2007) 'Constraint satisfaction, logic and forbidden patterns.', SIAM journal\nof computing., 37 (1), pp.\u0000132-163.\nFurther information on publishers website:\nhttp:\/\/dx.doi.org\/10.1137\/050634840\nPublishers copyright statement:\n\u00a9 Society for Industrial and Applied Mathematics \u0000\u0000\nSIAM J. COMPUT. c\u00a9 2007 Society for Industrial and Applied Mathematics\nVol. 37, No. 1, pp. 132\u2013163\nCONSTRAINT SATISFACTION, LOGIC AND FORBIDDEN\nPATTERNS\u2217\nFLORENT MADELAINE\u2020 AND IAIN A. STEWART\u2020\nThis paper is dedicated to the memory of our friend and colleague Clemens Lautemann\nAbstract. In the 1990s, Feder and Vardi attempted to find a large subclass of NP which exhibits\na dichotomy, that is, where every problem in the subclass is either solvable in polynomial-time or NP-\ncomplete. Their studies resulted in a candidate class of problems, namely, those definable in the logic\nMMSNP. While it remains open as to whether MMSNP exhibits a dichotomy, for various reasons it\nremains a strong candidate. Feder and Vardi added to the significance of MMSNP by proving that,\nalthough MMSNP strictly contains CSP, the class of constraint satisfaction problems, MMSNP and\nCSP are computationally equivalent. We introduce here a new class of combinatorial problems, the\nclass of forbidden patterns problems FPP, and characterize MMSNP as the finite unions of problems\nfrom FPP. We use our characterization to detail exactly those problems that are in MMSNP but\nnot in CSP. Furthermore, given a problem in MMSNP, we are able to decide whether the problem\nis in CSP or not (this whole process is effective). If the problem is in CSP, then we can construct a\ntemplate for this problem; otherwise, for any given candidate for the role of template, we can build\na counterexample (again, this process is effective).\nKey words. finite model theory, constraint satisfaction, existential monadic second-order logic\nAMS subject classifications. 68Q19, 68Q15, 0v3C13\nDOI. 10.1137\/050634840\n1. Introduction. Descriptive complexity theory seeks to classify problems, i.e.,\nclasses of finite structures, as to whether they can be defined using formulae of some\nspecific logic, in relation to their computational complexity. One of the seminal results\nin descriptive complexity is Fagin\u2019s theorem [10], which states that a problem can be\ndefined in existential second-order logic if and only if it is in the complexity class NP\n(throughout we equate a logic with the class of problems definable by the sentences\nof that logic). In a relatively recent paper and based upon Fagin\u2019s characterization\nof NP, Feder and Vardi [15] attempted to find a large (syntactically defined) subclass\nof NP which exhibits a dichotomy, that is, where every problem in the subclass is\neither solvable in polynomial-time or NP-complete (recall Ladner\u2019s theorem [22, 26],\nwhich states that if P \u0002= NP, then there is an infinite number of distinct polynomial-\ntime equivalence classes in NP). What emerged from Feder and Vardi\u2019s consideration\nwas a (candidate) class of problems called MMSNP, defined by imposing syntactic\nrestrictions upon the existential fragment of second-order logic. Their focus on a\nfragment of existential second-order logic was so that they might apply tools and\ntechniques of finite model theory to possibly obtain a dichotomy result.\nThe logic MMSNP is defined by insisting that formulae of the fragment SNP of\nexistential second-order logic must in addition be monotone, be monadic, and not\ninvolve inequalities (full definitions follow later). Feder and Vardi considered the im-\nposition of combinations of these three restrictions (monadic, monotone, and without\n\u2217Received by the editors June 30, 2005; accepted for publication (in revised form) December 27,\n2006; published electronically April 10, 2007.\nhttp:\/\/www.siam.org\/journals\/sicomp\/37-1\/63484.html\n\u2020Department of Computer Science, University of Durham, Science Labs, South Road, Durham\nDH1 3LE, UK (f.r.madelaine@durham.ac.uk, i.a.stewart@durham.ac.uk). Much of this work was\nundertaken while the first author was at the Universite\u00b4 de la Re\u00b4union.\n132\nCONSTRAINTS, LOGIC AND FORBIDDEN PATTERNS 133\ninequalities) and showed that under any combination, excepting the imposition of all\nthree restrictions, the resulting logic does not have a dichotomy (assuming P \u0002= NP).\nThey were unable to make any similar claim about the logic obtained by imposing\nall three restrictions. However, they proved that MMSNP properly contains CSP,\nthe class of combinatorial problems known as constraint satisfaction problems and,\nfurther, that the two classes are closely related in a computational sense.\nTheorem 1 (Feder and Vardi [15]). Every problem in CSP is definable by a\nsentence of MMSNP, and every problem definable by a sentence of MMSNP is com-\nputationally equivalent to a problem in CSP.\n(By \u201ccomputationally equivalent\u201d above we mean that the MMSNP problem can\nbe reduced to the CSP problem by a randomized polynomial-time Turing reduction,\nand the CSP problem can be reduced to the MMSNP problem by a polynomial-time\nKarp reduction.)1\nThe class CSP of constraint satisfaction problems is of great importance in com-\nputer science and artificial intelligence and has strong ties with database theory, graph\ntheory, and universal algebra (see, for instance, [7, 30, 18, 20, 21]). For example, it\nis well-known that constraint satisfaction problems can be modeled in terms of the\nexistence of homomorphisms between structures [21], in that every constraint sat-\nisfaction problem can be realized as the class of structures for which there exists\na homomorphism to some fixed template structure. The close relationship between\nCSP and MMSNP prompted Feder and Vardi [15] to make explicit their conjecture\nthat every problem in CSP is either NP-complete or solvable in polynomial-time.\nThere are numerous results supporting this conjecture. For example, Schaefer [30]\nproved that if the template structure corresponding to some constraint satisfaction\nproblem has size 2, then the conjecture holds, with Bulatov [3] recently extending\nSchaefer\u2019s result to templates of size 3. Also, Hell and Nes\u02c7etr\u02c7il [18] proved that the\nconjecture holds for all constraint satisfaction problems involving undirected graphs.\nVarious other related dichotomy results have recently been determined; see, for ex-\nample, [4, 5, 6, 8, 9, 11, 12, 13, 14, 15, 27, 28].\nIt is with the \u201cborder\u201d between CSP and MMSNP that we are concerned in\nthis paper. Feder and Vardi exhibited specific problems in MMSNP that are not\nin CSP, with their proofs relying essentially on counting arguments (they did not\nexamine in any detail the inclusion relationship between CSP and MMSNP as classes\nof problems). We gave more examples of such problems in [25] although our proofs\nwere of a different nature; they involved the explicit construction of particular families\nof graphs. We attempt in this paper to generalize the constructions in [25] so that we\nmight develop a method by which we can ascertain whether any problem definable in\nMMSNP is in CSP or not. To this end, we give a new combinatorial characterization\nof MMSNP as the class of finite unions of forbidden patterns problems (from the\nclass FPP). We use our new combinatorial characterization to answer the following\nquestions in the affirmative: \u201cCan we characterize exactly those problems that are in\nMMSNP but not in CSP?\u201d; \u201cgiven a problem in MMSNP, is it decidable whether it\nis in CSP or not?\u201d; and \u201cif a problem in MMSNP can be shown to be in CSP then\ncan we construct a template witnessing its inclusion in CSP?\u201d\nAs we shall see, forbidden patterns problems are given by representations that\ninvolve a finite set of colored structures, and we introduce the key notion of a recoloring\nbetween representations. The notions of a representation and a recoloring somehow\ngeneralize the notion of a structure and a homomorphism. The concept of a recoloring,\n1Ga\u00b4bor Kun has recently derandomized this computational equivalence.\n134 FLORENT MADELAINE AND IAIN A. STEWART\ntogether with two notions that were implicitly present in the proof of Theorem 1 (the\nnotion of a template of a representation and of a Feder\u2013Vardi transformation), allow\nus to derive for any forbidden patterns problem a normal representation. Given\nany normal representation, we are then able to decide (according to simple criteria)\nwhether the corresponding problem is in CSP or not. If it is in CSP, then we show how\nto construct its template; if it is not, then we show how to construct a counterexample\nto any potential template. Finally, we extend these results about problems in FPP\nto answer the questions (about MMSNP) above.\nWe end this section with a brief word about MMSNP and our research direction.\nThe logic MMSNP has recently been shown to be related to constraint satisfaction\nproblems where the template is infinite. In particular, Bodirsky and Dalmau [2] have\nshown that any problem in MMSNP that is nontrivial and closed under disjoint unions\ncan be realized as a constraint satisfaction problem with an \u03c9-categorial template. As\nregards our interest in the differences between MMSNP and CSP, there are numerous\ndecidability investigations into the relative expressibilities of different logics in the\nliterature, and we highlight a selection of these investigations here. In [1], Benedikt\nand Segoufin extend the well-known result that on strings, it is decidable whether a\nmonadic second-order problem (that is, a regular language) is definable in first-order\nlogic, to trees. In [16], Gaifman et al. show that the problem of deciding whether\na given Datalog program is equivalent to one without recursion (and therefore to a\nformula of existential positive first-order logic) is undecidable. Finally, one very recent\n(and pertinent) result is that the problem of deciding whether a constraint satisfaction\nproblem is first-order definable is decidable; indeed, it is NP-complete [23]. It turns\nout that first-order definable constraint satisfaction problems are forbidden patterns\nproblems with a single color (logically, they correspond to the first-order fragment of\nMMSNP). The dual question (that asks, given such a forbidden patterns problem,\nwhether it is a constraint satisfaction problem or not) is directly related to a popular\nnotion in structural combinatorics, namely, that of a duality pair. Duality pairs have\nbeen characterized by Tardif and Nes\u02c7etr\u02c7il [31].\nThis paper is organized as follows. In the next section, we formally define CSP\nand FPP. In section 3, we recall the definition of Feder and Vardi\u2019s logic MMSNP and\nshow how it relates to the class of problems FPP. In section 4, we introduce normal\nrepresentations and related notions. In section 5, we prove our main result, i.e., an\nexact characterization of problems in FPP as to whether they are in CSP or not,\nprovided that they can be given by connected representations. Next, in section 6,\nwe extend this result to the disconnected case (this requires us to generalize normal\nrepresentations to what we call normal sets) and then extend our results from FPP\nto MMSNP. Finally, in section 7, we conclude with some closing remarks.\n2. Preliminaries. In this section, we give precise definitions of many of the\nconcepts involved in this paper. We define many well-known notions in a slightly\nnonstandard way as many of these notions are extended very soon to analogous ones\nfor colored structures.\nStructures. A signature is a finite set of relation symbols (with each relation\nsymbol having some finite arity). Let \u03c3 denote some fixed signature. A \u03c3-structure A\nconsists of a nonempty set A, the domain, together with an interpretation RA \u2286 Am,\nfor every m-ary relation symbol R in \u03c3. Throughout this paper, we only ever consider\nfinite \u03c3-structures. Hence, in the following we simply write \u201ca structure\u201d instead of\n\u201ca finite \u03c3-structure.\u201d We denote structures by A,B, C, etc., and their respective\ndomains by A,B,C, etc., or alternatively by |A|, |B|, |C|, etc.\nCONSTRAINTS, LOGIC AND FORBIDDEN PATTERNS 135\nLet A be a structure. We denote tuples of elements by s, t, etc., and we write\n\u201clet t in A\u201d as an abbreviation for \u201clet t be a tuple of elements of A.\u201d Let R be\na relation symbol in \u03c3. We feel free to specify only when it is relevant the precise\nlength of a tuple, and when we write \u201cRA(t)\u201d this automatically implies that the\ntuple of elements t has the same length as the arity of the relation symbol R. We\nwrite \u201ca tuple RA(t)\u201d as an abbreviation for \u201ca tuple of elements t in A such that\nRA(t) holds.\u201d We always use R to refer to a relation symbol of \u03c3 unless otherwise\nstated.\nLet A and B be two structures. A homomorphism from A to B is a mapping\nh : A\u2192 B such that for any relation symbol R in \u03c3 and for any tuple RA(t), we have\nthat RB(h(t)), where h(t) denotes the tuple obtained from t by a componentwise\napplication of h. To denote that h is a homomorphism from A to B, we write A\nh\n\u2192B.\nIf, furthermore, h is onto (respectively, one-to-one), then h is an epimorphism (respec-\ntively, a monomorphism), and we write A\nh\n\u0589B (respectively, A\nh\n\u2192\u0592B). If both A\nh\n\u0589B\nand A\nh\n\u2192\u0592B, then we write A\nh\n\u2192\u0592B. If A\nh\n\u2192\u0592B and A\nh\u22121\n\u2192B, then h is an isomorphism, and\nwe write A \u2248 B. If there exists a homomorphism (respectively, a monomorphism) of\nA to B, then we write A\u2192B (respectively, A\u2192\u0592B). When something does not hold,\nwe use the same notation but place a \/ through the symbol. For example, we write\nA\u0003 B if it is not the case that A\u2192B.\nIfA\nh\n\u2192\u0592B, thenA is a substructure of B, and if, furthermore, for any tupleRB(h(t)),\nwe have that RA(t) holds, then A is an induced substructure of B. If A\nh\n\u0589B and every\ntuple RB(t\u2032) is in the image of h (more formally, there exists a tuple t in A such that\nh(t) = t\u2032 and RA(t) holds), then B is an homomorphic image of A. If A\nh\n\u2192B, then\nthe homomorphic image of A under h, which we denote by h(A), is the substructure\nof B that consists only of those tuples RB(t\u2032) that are in the image of h.\nA retract of a structure B is a structure A for which there are two homomorphisms\nA\ni\n\u2192\u0592B and B\ns\n\u0589A such that s\u25e6i = idA (where idA denotes the identity homomorphism\non A, so, in particular, if A is a retract of B, then A is isomorphic to an induced\nsubstructure of B). Moreover, A is a proper retract whenever A \u0002\u2248 B. If B does not\nhave any proper retracts, then B is automorphic (we use the terminology of [17]). An\nautomorphic retract of B is called a core. It is well known that a core is unique up to\nisomorphism (see [17] or [19]).\nLet A be a structure, let s and t be in A, and let n \u2265 1. A path of length n in A\njoining s and t consists of n tuples RA1 (t1), R\nA\n2 (t2), . . . , R\nA\nn (tn) such that each Ri is a\nrelation symbol in \u03c3 of arity at least two (these relation symbols need not be distinct\nnor need the tuples), s occurs in t1, t occurs in tn, and for every 1 \u2264 i < n, the tuples\nof elements ti and ti+1 have a common element. If a path joins two distinct elements\ns and t, then they are connected . A structure A is connected if and only if any two\ndistinct elements are connected.\nLet B and C be two substructures of A and let x \u2208 A. If\n\u2022 B \u2229 C = {x};\n\u2022 B \u222a C = A;\n\u2022 for every relation symbol R of \u03c3 that has arity at least two and for every\ntuple RA(t), either RB(t) or RC(t) holds but not both;\n\u2022 for every monadic symbol M and for every element y in B (respectively, C),\nM(y) holds in B (respectively, C) if and only if M(y) holds in A; and\n\u2022 each substructure B and C has at least one tuple R(t) (where R has arity at\nleast two),\nthen we say that A admits a decomposition with components B and C in the articu-\n136 FLORENT MADELAINE AND IAIN A. STEWART\nlation point x, and we write A = B\nx\n32 C. If A is connected and does not admit any\ndecomposition, then A is biconnected .\nLet A be a structure. A tuple RA(t) is said to be antireflexive if and only if no\nelement in t occurs more than once. A cycle of size 1 in A consists of one tuple RA(t)\nthat is not antireflexive. An element that occurs more than once in a cycle of size\n1 is called an articulation point of the cycle. A cycle of size 2 in A consists of two\nantireflexive tuples RA1 (t1) and R\nA\n2 (t2), for which we have that if R1 = R2, then t1\nand t2 differ and which have at least two distinct common elements, each of which is\ncalled an articulation point of the cycle. Let n > 2. A cycle of size n in A consists of\nn tuples RA1 (t1), R\nA\n2 (t2), . . . , R\nA\nn (tn) such that:\n\u2022 for every 1 \u2264 i \u2264 n, the tuple RAi (ti) is antireflexive;\n\u2022 for every 1 \u2264 i < j \u2264 n, if j = i + 1 or (i = 1 and j = n), the tuples ti and\ntj have one, and only one, common element ai,j ; otherwise, they have none;\nand\n\u2022 the elements ai,j , each of which is called an articulation point of the cycle,\nare pairwise distinct.\nColored structures. Let T be a structure. A T -colored structure is a pair (A, a),\nwhere A is a structure and A\na\n\u2192T . We call: T the target of (A, a); a the coloring ;\nand A the underlying structure. Let (A, a) and (B, b) be two T -colored structures.\nA T -colored homomorphism of (A, a) to (B, b) is a homomorphism A\nh\n\u2192B such that\na = b \u25e6 h. All notions defined above extend to T -colored structures, so that colorings\nare respected by morphisms. For example, a retract of a T -colored structure (B, b) is\na T -colored structure (A, a) for which there are two homomorphisms A\ni\n\u2192\u0592B and B\ns\n\u0589A\nsuch that s \u25e6 i = idA, b \u25e6 i = a and a \u25e6 s = b. We use the same terminology but add\nthe prefix \u201cT -colored,\u201d e.g., as in \u201cT -colored retract,\u201d and we use the same notation,\ne.g., (A, a)\nh\n\u2192(B, b) for a T -colored homomorphism from (A, a) to (B, b). However, for\nsimplicity, we may drop the prefix T -colored when it does not cause confusion. At\ntimes, we deal with different targets, and so to avoid confusion, we sometimes write\nthe target as a superscript, e.g., as in (A, aT ). We often refer to the elements of\n|T | = T as colors. We shall use the following lemmas later on, but we include them\nhere so that readers can familiarize themselves with colored structures.\nLemma 2. Let (A, aT ) be a T -colored structure, let T \u2032 be a structure such that\nT \u2032\ne\n\u2192\u0592T , and let (A, aT\n\u2032\n) be a T \u2032-colored structure, where aT = e \u25e6 aT\n\u2032\n. If (A, aT ) is\nautomorphic, then (A, aT\n\u2032\n) is automorphic.\nProof. Suppose that (A, aT ) is automorphic, and suppose that (B, bT\n\u2032\n) is a proper\nretract of (A, aT\n\u2032\n). That is, we have that (B, bT\n\u2032\n)\ni\n\u2192\u0592(A, aT\n\u2032\n) and (A, aT\n\u2032\n)\ns\n\u0589(B, bT\n\u2032\n),\nwhere s \u25e6 i = idB, a\nT \u2032 \u25e6 i = bT\n\u2032\n, and bT\n\u2032\n\u25e6 s = aT\n\u2032\n(cf. the left commutative dia-\ngram of Figure 1) so that (A, aT\n\u2032\n) \u0002\u2248 (B, bT\n\u2032\n). We can compose the two T \u2032-colorings\nB\nA T '\nB\nT 'b\nT 'b\nT 'a\ni\ns\nidB\nB\nA T\nB\ni\ns\nidB\nTb   = e o b T\n'\nTb   = e o b T\n'\nTa   = e o a T\n'\nFig. 1. Proof of Lemma 2.\nCONSTRAINTS, LOGIC AND FORBIDDEN PATTERNS 137\nwith e to yield T -colored structures, i.e., let aT := e \u25e6 aT\n\u2032\nand bT := e \u25e6 bT\n\u2032\n(cf.\nthe right commutative diagram of Figure 1). Thus, (B, bT ) is a retract of (A, aT ),\nand so is isomorphic to (A, aT ). Thus, i is an isomorphism, with inverse s. Conse-\nquently, (A, aT\n\u2032\n) \u2248 (B, bT\n\u2032\n). But (B, bT\n\u2032\n) is a proper retract of (A, aT\n\u2032\n) which yields\na contradiction. The result follows.\nThe proofs of the next two lemmas are almost identical to analogous proofs in\n[19], for example, but are included here to allow readers to familiarize themselves with\ncolored structures.\nLemma 3. The T -colored structure (A, aT ) is automorphic if and only if whenever\n(A, aT )\nf\n\u2192(A, aT ), we have that f(A, aT ) \u2248 (A, aT ).\nProof. Assume that (A, aT ) is automorphic and also that (A, aT )\nf\n\u2192(A, aT ). From\nall such homomorphisms, choose g such that g(A, aT ) has a minimal number of ele-\nments and from those structures also a minimal number of tuples. Define h to be g\nrestricted to g(A, aT ).\nNote that g(A, aT )\nh\n\u2192g(A, aT ), and so h is one-to-one and onto, as otherwise\n(A, aT )\nh\u25e6g\n\u2192 (A, aT ) contradicts the minimality of g. So, h is an isomorphism. Thus,\n(A, aT )\nh\u22121\u25e6g\n\u0589 g(A, aT ) and g(A, aT )\ni\n\u2192\u0592(A, aT ), where i is the identity on g(A, aT ). For\nany x \u2208 |g(A, aT )|, h\u22121 \u25e6 g \u25e6 i(x) = h\u22121 \u25e6 g(x) = h\u22121 \u25e6 h(x) = x. Hence, g(A, aT ) is a\nretract of (A, aT ), and so g(A, aT ) \u2248 (A, aT ). Consequently, f(A, aT ) \u2248 (A, aT ) by\nminimality of g.\nConversely, assume that whenever (A, aT )\nf\n\u2192(A, aT ), we have f(A, aT ) \u2248 (A, aT ).\nSuppose that (B, bT )\ni\n\u2192\u0592(A, aT ) and (A, aT )\ns\n\u0589(B, bT ), with s \u25e6 i = idB. Define f :=\ni \u25e6 s. Thus, f(A, aT ) \u2248 (A, aT ), with i an epimorphism and s a monomorphism.\nConsequently, (B, bT ) \u2248 (A, aT ), and (A, aT ) is automorphic.\nLemma 4. Every T -colored structure has a T -colored core that is unique up to\nT -colored isomorphism.\nProof. Trivially, every T -colored structure has a T -colored core. Suppose that\n(A1, a1) and (A2, a2) are cores of (B, b) such that (A1, a1) \u0002\u2248 (A2, a2). In particular:\n\u2022 (A1, a1)\ni1\n\u2192\u0592(B, b) and (B, b)\ns1\n\u0589(A1, a1) such that s1 \u25e6 i1 = idA1 , b \u25e6 i1 = a1, and\ns1 \u25e6 a1 = b; and\n\u2022 (A2, a2)\ni2\n\u2192\u0592(B, b) and (B, b)\ns2\n\u0589(A2, a2) such that s2 \u25e6 i2 = idA2 , b \u25e6 i2 = a2, and\ns2 \u25e6 a2 = b.\nThen f1 := s2 \u25e6 i1 : (A1, a\nT\n1 ) \u2192 (A2, a\nT\n2 ) is a homomorphism as is f2 := s1 \u25e6 i2 :\n(A2, a\nT\n2 ) \u2192 (A1, a\nT\n1 ). Hence, by Lemma 3, f2 \u25e6 f1(A1, a\nT\n1 ) \u2248 (A1, a\nT\n1 ) and f1 \u25e6\nf2(A2, a\nT\n2 ) \u2248 (A2, a\nT\n2 ). Consequently, (A1, a\nT\n1 ) and (A2, a\nT\n2 ) are isomorphic, and the\nresult follows.\nPatterns and representations. A structure (A, aT ) is a T -pattern whenever for\nevery y \u2208 A, there exists a relation symbol R in \u03c3 and a tuple t in A in which y\noccurs such that RA(t) holds (that is, every element occurs in some tuple in some\nrelation of A; i.e., A has no isolated elements). A T -pattern (A, aT ) is conform if\nand only if A consists solely of an antireflexive tuple RA(t): That is, there exists a\nrelation symbol R in \u03c3 such that RA = {t}, where every element of A occurs in t\nexactly once, and for every other relation symbol R\u2032 in \u03c3, we have R\u2032\nA\n= \u2205. We\ndenote conform patterns explicitly as in (R(t), aT ).\nA representation is a pair (F , T ), where T is a structure, called the target , and\nF is a finite set of T -patterns, called the forbidden patterns. If every forbidden\npattern in F is connected, then we say that (F , T ) is connected . Let (F , T ) be a\nrepresentation. A T -colored structure (A, aT ) is valid (respectively, weakly valid) with\nrespect to (F , T ) if and only if there is no forbidden pattern (B, bT ) \u2208 F such that\n138 FLORENT MADELAINE AND IAIN A. STEWART\n(B, bT )\u2192(A, aT ) (respectively, (B, bT )\u2192\u0592(A, aT )). A structureA is valid (respectively,\nweakly valid) with respect to (F , T ) if and only if there exists a homomorphism A\naT\n\u2192T\nsuch that (A, aT ) is valid (respectively, weakly valid) with respect to (F , T ).\nConstraint satisfaction problems. It is well-known that constraint satisfaction\nproblems can be modeled in terms of the existence of homomorphisms between struc-\ntures [21]. Recall that the nonuniform constraint satisfaction problem with template\nT , denoted by CSP(T ), is the problem defined as follows:\n\u2022 instances: structures A (over the same signature as T );\n\u2022 yes instances: those instances A for which A\u2192T .\nWe denote by CSP the class of nonuniform constraint satisfaction problems. Note\nthat in [21], the adjective \u201cnonuniform\u201d was coined to distinguish such problems from\nuniform constraint satisfaction problems where the template T is not fixed but may\nrange over a class of structures (all structures in general) and is part of the input.\nSince we do not deal with uniform problems in this paper, from now on we drop the\nphrase nonuniform.\nForbidden patterns problems. The forbidden patterns problem given by the repre-\nsentation (F , T ), and denoted by FPP(F , T ), is the problem defined as follows:\n\u2022 instances: structures A (over the same signature as T );\n\u2022 yes instances: those instances A that are valid w.r.t. (F , T ).\nWe denote by FPP the class of forbidden patterns problems. If two representations\ndefine the same forbidden patterns problem, then we say that the representations are\nequivalent .\nRemark 5. A problem in CSP is clearly monotone, i.e., closed under substructures.\nFurthermore, it is closed under inverse homomorphisms. To see this, let B and T be\ntwo structures. If B \u2208 CSP(T ), then A \u2208 CSP(T ) for any A such that A\u2192B. It is\nnot difficult to check that if B \u2208 FPP(F , T ), then A \u2208 FPP(F , T ) for any A such\nthat A\u2192B. Moreover, note that the containment problem, i.e., given two structures\nT and T \u2032, decide whether CSP(T ) \u2286 CSP(T \u2032), is nothing other than the uniform\nconstraint satisfaction problem (as CSP(T ) \u2286 CSP(T \u2032) if and only if T \u2192T \u2032).\nTheorem 6. CSP \u0004 FPP.\nProof. The inclusion is clear, as a problem from CSP with template T can be\ngiven equivalently as the forbidden patterns problem with representation (\u2205, T ). It\nfollows from counterexamples given in [15, 25] that this inclusion is strict.\nThis provokes the following question, which is intrinsic to this paper: When is a\nforbidden patterns problem not a constraint satisfaction problem?\n3. Feder and Vardi\u2019s logic. The logic SNP is the fragment of existential\nsecond-order logic, ESO, consisting of formulae \u03a6 of the form \u2203S\u2200t\u03d5, where S is\na tuple of relation symbols (not in \u03c3), t is a tuple of (first-order) variables, and \u03d5 is\nquantifier-free. Furthermore: \u03a6 is in monadic SNP whenever S is a tuple of monadic\nrelation symbols; \u03a6 is in monotone SNP whenever every occurrence in \u03d5 of a symbol\nR from \u03c3 appears in the scope of an odd number of \u00ac symbols; and \u03a6 is in SNP\nwithout inequalities whenever the symbol = does not appear in \u03d5 (either positively or\nnegatively). If one thinks about the intuitive properties of the existence of a homomor-\nphism from one structure to another, one might find it plausible to consider imposing\nsome of the above restrictions on ESO. For instance, the existence (cf. the existen-\ntial second-order quantifiers) of a homomorphism from an arbitrary source graph to a\nfixed target graph is equivalent to finding a partition of the domain of the source graph\ninto sets (cf. the monadic restriction), one for each element of the target graph, so\nthat every edge of the source graph (cf. the universal prefix of first-order quantifiers)\nCONSTRAINTS, LOGIC AND FORBIDDEN PATTERNS 139\nmaps to an edge of the target graph (cf. the monotone restriction above, reflecting\nthat we are interested only in positive information, that is, about mappings of edges,\nnot about mappings of \u201cnonedges\u201d). The \u201cwithout inequalities\u201d aspect of MMSNP\ncomes about as homomorphisms do not distinguish between different elements.\nFeder and Vardi considered the imposition of combinations of these three re-\nstrictions (monadic, monotone, and without inequalities) and showed that under any\ncombination excepting the imposition of all three restrictions, the resulting logic does\nnot have a dichotomy (assuming P \u0002= NP). However, they were unable to make any\nsimilar claim about the logic obtained by imposing all three restrictions, and they\nobserved that this logic subsumes CSP. This motivated the following definition.\nDefinition 7. Monotone monadic SNP without inequality (MMSNP) is the\nfragment of ESO consisting of those formulae \u03a6 of the following form:\n\u2203M\u2200t\n\u2227\ni\n\u00ac\n(\n\u03b1i(\u03c3, t) \u2227 \u03b2i(M, t)\n)\n,\nwhere M is a tuple of monadic relation symbols (not in \u03c3), t is a tuple of (first-order)\nvariables, and for every negated conjunct \u00ac(\u03b1i \u2227 \u03b2i):\n\u2022 \u03b1i consists of a conjunction of positive atoms involving relation symbols from\n\u03c3 and variables from t; and\n\u2022 \u03b2i consists of a conjunction of atoms or negated atoms involving relation\nsymbols from M and variables from t.\n(Notice that the equality symbol does not occur in \u03a6.)\nFeder and Vardi showed that CSP is subsumed by MMSNP and, furthermore,\nthat MMSNP is computationally equivalent to CSP. (Theorem 8 is a more detailed\nreformulation of Theorem 1 and is included for completeness.)\nTheorem 8 (Feder and Vardi [15]). Every problem in CSP is definable by a\nsentence of MMSNP, but there are problems in MMSNP that are not in CSP. However,\nfor every problem \u2126 \u2208 MMSNP, there exists a problem \u2126\u2032 \u2208 CSP such that \u2126 reduces\nto \u2126\u2032 via a polynomial-time Karp reduction, and \u2126\u2032 reduces to \u2126 via a randomized\npolynomial-time Turing reduction.2\n(A more detailed proof of Theorem 8 than that in [15] can be found in [24].)\nIn the remainder of this section, we show that the logic MMSNP essentially\ncorresponds to the class FPP of forbidden patterns problems. Let us begin by looking\nat some illustrative examples.\nExample 9. Consider the signature \u03c32 = \u3008E\u3009, where E is a binary relation symbol.\nDefine \u03a61 as\n\u2203C \u2200x \u2200y \u2200z\n(\n\u00ac\n(\nE(x, y) \u2227 E(y, z) \u2227 E(z, x) \u2227 C(x) \u2227 C(y) \u2227 C(z)\n)\n\u2227 \u00ac\n(\nE(x, y) \u2227 E(y, z) \u2227 E(z, x) \u2227 \u00acC(x) \u2227 \u00acC(y) \u2227 \u00acC(z)\n))\n.\nWe can easily ascertain that \u03a61 defines the forbidden patterns problem with repre-\nsentation (F , T ), where |T | := {0, 1}, ET := |T |2, and F contains two forbidden\npatterns, one for each negated conjunct, both having as the underlying structure a\ndirected triangle (domain {x, y, z} and relation E = {(x, y), (y, z), (z, x)}): In the first\nforbidden pattern all vertices of this directed triangle are colored 0, whereas in the\nsecond forbidden pattern the vertices are all colored 1 (the colorings are given by C\nand correspond to x, y, z \u0011\u2192 0 and x, y, z \u0011\u2192 1, respectively, and the colors are the\n2As mentioned earlier, Ga\u00b4bor Kun has recently derandomized this reduction.\n140 FLORENT MADELAINE AND IAIN A. STEWART\nET ET\n\u03a61 '\u03a62 ''\u03a62\nFig. 2. Primitive sentence and representations.\nnames of the elements of the template). For simplicity, from now on we usually give\nrepresentations in a pictorial fashion. For example, the representation we have just\ndefined is depicted on the left in Figure 2; the top cell depicts the template, and the\nother cells depict the forbidden patterns. Note that the template is not a colored\nstructure; however, to depict the homomorphisms from the forbidden patterns to the\ntemplate, we have colored the elements of the template accordingly.\nIt is not so clear to which forbidden patterns problem the following sentence\ncorresponds:\n\u03a62 := \u2203C \u2200x \u2200y\n(\n\u00ac\n(\nE(x, y) \u2227 C(x)\n)\n\u2227 \u00ac\n(\nE(x, x) \u2227 C(x) \u2227 C(y)\n))\n.\nHowever, it can be transformed into equivalent sentences as follows. First, we list\nall possibilities for the monadic predicate, to ensure that we have \u201cfully colored\u201d\nstructures:\n\u2203C \u2200x \u2200y\n(\n\u00ac\n(\nE(x, y) \u2227 C(x) \u2227 C(y)\n)\n\u2227 \u00ac\n(\nE(x, y) \u2227 C(x) \u2227 \u00acC(y)\n)\n\u2227 \u00ac\n(\nE(x, x) \u2227 C(x) \u2227 \u00acC(y)\n))\n.\nThe last negated conjunct is comprised of two \u201cindependent\u201d parts, namely, (E(x, x)\u2227\nC(x)) and C(y), and does not correspond to a pattern (y does not appear in any atomic\n\u03c3-relation). We can rewrite the above formula as the disjunction of two formulae \u03a6\u20322\nand \u03a6\u2032\u20322 , where\n\u03a6\u20322 = \u2203C \u2200x \u2200y\n(\n\u00ac\n(\nE(x, y) \u2227 C(x) \u2227 C(y)\n)\n\u2227 \u00ac\n(\nE(x, y) \u2227 C(x) \u2227 \u00acC(y)\n)\n\u2227 \u00ac\n(\nE(x, x) \u2227 C(x)\n))\nand\n\u03a6\u2032\u20322 = \u2203C \u2200x \u2200y\n(\n\u00ac\n(\nE(x, y) \u2227 C(x) \u2227 C(y)\n)\n\u2227 \u00ac\n(\nE(x, y) \u2227 C(x) \u2227 \u00acC(y)\n)\n\u2227 \u00ac\n(\n\u00acC(y)\n))\n(we leave the fact that \u03a62 can be so decomposed as a simple exercise). Now from\neach formula we can extract a suitable representation: This is easy in the case of \u03a6\u20322;\nand, in the case of \u03a6\u2032\u20322 , note that the last negated conjunct essentially forces us to use\nCONSTRAINTS, LOGIC AND FORBIDDEN PATTERNS 141\na single color, so we can ignore all negated conjuncts which mention \u00acC(z) for some\nvariable z. Finally, this leads to the representations depicted in the middle and on\nthe right in Figure 2, respectively.\nThe above examples motivate the following definition and proposition.\nDefinition 10. A sentence \u03a6 of MMSNP, where \u03a6 is as in Definition 7, is\nprimitive if and only if for every negated conjunct \u00ac(\u03b1 \u2227 \u03b2):\n\u2022 for every first-order variable x that occurs in \u00ac(\u03b1\u2227\u03b2) and for every monadic\nsymbol C in M, exactly one of C(x) and \u00acC(x) occurs in \u03b2; and\n\u2022 unless x is the only first-order variable that occurs in \u00ac(\u03b1 \u2227 \u03b2), an atom of\nthe form R(t), where x occurs in t and R is a relation symbol from \u03c3, must\noccur in \u03b1.\nProposition 11. Every sentence of MMSNP is logically equivalent to a finite\ndisjunction of primitive sentences.\nProof. Let \u03a6 be a sentence of MMSNP that is not primitive. Assume that \u03a6 does\nnot satisfy the first property of Definition 10. Let \u00ac\n(\n\u03b1(\u03c3, t) \u2227 \u03b2(M, t)\n)\nbe a negated\nconjunct in \u03a6 where there exists a (first-order) variable x that occurs in this negated\nconjunct and a monadic symbol C in M such that neither C(x) nor \u00acC(x) occurs in\n\u03b2. Replace \u00ac(\u03b1 \u2227 \u03b2) in \u03a6 by the conjunction of two negated conjuncts:\n\u00ac\n(\n\u03b1 \u2227 \u03b2 \u2227 C(x)\n)\n\u2227 \u00ac\n(\n\u03b1 \u2227 \u03b2 \u2227 \u00acC(x)\n)\n.\nThis new formula belongs to MMSNP and is logically equivalent to \u03a6. We iterate this\nprocess until the sentence satisfies the first property of Definition 10. Let \u03a6\u2032 denote\nthis new sentence.\nIt may be the case that the second property does not hold for \u03a6\u2032 because of a\nnegated conjunct of the form \u00ac\n(\n\u03b1(\u03c3, t)\u2227\u03b20(M, t)\u2227\u03b21(M, x)\n)\n, where x does not occur\nin t, where \u03b1(\u03c3, t) may be empty, and where \u03b21 is the conjunction of all atoms and\nnegated atoms of \u03b2 involving symbols fromM and the variable x (\u03b20 is a conjunction\nof the remaining atoms and negated atoms of \u03b2). Let \u03a6\u2032\u2032 = \u03a6\u20321 \u2228 \u03a6\n\u2032\n2, where\n\u2022 \u03a6\u20321 is obtained from \u03a6\n\u2032 by replacing \u00ac(\u03b1\u2227 (\u03b20 \u2227 \u03b21)) in \u03a6\n\u2032 by \u00ac(\u03b1\u2227 \u03b20); and\n\u2022 \u03a6\u20322 is obtained from \u03a6\n\u2032 by replacing \u00ac(\u03b1 \u2227 (\u03b20 \u2227 \u03b21)) in \u03a6\n\u2032 by \u00ac\u03b21.\nFirst, note that \u03a6\u20321 and \u03a6\n\u2032\n2 are both in MMSNP. Second, it is not hard to check that\n\u03a6\u2032\u2032 is logically equivalent to \u03a6\u2032. We iterate this transformation until each sentence in\nthe disjunction satisfies the second property of Definition 10.\nWe are now ready to state exactly what the correspondence is between MMSNP\nand FPP.\nTheorem 12. The class of problems captured by the primitive fragment of the\nlogic MMSNP is exactly the class FPP of forbidden patterns problems.\nProof. Let \u03a6 = \u2203M\u2200t\u03d5 be a primitive sentence of MMSNP. We shall build a\nrepresentation (F , T ) from \u03a6. A conjunction \u03c7(M, x) of atoms and negated atoms\ninvolving only relation symbols from M and the sole first-order variable x, where for\neach relation symbol C in M, exactly one of C(x) or \u00acC(x) occurs, is referred to as\nanM-color. So, associated with every negated conjunct \u00ac(\u03b1\u2227\u03b2) in \u03a6 (more precisely,\nwith \u03b2 in every such negated conjunct) and every variable occurring in this negated\nconjunct is a unique M-color; in fact, \u03b2 can be written as the conjunction of these\nM-colors. Construct the structure T from \u03a6 as follows:\n\u2022 Its domain T consists of allM-colors \u03c7(M, x) that are not explicitly forbidden\nin \u03a6 by some negated conjunct \u00ac(\u03b1\u2227 \u03b2) of \u03d5 having the form \u00ac\u03c7(M, x), i.e.,\nso that \u03b1 is empty and \u03b2 is the M-color \u03c7; and\n\u2022 for every relation symbol R of arity m in \u03c3, set RT := Tm.\n142 FLORENT MADELAINE AND IAIN A. STEWART\nStart with F := \u2205, and for every negated conjunct \u00ac(\u03b1 \u2227 \u03b2) in \u03d5, add to F the\nstructure (A\u03b1, a\nT\n\u03b2 ), where\n\u2022 A\u03b1 is the structure defined as follows:\n\u2013 the domain consists of all first-order variables that occur in the negated\nconjunct \u00ac(\u03b1 \u2227 \u03b2); and\n\u2013 for every relation symbol R in \u03c3, there is a tuple RA\u03b1(t) if and only if\nthe atom R(t) appears in \u03b1;\n\u2022 for every x \u2208 |A\u03b1|, set a\nT\n\u03b2 (x) := \u03c7, where \u03c7 is the M-color of x in \u03b2.\n(The fact that \u03a6 is primitive makes these definitions well-defined.)\nLet B be a structure such that B |= \u03a6. So, there exists an assignment \u03a0 :M\u2192 2B\n(where 2B denotes the power set of B) such that B |= \u2200t\u03d5(\u03a0(M), t) (here, \u03d5(\u03a0(M), t)\ndenotes the formula \u03d5 where every monadic predicate is instantiated as the subset of\nB given by the assignment \u03a0). Since \u03a6 = \u2203M\u2200t\u03d5 is primitive, the formula \u03d5 is of\nthe form:\n\u00ac\u03c71(M, x) \u2227 \u00ac\u03c72(M, x) \u2227 \u00b7 \u00b7 \u00b7 \u2227 \u00ac\u03c7k(M, x) \u2227 \u03c8(\u03c3,M, t),\nwhere k \u2265 0, and for every 1 \u2264 i \u2264 k, \u03c7i is an M-color (with all such M-colors\ndistinct) and \u03c8 is a conjunction of negated conjuncts that are not M-colors.\nThe assignment \u03a0 induces a map \u03c0T from B to the set T that sends an element\nu \u2208 B to \u03c7, where \u03c7 is the unique M-color for which \u03c7(\u03a0(M), u) holds (note that\n\u03c7 \u0002= \u03c7i for i = 1, 2, . . . , k, as \u00ac\u03c7i(\u03a0(M), u) holds for all u \u2208 B).\nLet \u00ac(\u03b1\u2227 \u03b2) be a negated conjunct of \u03d5, where \u03b1 is nonempty, and suppose that\n(A\u03b1, a\nT\n\u03b2 )\nh\n\u2192(B, \u03c0T ).\nLet R(x1, x2, . . . , xa) be an atom appearing in \u03b1. So, R\nA\u03b1(x1, x2, . . . , xa) holds\nand consequently RB(h(x1), h(x2), . . . , h(xa)) holds. Thus, if t\n\u2032 is the tuple of vari-\nables appearing in \u00ac(\u03b1 \u2227 \u03b2), then \u03b1B(h(t\u2032)) holds. Also, \u03c0T \u25e6 h = aT\u03b2 and so\n\u03c0T (h(t\u2032)) = aT\u03b2 (t\n\u2032). That is, \u03b2B(\u03a0(M), h(t\u2032)) holds. Thus (\u03b1 \u2227 \u03b2)B(\u03a0(M), h(t\u2032))\nholds, which contradicts the fact that B |= \u03a6, witnessed by \u03a0(M). Hence, B \u2208\nFPP(F , T ).\nConversely, suppose that B \u2208 FPP(F , T ), witnessed by the homomorphism\nB\n\u03c0T\n\u2192T . Clearly, \u03c0T gives rise to an assignment \u03a0 : M \u2192 2B , where u \u2208 \u03a0(C)\nfor some C \u2208 M and u \u2208 B, if and only if C(y) appears in \u03c7(y), where \u03c0T (u) = \u03c7.\nAssume that B |= \u03b1(h(t\u2032)) \u2227 \u03b2(\u03a0(M), h(t\u2032)) for some map h : |A\u03b1| \u2192 |B|, where\n\u00ac(\u03b1\u2227\u03b2) is a negated conjunct of \u03d5, and t\u2032 is the tuple of variables appearing in \u03b1\u2227\u03b2.\nIf RA\u03b1(x1, x2, . . . , xa) holds, then R\nB(h(x1), h(x2), . . . , h(xa)) holds. If \u03b2 is of\nthe form\n\u2227d\ni=1 \u03c7\ni(xi), where t\n\u2032 = (x1, x2, . . . , xd) and each \u03c7\ni is an M-color, then\n\u03c7i(\u03a0(M), h(xi)) holds for each i = 1, 2, . . . , d. However, by definition a\nT\n\u03b2 (xi) = \u03c7\ni,\nand so \u03c0T (h(xi)) = a\nT\n\u03b2 (xi) for each i = 1, 2, . . . , d. Hence, (A\u03b1, a\nT\n\u03b2 )\nh\n\u2192(B, \u03c0T ), which\nyields a contradiction. Thus, B |= \u03a6, witnessed by the assignment \u03a0(M), and the\nimplication follows.\nConversely, given a representation (F , T ), we shall build a corresponding primi-\ntive sentence of MMSNP. Let M = {C1, C2, . . . , Ck} be a set of monadic predicates\nthat are not in \u03c3 such that k = \u2308log2 |T |\u2309. To each element xi of |T |, we associate\nsome arbitrary M-color \u03c7xi . Let \u03c7|T |+1, . . . , \u03c72k denote the remaining M-colors (if\n|T | < 2k). Let \u03a6 = \u2203M\u2200t\u03c6, where \u2200t\u03c6 is the universal closure of the conjunction of\nthe following negated conjuncts:\n\u2022 If |T | < 2k, then for every i such that |T | < i \u2264 2k, we add the negated\nconjunct \u00ac\u03c7i(y).\nCONSTRAINTS, LOGIC AND FORBIDDEN PATTERNS 143\n\u2022 For each tuple R(i1, i2, . . . , ir) that does not hold in T , we add the negated\nconjunct \u00ac(R(y1, y2, . . . , yr) \u2227 \u03c7i1(y1) \u2227 \u03c7i2(y2) \u2227 \u00b7 \u00b7 \u00b7 \u2227 \u03c7ir (yr)), where the\nvariables y1, y2, . . . , yr are pairwise distinct.\n\u2022 For each forbidden pattern (A, aT ) in F , we add the negated conjunct \u00ac(\u03b1\u2227\n\u03b2), where \u03b1 is the conjunction of the tuples of F , and \u03b2 is the conjunction\u2227\nx\u2208|A| \u03c7aT (x)(x).\nThe first type of negated conjunct ensures that we may use only the M-colors that\ncorrespond to elements of T . The second type of negated conjunct describes that there\nis a homomorphism to T . Finally, the last type of negated conjunct enforces that this\nhomomorphism is not compatible with any of the forbidden patterns. Consequently,\na structure B is a yes instance of the forbidden patterns problem with representation\n(F , T ) if and only if B |= \u03a6. The formal proof of this equivalence is similar to that\nof the first implication. This concludes the proof.\nBy Proposition 11, every forbidden patterns problem is described by a primitive\nsentence of MMSNP. Since the disjunction of two sentences of MMSNP is logically\nequivalent to a sentence of MMSNP, we get the following corollary from the above\ntheorem.\nCorollary 13. The class of problems captured by the logic MMSNP corresponds\nexactly to the class of finite unions of problems in FPP.\n4. A normal form for problems in FPP. In this section, we introduce nor-\nmal representations and show how any representation can be effectively rewritten into\nan equivalent normal representation. The transformation is achieved through a com-\nbination of different operations so as to enforce various properties. We shall make\nclear later, in section 5, why we need these properties.\nHowever, before we proceed, let us try and give some idea here of the direction of\ntravel by stating the properties we wish to enforce and our intended goal. We shall\nstate the properties again at the appropriate point in the text, as we do with the\ndefinition and result stated below. Let (F , T ) be a representation. The properties\nwe wish to enforce upon (F , T ) are as follows.\n(p1) Any structure is valid if and only if it is weakly valid.\n(p2) Every pattern of F is automorphic.\n(p3) It is not the case that (B1, b\nT\n1 )\u2192\u0592(B2, b\nT\n2 ) for any distinct patterns (B1, b\nT\n1 )\nand (B2, b\nT\n2 ) of F .\n(p4) No pattern of F is conform.\n(p5) Every forbidden pattern is biconnected.\n(p6) The representation (F , T ) is automorphic.\nWe say that a connected representation for which properties p1 to p6 hold is a normal\nrepresentation. In the process of reducing our representation to a normal representa-\ntion, we will show that this can be done by an effective procedure.\n4.1. Our first batch of reductions. Let (F , T ) be a representation. We now\ndefine a number of operations on representations so that we might enforce certain\nproperties. However, before we start, we wish our representation to have the following\nproperty:\n(p1) Any structure is valid if and only if it is weakly valid.\nLet HF be the set of homomorphic images of the patterns from F , up to isomor-\nphism. Recall that a forbidden pattern is a colored structure; hence, an homomorphic\nimage of a forbidden pattern (B, bT ) \u2208 F is a colored structure (C, cT ) such that\nthere exists an epimorphism B\nh\n\u0589C with the properties that:\n144 FLORENT MADELAINE AND IAIN A. STEWART\nB C\nT\nTb\nh\nTc\nFig. 3. A commuting diagram.\n\u2022 for each symbol R \u2208 \u03c3 and for each tuple RC (\u02dct), there exists a tuple RB(t)\nsuch that h(t) = t\u02dc and\n\u2022 the diagram in Figure 3 commutes.\nLemma 14. The representation (HF , T ) is equivalent to (F , T ).\nProof. LetA be valid w.r.t. (F , T ), witnessed byA\naT\n\u2192T . Assume for contradiction\nthat (A, aT ) is not valid w.r.t. (HF , T ), and let (C, cT ) \u2208 HF (defined from (B, bT ) \u2208\nF , using h as above) be such that (C, cT )\nf\n\u2192(A, aT ). By composition, it follows that\n(B, bT )\nf\u25e6h\n\u2192 (A, aT ). This yields a contradiction, and so (A, aT ) is valid w.r.t. (HF , T ).\nConversely, if A is valid w.r.t. (HF , T ), then A is valid w.r.t. (F , T ) since F \u2286\nHF .\nLemma 15. The representation (HF , T ) satisfies p1.\nProof. Let (A, aT ) be weakly valid w.r.t. (HF , T ). Assume for contradiction that\n(A, aT ) is not valid w.r.t. (HF , T ), and let (C, cT ) \u2208 HF (defined from (B, bT ) \u2208 F ,\nusing h as above) be such that (C, cT )\nf\n\u2192(A, aT ). By construction, f(C, cT ) belongs\nto HF , and f(C, cT )\u2192\u0592(A, aT ). This yields a contradiction.\nConversely, if (A, aT ) is valid w.r.t. (HF , T ), then it is trivially weakly valid.\nThe result follows.\nOur next property to enforce is the following:\n(p2) Every pattern of F is automorphic.\nDefinition 16. Let (F , T ) be a representation, and let (F \u2032, T ) be the represen-\ntation obtained by replacing a pattern of F with its core. We call this a core reduction\non (F , T ).\nNote that Definition 16 is well-defined by Lemma 4.\nLemma 17. Let the representation (F \u2032, T ) be obtained from the representation\n(F , T ) by a core reduction.\n\u2022 (F \u2032, T ) is equivalent to (F , T ).\n\u2022 If (F , T ) satisfies property p1, then so does (F \u2032, T ).\nProof. If (C, cT ) is the core of (B, bT ), then (B, bT )\u2192(A, aT ) if and only if\n(C, cT )\u2192(A, aT ) for any structure (A, aT ). Hence, (F \u2032, T ) is equivalent to (F , T ).\nAssume that (F , T ) satisfies property p1. Suppose that (A, aT ) is weakly\nvalid w.r.t. (F \u2032, T ). If (C, cT )\u2192(A, aT ) for some (C, cT ) \u2208 F \u2032, then we must\nhave that (B, bT )\u2192(A, aT ) for some (B, bT ) \u2208 F . As (F , T ) satisfies property p1,\n(D, dT )\u2192\u0592(A, aT ) for some (D, dT ) \u2208 F . If (D, dT ) \u2208 F \u2032, then we obtain a contradic-\ntion; otherwise, the core of (D, dT ) is in F \u2032, and we still obtain that some forbidden\npattern of F \u2032 embeds into (A, aT ), yielding a contradiction. Hence, (F \u2032, T ) satisfies\nproperty p1.\nOur next property to enforce is the following:\n(p3) It is not the case that (B1, b\nT\n1 )\u2192\u0592(B2, b\nT\n2 ) for any distinct patterns (B1, b\nT\n1 )\nand (B2, b\nT\n2 ) of F .\nCONSTRAINTS, LOGIC AND FORBIDDEN PATTERNS 145\nDefinition 18. Let (F , T ) be a representation, and let (B1, b\nT\n1 ) and (B2, b\nT\n2 ) be\ndistinct patterns of F such that (B1, b\nT\n1 )\u2192\u0592(B2, b\nT\n2 ). Let (F\n\u2032, T ) be the representation\nobtained by removing the pattern (B2, b\nT\n2 ) from F . We call this an embed reduction\non (F , T ).\nLemma 19. Let the representation (F \u2032, T ) be obtained from the representation\n(F , T ) by an embed reduction.\n\u2022 (F \u2032, T ) is equivalent to (F , T ).\n\u2022 If (F , T ) satisfies property p1, then so does (F \u2032, T ).\nProof. Trivially, FPP(F , T ) \u2286 FPP(F \u2032, T ). If (B2, b\nT\n2 )\u2192(A, a\nT ) (with ref-\nerence to Definition 18), then (B1, b\nT\n1 )\u2192(A, a\nT ) for any structure (A, aT ), and so\nFPP(F \u2032, T ) \u2286 FPP(F , T ).\nAssume that (F , T ) satisfies property p1. Suppose that (A, aT ) is weakly valid\nw.r.t. (F \u2032, T ). If (B, bT )\u2192(A, aT ) for some pattern (B, bT ) \u2208 F \u2032, and so some pat-\ntern in F , then we have that (A, aT ) is not weakly valid w.r.t. (F , T ). That is,\n(C, cT )\u2192\u0592(A, aT ) for some pattern (C, cT ) \u2208 F . If (C, cT ) \u2208 F \u2032, then we obtain a\ncontradiction; otherwise, (C, cT ) is the pattern removed by the embed reduction and\n(D, dT )\u2192\u0592(C, cT ) for some pattern (D, dT ) \u2208 F \u2032. Thus, we still obtain a contradiction,\nand (F \u2032, T ) satisfies p1.\nOur next property to enforce is the following:\n(p4) No pattern of F is conform.\nDefinition 20. Let (F , T ) be a representation, and let (R(t), \u03c0T ) be a conform\npattern of F . Let T \u2032 be the structure obtained from T by the removal of the tuple\nR(\u03c0T (t)), and let e be the monomorphism T \u2032\ne\n\u2192\u0592T defined by inclusion. Let F \u2032 denote\nthe set of patterns of F that are also T \u2032-patterns; that is, the patterns (B, bT ) \u2208 F\nfor which bT (u) \u0002= \u03c0T (t) for any tuple RB(u). The representation (F \u2032, T \u2032) has been\nobtained from (F , T ) by a conform reduction.\nLemma 21. Let the representation (F \u2032, T \u2032) be obtained from the representation\n(F , T ) by a conform reduction.\n\u2022 (F \u2032, T \u2032) is equivalent to (F , T ).\n\u2022 If (F , T ) satisfies property p1, then so does (F \u2032, T \u2032).\nProof. We denote a pattern (B, bT ) \u2208 F that is also a T \u2032-pattern by (B, bT\n\u2032\n) also,\nwhere bT\n\u2032\nis the homomorphism B\nbT\n\u2032\n\u2192T \u2032 obtained directly from bT ; that is, bT = e\u25e6bT\n\u2032\n.\nAssume that (A, aT\n\u2032\n) is valid w.r.t. (F \u2032, T \u2032) and define aT := e\u25e6aT\n\u2032\n(soA\naT\n\u2192T and\naT (u) \u0002= \u03c0T (t) for any tuple RA(u)). Suppose that some pattern (B, bT ) \u2208 F is such\nthat (B, bT )\u2192(A, aT ). Thus, (B, bT ) is actually a T \u2032-pattern, and (B, bT\n\u2032\n)\u2192(A, aT\n\u2032\n),\nwhich yields a contradiction.\nConversely, suppose that (A, aT ) is valid w.r.t. (F , T ). There are two cases:\neither the map aT yields a homomorphism A\u2192T \u2032, or it doesn\u2019t.\nSuppose that the map aT yields a homomorphism A\naT\n\u2032\n\u2192T \u2032; thus, aT = e \u25e6 aT\n\u2032\n.\nIf (B, bT\n\u2032\n) \u2208 F \u2032 is such that (B, bT\n\u2032\n)\u2192(A, aT\n\u2032\n), then we have that (B, bT )\u2192(A, aT )\n(where bT = e\u25e6bT\n\u2032\n, recall), which yields a contradiction. Thus, (A, aT\n\u2032\n) is valid w.r.t.\n(F \u2032, T \u2032).\nSuppose that the map aT does not yield a homomorphism from A to T \u2032. There\nmust exist some tuple RA(t\u02c6) such that aT (t\u02c6) = \u03c0T (t). Define h : |R(t)| \u2192 |A|\nas the map which takes t to t\u02c6 (note that this is well-defined as t is antireflexive).\nConsequently, (R(t), \u03c0T )\nh\n\u2192(A, aT ), which yields a contradiction as (A, aT ) is valid\nw.r.t. (F , T ). Hence, (F \u2032, T \u2032) is equivalent to (F , T ).\nAssume that (F , T ) satisfies property p1. Suppose that (A, aT\n\u2032\n) is weakly valid\nw.r.t. (F \u2032, T \u2032) and that there exists a pattern (B, bT\n\u2032\n) \u2208 F \u2032 such that (B, bT\n\u2032\n)\u2192(A, aT\n\u2032\n).\n146 FLORENT MADELAINE AND IAIN A. STEWART\nFig. 4. Depiction of tuples.\nDefine bT := e \u25e6 bT\n\u2032\nand aT := e \u25e6 aT\n\u2032\n. Thus, (B, bT ) \u2208 F and (B, bT )\u2192(A, aT ).\nHence, (A, aT ) is not weakly valid w.r.t. (F , T ). That is, (C, cT )\u2192\u0592(A, aT ) for some\npattern (C, cT ) \u2208 F . But as aT = e \u25e6 aT\n\u2032\n, so (C, cT ) is also a T \u2032-pattern and so is in\nF \u2032. This yields a contradiction, and the result follows.\nRemark 22. Applying embed reductions clearly preserves property p2. Note also\nthat applying conform reductions preserves property p2. This follows directly from\nLemma 2.\nExample 23. Consider a representation (F , T ) over the signature consisting of a\nbinary relation symbol E and a ternary relation symbol R. The domain of T consists\nof two elements (or colors) \u25e6 and \u2022, with ET = {\u25e6, \u2022}2 and RT = {\u25e6, \u2022}3.\nConsider the conform forbidden pattern consisting of the single tuple R(x, y, z),\nwhere both x and y take the color \u25e6 and z takes the color \u2022. We depict this pattern\nby the left diagram in Figure 4. In the case where x = y, we depict the pattern by\nthe right diagram in Figure 4.\nThe first (leftmost) column in Figure 5 depicts the four forbidden patterns in F\n(the top three are such that R = \u2205, and the bottom is such that E = \u2205). The sec-\nond column depicts the representation (HF , T ), formed by adding all homomorphic\nimages of the forbidden patterns in F (up to isomorphism). In the third column, we\nhave performed core and embed reductions to obtain an equivalent representation\nsatisfying properties p1, p2, and p3. In the fourth column, we have performed con-\nform reductions to obtain an equivalent representation satisfying properties p1, p2, p3,\nand p4.\nNote that, in general, starting from a representation satisfying property p1, if we\napply core, embed, and conform reductions arbitrarily, then after a finite sequence of\nreductions, by the lemmas of this subsection, we will obtain an equivalent represen-\ntation satisfying properties p1, p2, p3, and p4 (a simple induction suffices).\n4.2. Feder\u2013Vardi reductions. The reductions introduced so far do not suffice\nfor us to obtain the normal form for which we are aiming. We need to interleave\napplications of these reductions with another reduction that we define now.\nFrom now on, we make an important assumption regarding the representations\nwe deal with: Until otherwise specified, we assume them to be connected (we shall\ndeal with the disconnected case in section 6.1.1).\nWe say that a pattern is biconnected if its underlying structure is biconnected.\nOur aim is to enforce the following property (using techniques inspired from the proof\nof Theorem 8 in [15]):\n(p5) Every forbidden pattern is biconnected.\nBefore proceeding, we need some definitions relating to the grouping together of\nforbidden patterns. A compact T -structure {A, \u03b1} is a structure A together with a\nmap \u03b1 : A\u2192 2T so that every map aT : A\u2192 T with the property that aT (y) \u2208 \u03b1(y),\nfor all y \u2208 A, yields a T -colored structure (A, aT ). This notion is only a useful\nshorthand to denote a set of colored structures, as a compact structure can be expanded\nto obtain a set of colored structures, each with the same underlying structure; but we\nshall need this notion later on when we prove the termination of a particular sequence\nof transformations we employ towards the end of this section (this notion was not\nnecessary in Feder and Vardi\u2019s original proof as the negated conjuncts correspond\nCONSTRAINTS, LOGIC AND FORBIDDEN PATTERNS 147\nT\nR  = {   ,   }3\nET\nT\nR  = {   ,   }3\nET\nT\nR  = {   ,   }3\nET\nT 3\nET\nR  = {   ,   }  \n(F, T ) (HF, T )\np\n1\np\n2\np\n1\np\n3\np\n2\np\n1\np\n3\np\n4\n\\ {(   ,   ,   )}\nFig. 5. Towards a normal representation: step one.\nin general to partially colored structures; by choosing to work with fully colored\nstructures in our combinatorial setting, this is the price we have to pay). Bearing this\nin mind, we can extend the definition of a representation to allow compact forbidden\npatterns and call it a compact representation, with the problem defined by a compact\nrepresentation being the problem defined by the representation obtained by expanding\nall of the compact forbidden patterns.\nClearly, we may assume that every representation is compact, by replacing every\nforbidden pattern (A, aT ) by the compact forbidden pattern {A, \u03b1}, where for every\nx in A, \u03b1(x) := {aT (x)}. We say that (A, aT ) is a forbidden pattern of the compact\nrepresentation (F , T ), and write (A, aT ) \u2208 F , if it is one of the forbidden patterns\nobtained by expanding one of the compact forbidden patterns. Notice that the notion\n148 FLORENT MADELAINE AND IAIN A. STEWART\nT\nK\nCB\n\u03b2 \u03b3\nx\nT\nK0 K1\n'\nCB\nx x\n\u03b2 \u03b30 1\nFig. 6. Feder\u2013Vardi reduction.\nof a decomposition involves only the underlying structure; thus it generalizes to com-\npact structures (of course, the definition of a decomposition in section 2 generalizes\nto colored structures).\nDefinition 24 (Feder\u2013Vardi reduction). Let (F , T ) be a compact representation\nwith F = G \u222a {{B, \u03b2}\nx\n32 {C, \u03b3}}, and let K = \u03b2(x) = \u03b3(x). The new sets K0 and\nK1 are defined as {ki : k \u2208 K} (that is, k0 and k1 are two new elements that stand as\ncopies of k) for i = 0, 1, and we assume that K, K0, and K1 are mutually disjoint.\nLet T \u2032 be the structure obtained from T as follows:\n\u2022 Replace K by K0 and K1 in |T |.\n\u2022 Set RT\n\u2032\n(t) whenever RT (\u02dct), with t obtained from t\u02dc by replacing every occur-\nrence of an element k \u2208 K by either k0 or k1 (where two different occurrences\nof an element k might be replaced by k0 and k1; so, one tuple R\nT (\u02dct) with i\noccurrences of elements of K gives rise to 2i tuples RT\n\u2032\n(t)).\nLet F \u2032 be the set of compact forbidden patterns induced from F as follows:\n\u2022 The compact forbidden pattern {B, \u03b2}\nx\n32 {C, \u03b3} is replaced by the two compact\nforbidden patterns induced from the decomposition so that\n\u2013 in the compact forbidden pattern {B, \u03b20}, \u03b20(x) = K0, and\n\u2013 in the compact forbidden pattern {C, \u03b31}, \u03b31(x) = K1.\n\u2022 Every remaining occurrence of a color k \u2208 K in a compact forbidden pattern\n(including the two described above) is replaced by both k0 and k1; that is,\nevery forbidden pattern obtained by expanding a compact forbidden pattern of\nF is replaced by a set of forbidden patterns, one for each possible assignment\nof k0 and k1 to occurrences of k.\nWe call (F \u2032, T \u2032) the Feder\u2013Vardi reduction of (F , T ) with respect to {B, \u03b2}\nx\n32\n{C, \u03b3}.\nPart of a Feder\u2013Vardi reduction can be visualized as in Figure 6. Note that if\n(F , T ) is a connected representation, then a Feder\u2013Vardi reduction of (F , T ) is also\nconnected.\nWe reiterate that working with compact forbidden patterns is just, to some extent,\na notational convenience and that a Feder\u2013Vardi reduction has the effect of \u201csplitting\u201d\na set of forbidden patterns in one go.\nWe also need to define the essential notion of a recoloring. Intuitively, a recoloring\nis to a (compact) representation what a homomorphism is to a structure.\nCONSTRAINTS, LOGIC AND FORBIDDEN PATTERNS 149\nT '\nA\nT 'b\nT 'a T\n'\nc\nf\nr\nT\nC\nTc  \nB\nTa  \ng\nFig. 7. Proof of Proposition 26.\nDefinition 25 (Recoloring). Let (F , T ) and (F \u2032, T \u2032) be two compact represen-\ntations. A recoloring r of (F \u2032, T \u2032) to (F , T ) is a homomorphism T \u2032\nr\n\u2192T such that any\ninverse image (A, aT\n\u2032\n) of a forbidden pattern (A, aT ) of F is not valid w.r.t. (F \u2032, T \u2032),\nwhere by \u201cinverse image\u201d we mean that r \u25e6 aT\n\u2032\n= aT . We denote the fact that r is\na recoloring by (F \u2032, T \u2032)\nr\n\u2192(F , T ) (we use the same notation as for homomorphisms\nwithout causing any confusion). If, furthermore, r is onto (respectively, one-to-one),\nthen r is an epirecoloring (respectively, monorecoloring). If (F \u2032, T \u2032)\nr\n\u2192\u0592 (F , T ) and\n(F , T )\nr\u22121\n\u2192 (F \u2032, T \u2032), then r is an isorecoloring, and we write (F , T ) \u2248 (F \u2032, T \u2032).\nThe fact that for CSP, CSP(A) \u2286 CSP(B) whenever A\u2192B, generalizes to FPP.\nProposition 26. Let (F , T ) and (F \u2032, T \u2032) be two compact representations. If\n(F \u2032, T \u2032)\u2192(F , T ), then FPP(F \u2032, T \u2032) \u2286 FPP(F , T ).\nProof. Let (F \u2032, T \u2032)\nr\n\u2192(F , T ), and let C be a structure that is not valid w.r.t.\n(F , T ). If C \u0003 T \u2032, then C is not valid w.r.t. (F \u2032, T \u2032), and we are done. Thus, let\nC\ncT\n\u2032\n\u2192T \u2032 and define cT := r \u25e6 cT\n\u2032\n. By assumption, there exists a forbidden pattern\n(A, aT ) \u2208 F such that (A, aT )\nf\n\u2192(C, cT ); so define aT\n\u2032\n:= cT\n\u2032\n\u25e6 f , with the result\nthat aT = r \u25e6 aT\n\u2032\n(see Figure 7). Since r is a recoloring, there exists a forbidden\npattern (B, bT\n\u2032\n) \u2208 F \u2032 such that (B, bT\n\u2032\n)\ng\n\u2192(A, aT\n\u2032\n). This can be summarized by the\ncommuting diagram of Figure 7.\nHence, we can see that (B, bT\n\u2032\n)\nf\u25e6g\n\u2192 (C, cT\n\u2032\n), which proves that (C, cT\n\u2032\n) is not valid\nw.r.t. (F \u2032, T \u2032), and we are done.\nProposition 27. Let (F \u2032, T \u2032) be obtained from (F , T ) via a Feder\u2013Vardi re-\nduction, as in Definition 24. Then (F \u2032, T \u2032) and (F , T ) are equivalent.\nProof. Let T \u2032\nr\n\u2192T be the homomorphism that identifies ki \u2208 Ki for i = 0, 1, with\nk \u2208 K, and leaves all other elements fixed. We begin by proving that r is a recoloring.\nBy construction, the inverse images of any forbidden pattern of G belong to F \u2032.\nSo, it remains to check the inverse images of the patterns expanded from the com-\npact forbidden pattern {B, \u03b2}\nx\n32 {C, \u03b3}. Assume without loss of generality (w.l.o.g.)\nthat we are checking an inverse image where x takes a color from K0. Consider the\nsubstructure of the inverse image induced by B. By construction, this substructure\nis one of the patterns expanded from the compact forbidden pattern {B, \u03b20} (con-\nstructed as in Definition 24), which is a compact forbidden pattern of F \u2032. The case\nwhen x takes a color from K1 is similar. Hence, r is a recoloring. By Proposition 26,\nFPP(F \u2032, T \u2032) \u2286 FPP(F , T ).\nConversely, suppose that (A, aT ) is valid w.r.t. (F , T ). We construct a coloring\naT\n\u2032\nfrom aT as follows:\n\u2022 For any y \u2208 A such that aT (y) \u0002\u2208 K, set aT\n\u2032\n(y) = aT (y);\n\u2022 Suppose that aT (y) = k \u2208 K. As (A, aT ) is valid w.r.t. (F , T ), there does\nnot exist a homomorphism from any forbidden pattern expanded from the\n150 FLORENT MADELAINE AND IAIN A. STEWART\nT '\nD\nT 'd\nT 'a\nh\nr\nT\nA\nTa  Td  \nFig. 8. The first case.\nT '\nB\nT 'b\nT 'a\nh\nr\nT\nA\nTa  Tb  \nFig. 9. The second case.\ncompact forbidden pattern {B, \u03b2}\nx\n32 {C, \u03b3} to (A, aT ). That is, there does not\nexist (B, bT ) \u2208 {B, \u03b20} and (C, c\nT ) \u2208 {C, \u03b31} such that both (B, b\nT )\nhB\u2192(A, aT )\nand (C, cT )\nhC\u2192(A, aT ), with hB(x) = hC(x) = y. Thus\n\u2013 if there exists (B, bT ) \u2208 {B, \u03b20} such that (B, b\nT )\nhB\u2192(A, aT ), with hB(x) =\ny, then set aT\n\u2032\n(y) = k1;\n\u2013 otherwise, set aT\n\u2032\n(y) = k0.\nSuppose that (D, dT\n\u2032\n)\nh\n\u2192(A, aT\n\u2032\n), where (D, dT\n\u2032\n) is derived from some forbidden\npattern (D, dT ) of (some compact forbidden pattern of) G (according to the Feder\u2013\nVardi reduction). Thus, we have the commutative diagram of Figure 8. This yields a\ncontradiction as (A, aT ) is valid w.r.t. (F , T ).\nSuppose that (B, bT\n\u2032\n)\nh\n\u2192(A, aT\n\u2032\n), where (B, bT\n\u2032\n) is derived from the compact for-\nbidden pattern {B, \u03b2}\nx\n32 {C, \u03b3} (according to the Feder\u2013Vardi reduction). Thus, we\nhave the commutative diagram of Figure 9. In particular, (B, bT )\nh\n\u2192(A, aT ), where\n(B, bT ) \u2208 {B, \u03b20}. Set h(x) = y. By definition of a\nT \u2032 , aT\n\u2032\n\u25e6 h(x) \u2208 K1. However, by\ndefinition of {B, \u03b20}, b\nT \u2032(x) \u2208 K0. The fact that b\nT \u2032 = aT\n\u2032\n\u25e6 h yields a contradiction.\nSuppose that it is not the case that (B, bT\n\u2032\n)\nh\n\u2192(A, aT\n\u2032\n) for any (B, bT\n\u2032\n) derived\nfrom the compact forbidden pattern {B, \u03b2}\nx\n32 {C, \u03b3} (according to the Feder\u2013Vardi\nreduction) but that (C, cT\n\u2032\n)\nh\n\u2192(A, aT\n\u2032\n) for some (C, cT\n\u2032\n) derived from the compact\nforbidden pattern {B, \u03b2}\nx\n32 {C, \u03b3}. A contradiction follows by reasoning analogously\nto the preceding case. Hence, we have that FPP(F , T ) \u2286 FPP(F \u2032, T \u2032).\nProposition 28. Let (F \u2032, T \u2032) be obtained from (F , T ) via a Feder\u2013Vardi reduc-\ntion, as in Definition 24. If property p1 holds for (F , T ), then it holds for (F \u2032, T \u2032).\nProof. Define T \u2032\nr\n\u2192T to be the homomorphism that identifies ki \u2208 Ki for i = 0, 1,\nwith k \u2208 K, and leaves all other elements fixed. Let A be nonvalid w.r.t. (F \u2032, T \u2032).\nSince (F , T ) is equivalent to (F \u2032, T \u2032), by Proposition 27, it follows that A is nonvalid\nw.r.t. (F , T ). We may assume thatA\u2192T \u2032. LetA\naT\n\u2032\n\u2192T \u2032 and define aT := r\u25e6aT\n\u2032\n. As p1\nholds for (F , T ), there exists (D, dT ) \u2208 F such that (D, dT )\nf\n\u2192\u0592(A, aT ). In particular,\nCONSTRAINTS, LOGIC AND FORBIDDEN PATTERNS 151\nr \u25e6aT\n\u2032\n\u25e6f = dT ; so, r \u25e6dT\n\u2032\n= dT when we define dT\n\u2032\n:= aT\n\u2032\n\u25e6f . If (D, dT ) is a pattern\nof G , then (D, dT\n\u2032\n) \u2208 F \u2032. If (D, dT ) is a pattern of {B, \u03b2}\nx\n32 {C, \u03b3}, then a pattern\nof either {B, \u03b20} or {C, \u03b31} (where these are the compact forbidden T\n\u2032-patterns as\nconstructed in Definition 24) is a (colored) substructure of (D, dT\n\u2032\n). Hence, regardless,\nthere exists (E , eT\n\u2032\n) \u2208 F \u2032 such that (E , eT\n\u2032\n)\ng\n\u2192\u0592(D, dT\n\u2032\n). As dT\n\u2032\n= aT\n\u2032\n\u25e6 f , we have\nthat (D, dT\n\u2032\n)\nf\n\u2192\u0592(A, aT\n\u2032\n), and so (E , eT\n\u2032\n)\nf\u25e6g\n\u2192\u0592(A, aT\n\u2032\n). Consequently, if A is weakly valid\nw.r.t. (F \u2032, T \u2032), then it is valid w.r.t. (F \u2032, T \u2032).\nWe define the rank of a (connected) compact structure to be the number of\napplications of the operator 32 in order that all resulting compact structures are\nbiconnected. We associate with a compact representation a rank polynomial P (X) =\n\u03a3iaiX\ni, where ai is the number of compact forbidden patterns of rank i. Let (F\n\u2032, T \u2032)\nbe obtained from (F , T ) via a Feder\u2013Vardi reduction, with P the rank polynomial\nof (F , T ) and P \u2032 that of (F \u2032, T \u2032). It is easy to check that P \u2032 < P , where < denotes\nthe standard well-ordering of polynomials. Consequently, any sequence of Feder\u2013\nVardi reductions is necessarily finite. It is in order to prove this finiteness that we\nconsider compact representations; given that we now that any sequence of Feder\u2013\nVardi reductions is necessarily finite, we can now revert to dealing with standard,\nas opposed to compact, representations. Of course, all of the results in this section\nmentioning compact representations also hold for standard representations.\n4.3. Enforcing p1 to p5. We now use the reductions developed so far to obtain,\nfrom any connected representation, an equivalent representation satisfying properties\np1, p2, p3, p4, and p5. We remind the reader that we are still assuming all represen-\ntations to be connected, and we note that all reductions so far defined preserve the\nproperty of a representation being connected.\nDefinition 29. Let (F , T ) be a representation where every forbidden pattern of\nF is automorphic and nonconform. Define\n\u03c1(F , T ) = max{||(B, bT )|| : (B, bT ) is a forbidden pattern of F\nthat is not biconnected},\nwhere ||(B, bT )|| is the number of tuples in B; that is, the sum of the numbers of\n{||RB|| : R is a relation symbol of the underlying signature}, where ||RB|| is the num-\nber of tuples in the relation RB.\nConsider the following process, starting with a (connected) representation (F , T ).\nReplace (F , T ) with the representation (HF , T ), and so, by Lemmas 14 and 15,\n(HF , T ) is equivalent to (F , T ) and satisfies p1. Perform a maximal sequence of core,\nembed, and conform reductions and denote the resulting representation by (F1, T1).\nIn particular, every forbidden pattern ofF1 is a core and nonconform, and so \u03c1(F1, T1)\nis well-defined. If \u03c1(F1, T1) = 0, then halt.\nOtherwise, perform a maximal sequence of Feder\u2013Vardi reductions, followed by\na maximal sequence of core, embed, and conform reductions. Denote the resulting\nrepresentation by (F2, T2). In particular, every forbidden pattern of F2 is a core\nand nonconform, and so \u03c1(F2, T2) is well-defined. Also, the sequence of reductions\nperformed in order to obtain (F2, T2) from (F1, T1) is such that:\n\u2022 every forbidden pattern of F1 that is a biconnected (T1-colored) core gives\nrise to forbidden patterns of F2 that are also biconnected (T2-colored) cores\n(see Remark 22); and,\n\u2022 any non-biconnected core of F1 is split into forbidden patterns, each of which\nhas strictly less tuples than the original non-biconnected core of F1.\nThat is, \u03c1(F2, T2) < \u03c1(F1, T1).\n152 FLORENT MADELAINE AND IAIN A. STEWART\np\n2\np\n1\np\n3\np\n4\n{ } { }\n{ } { }\n{ } { }\n{ }\n{ }\nafter a \nFeder-Vardi\nreduction\n{\n{ }\n} { }\n{ }\n{ }\nafter some\nembed\nreductions\n}{\nafter some\nconform\nreductions\nFig. 10. Applying our reductions.\nBy iterating this process, we eventually obtain a connected representation (F \u2032, T \u2032)\nthat is equivalent to (F , T ) and satisfies properties p1, p2, p3, p4, and p5.\nExample 30. Consider a representation (F , T ) over the signature consisting of\ntwo binary relation symbols E and F , where T and the forbidden patterns of F are\nas in the first column of Figure 10 (we represent \u201cE-edges\u201d by solid arrowed lines and\n\u201cF -edges\u201d by dashed arrowed lines).\nAs can be seen, (F , T ) satisfies properties p1, p2, p3, and p4. However, one\nforbidden pattern is not biconnected, and so we perform a Feder\u2013Vardi reduction so\nthat the resulting compact forbidden pattern is as depicted in the second column of\nFigure 10. This messes up the aforementioned properties, and so we perform some\nembed reductions to obtain the compact representation in the third column of Figure\n10 (we have left the depiction of this representation in its compact form so that the\nfigure does not become cluttered). Finally, we perform some conform reductions to\nobtain the representation in the fourth column of Figure 10 which is equivalent to the\noriginal one and satisfies properties p1, p2, p3, p4, and p5.\n4.4. Enforcing p1\u2013p6. Given our notion of a recoloring of a representation, we\ncan define a retract of a representation as follows.\nDefinition 31. A representation (F \u2032, T \u2032) is a retract of the representation\n(F , T ) if there exists a monorecoloring (F \u2032, T \u2032)\nr\n\u2192\u0592(F , T ) and an epirecoloring\n(F , T )\ns\n\u0589(F \u2032, T \u2032) such that s\u25e6r = idT \u2032 . We call a representation (F , T ) automorphic\nif whenever (F \u2032, T \u2032) is a retract of (F , T ), then (F \u2032, T \u2032) \u2248 (F , T ).\nIt is not difficult to see that given any representation (F , T ), there is an au-\ntomorphic representation (F \u2032, T \u2032) that is a retract of (F , T ) (and thus defines the\nsame forbidden patterns problem by Proposition 26). We remark that the notion of\na \u201ccore\u201d for representations does not possess the properties that it does in the case\nof (colored) structures; e.g., it is not unique up to isorecoloring, but we resist the\ntemptation to go into further details here as this has no consequence on what follows.\nCONSTRAINTS, LOGIC AND FORBIDDEN PATTERNS 153\nB A\nT\nf\nT a\n'\n'T\nTb\n'\nT a\ns\nC\ng\nT c\nfT a\nT\nT a\n1\n1 2\nr\nFig. 11. A commutative diagram.\nB A\ng\nC\nh\nf\nh 12\nT a 3\nT 3T 1 T 2\nT a 1\nf T a 1\nT b 2\nT c 1\nT a 1 h 1\nFig. 12. Proving transitivity.\nThe next property we wish to enforce is as follows:\n(p6) The representation (F , T ) is automorphic.\nSuppose that (F , T ) is not automorphic and that (F \u2032, T \u2032)\nr\n\u2192\u0592(F , T ),\n(F , T )\ns\n\u0589(F \u2032, T \u2032), and s \u25e6 r = idT \u2032 , with (F\n\u2032, T \u2032) automorphic. Define\nF\n\u2032\u2032 = {(A, aT\n\u2032\n) : (A, aT ) \u2208 F and aT = r \u25e6 aT\n\u2032\n}.\nLet (A, aT ) \u2208 F , and let aT = r \u25e6 aT\n\u2032\n. By construction, (A, aT\n\u2032\n) \u2208 F \u2032\u2032 and as such\nis not valid w.r.t. (F \u2032\u2032, T \u2032). Thus, (F \u2032\u2032, T \u2032)\nr\n\u2192\u0592(F , T ). However, we also want to show\nthat (F , T )\ns\n\u0589(F \u2032\u2032, T \u2032).\nLet (A, aT\n\u2032\n) \u2208 F \u2032\u2032, and let (A, aT1 ) be such that s \u25e6 a\nT\n1 = a\nT \u2032 ; i.e., (A, aT ) is an\ninverse image of (A, aT\n\u2032\n) via s. Also, because (A, aT\n\u2032\n) \u2208 F \u2032\u2032, by definition there exists\n(A, aT2 ) \u2208 F such that a\nT\n2 = r \u25e6a\nT \u2032 . As (F \u2032, T \u2032)\nr\n\u2192\u0592(F , T ), there exists (B, bT\n\u2032\n) \u2208 F \u2032\nsuch that (B, bT\n\u2032\n)\nf\n\u2192(A, aT\n\u2032\n). Hence, (B, aT1 \u25e6 f) is an inverse image of (B, b\nT \u2032) via\ns, and so there exists (C, cT ) \u2208 F such that (C, cT )\ng\n\u2192(B, aT1 \u25e6 f) (see Figure 11).\nThus, (C, cT )\nf\u25e6g\n\u2192 (A, aT1 ) and (F , T )\ns\n\u0589(F \u2032\u2032, T \u2032). In particular, (F \u2032\u2032, T \u2032) is a retract of\n(F , T ).\nWe need the notion of a recoloring to be transitive.\nLemma 32. If (F1, T1)\nf\n\u2192(F2, T2) and (F2, T2)\ng\n\u2192(F3, T3) are recolorings, then\n(F1, T1)\ng\u25e6f\n\u2192 (F3, T3) is a recoloring.\nProof. Let (A, aT3) \u2208 F3, and let (A, a\nT1)\ng\u25e6f\n\u2192 (A, aT3). As g is a recoloring of\n(F2, T2) to (F3, T3), there exists a forbidden pattern (B, b\nT2) \u2208 F2 for which (B, b\nT2)\nh1\n\u0003\n(A, f \u25e6 aT1). As f is a recoloring of (F1, T1) to (F2, T2), there exists a forbidden pat-\ntern (C, cT1) \u2208 F1 for which (C, c\nT1)\nh2\u2192(B, aT1 \u25e6 h1). The situation can be depicted as\nin Figure 12. Consequently, (C, cT1)\nh1\u25e6h2\u2192 (A, aT1), and (F1, T1)\ng\u25e6f\n\u2192 (F3, T3).\nWe have that (F \u2032\u2032, T \u2032)\nr\n\u2192\u0592(F , T ) and (F , T )\ns\n\u0589(F \u2032, T \u2032), and consequently by\nLemma 32, the identity map on T \u2032 is an isorecoloring from (F \u2032\u2032, T \u2032) to (F \u2032, T \u2032).\nThus, (F \u2032\u2032, T \u2032) is automorphic.\n154 FLORENT MADELAINE AND IAIN A. STEWART\nA\nT'T\nB\nT b\nr\nf\nr\nT a '\nT a '\nfT a '\nFig. 13. Verifying property p1.\nWe now need to affirm the properties p1, p2, p3, p4, and p5 for (F \u2032\u2032, T \u2032); we\ndeal with p1 first (note that if (F , T ) is connected, then so is (F \u2032\u2032, T \u2032)). Assume\nthat A is not valid w.r.t. (F \u2032\u2032, T \u2032). Consequently, by Proposition 26, A is not valid\nw.r.t. (F , T ). Suppose that A\naT\n\u2032\n\u2192T \u2032. Thus, A\nr\u25e6aT\n\u2032\n\u2192 T . Hence, there exists (B, bT ) \u2208 F\nsuch that (B, bT )\nf\n\u2192\u0592(A, r \u25e6 aT\n\u2032\n); see Figure 13. So, (B, aT\n\u2032\n\u25e6 f) \u2208 F \u2032\u2032 and (B, aT\n\u2032\n\u25e6\nf)\u2192\u0592(A, aT\n\u2032\n). Thus, A is not weakly valid w.r.t. (F \u2032\u2032, T \u2032), and property p1 holds for\n(F \u2032\u2032, T \u2032).\nConsider property p2. As every pattern of (F , T ) is automorphic, by Lemma 2,\nso is every pattern of (F \u2032\u2032, T \u2032).\nConsider property p3. Suppose that (A, aT\n\u2032\n), (B, bT\n\u2032\n) \u2208 F \u2032\u2032 are distinct and such\nthat (B, bT\n\u2032\n)\nf\n\u2192\u0592(A, aT\n\u2032\n). Thus, we have that (A, r \u25e6 aT\n\u2032\n), (B, r \u25e6 bT\n\u2032\n) \u2208 F and also\nthat (B, r \u25e6 bT\n\u2032\n)\nf\n\u2192\u0592(A, r \u25e6aT\n\u2032\n). This yields a contradiction as (F , T ) satisfies property\np3, and so (F \u2032\u2032, T \u2032) satisfies property p3.\nTrivially, (F \u2032\u2032, T \u2032) satisfies properties p4 and p5.\nDefinition 33. We say that a connected representation for which properties\np1\u2013p6 hold is a normal representation.\nConsequently, we have proven the following result.\nTheorem 34. Let (F , T ) be a connected representation. Then there is an effec-\ntive procedure by which we can obtain a normal representation equivalent to (F , T ).\nWe end this section with a theorem crucial to what follows.\nTheorem 35. Let (F , T ) be a normal representation. If F \u0002= \u2205, then the target\nT is not valid w.r.t. (F , T ).\nProof. Assume for contradiction that (T , t) is valid w.r.t. (F , T ). If t is one-to-\none, then t is an isomorphism, and thus, as F \u0002= \u2205, there exists (A, aT ) \u2208 F such\nthat t\u22121 \u25e6 aT is a homomorphism from (A, aT ) to (T , t). This yields a contradiction,\nand so we may assume that t is not one-to-one.\nConsider repeatedly applying the homomorphism t to obtain the homomorphism\ntk : T \u2192 T for each k \u2265 1. For some k \u2265 1, it must be the case that t restricted to the\nimage of tk is one-to-one and thus an isomorphism. For such a k, denote the image\nof tk by T \u2032 and the isomorphism from T \u2032 to T \u2032 induced by t by s. In particular, s\u22121\nexists.\nSuppose that there exists (A, aT ) \u2208 F such that the image of aT is contained in\nT \u2032. Clearly, the homomorphism s\u22121 \u25e6 aT : A \u2192 T is well-defined and is a T -colored\nhomomorphism of (A, aT ) to (T , t). This contradicts our assumption that (T , t) is\nvalid w.r.t. (F , T ). Consequently, for every (A, aT ) \u2208 F , the image of aT is not\ncontained in T \u2032.\nConsider the representation (\u2205, T \u2032). Trivially, (\u2205, T \u2032) is a retract of (F , T ), and\nT \u2032 is not isomorphic to T (as t is not one-to-one). Thus, (\u2205, T \u2032) is a proper re-\nCONSTRAINTS, LOGIC AND FORBIDDEN PATTERNS 155\ntract of (F , T ), which contradicts the fact that (F , T ) is automorphic. The result\nfollows.\n5. A generic construction of counterexamples. We prove in this section\nthat any problem given by a normal representation (F , T ) for which F \u0002= \u2205 is not in\nCSP. The proof involves a generic construction of a family of structures that provides,\nin a sense, a counterexample for any candidate for the role of a template; such a family\nof structures is called a witness family. The essence of the proof strategy employed\noriginated in the proofs in [25] that certain graph problems are not in CSP.\nDefinition 36 (witness family). Let (F , T ) be a representation. A family of\nstructures W is said to be a witness family for (F , T ) if and only if W \u2286 FPP(F , T )\nand for any structure B (over the underlying signature), there exists W \u2208 W such\nthat either W \u0003 B or for some W\nh\n\u2192B, the homomorphic image h(W) does not belong\nto FPP(F , T ) (the structure W is said to be a witness for B).\nLemma 37. If a representation (connected or otherwise) has a witness family,\nthen the problem given by the representation does not belong to CSP.\nProof. Let W be a witness family for some representation (F , T ). Assume for\ncontradiction that FPP(F , T ) = CSP(B) for some structure B. By definition, there\nexistsW \u2208 W such that eitherW \u0003 B or for someW\nh\n\u2192B, h(W) \u0002\u2208 FPP(F , T ). Both\ncases immediately lead to a contradiction.\nWe now state the main result of this section and a corollary.\nTheorem 38. Let (F , T ) be a normal representation. If F \u0002= \u2205, then there is a\nwitness family for (F , T ).\nCorollary 39. If (F , T ) is a normal representation for which F \u0002= \u2205, then\nFPP(F , T ) \u0002\u2208 CSP.\nThe remainder of this section is devoted to a proof of the above theorem and\ncorollary. Throughout the remainder of this section, (F , T ) is a normal representation\nfor which F \u0002= \u2205 and where the underlying signature is \u03c3.\nOpening up a structure. By Theorem 35, the structure T is not valid w.r.t. (F , T ).\nLet tT be some homomorphism T\ntT\n\u2192T (there is at least one such homomorphism: the\nidentity). As (F , T ) is normal, we may assume that some biconnected and non-\nconform forbidden pattern (A, aT ) embeds into (T , tT ), via some embedding f . Let\n(D, dT ) be identical to (T , tT ).\nIt is straightforward to show that any biconnected and nonconform pattern must\ncontain a cycle; choose one of minimal size, and let C be the image of this cycle under\nf (and so C is a cycle). Let x be an articulation point of C, and let t be a tuple of\nC that is incident with x (thus RD(t) holds for some relation symbol R). Introduce\na new element x\u2032 into the domain of D.\n\u2022 Suppose that C has size 1; i.e., t is not antireflexive. Replace the first occur-\nrence of x in RD(t) with the new element x\u2032 (leaving all other occurrences of\nall elements as is).\n\u2022 Suppose that C has size 2; i.e., C consists of the antireflexive tuples RD(t)\nand RD1 (t1), where t and t1 have at least two distinct elements in common\n(one of which is x) and where if R = R1, then t and t1 differ. Replace the\nsolitary occurrence of x in RD(t) by x\u2032.\n\u2022 Suppose that C has size greater than 2. Replace the solitary occurrence of x\nin RD(t) by x\u2032.\nThe elements x and x\u2032 of our amended structure are called plug points of sort\n1. We define that dT (x\u2032) = dT (x) and denote the amended T -colored structure by\n(D, dT ) also.\n156 FLORENT MADELAINE AND IAIN A. STEWART\nIf there exists a forbidden pattern of F that embeds into (D, dT ), then we proceed\nas above by choosing an appropriate cycle and an articulation point y of this cycle and\nthen \u201cbreaking\u201d the cycle by introducing a new element y\u2032 and amending a specific\ntuple of D (note that if we have a cycle of size 1 or 2, then we may need more than\none amendment to \u201cbreak\u201d the cycle). Again, we define dT (y\u2032) = dT (y) and denote\nthe amended T -colored structure by (D, dT ) also. As above, we refer to y and y\u2032 as\nplug points. If y was either x or x\u2032, then y and y\u2032 are plug points of sort 1; otherwise,\nthey are plug points of sort 2.\nWe proceed iteratively in this fashion until no forbidden pattern of F embeds into\n(D, dT ), at each stage of the iteration fixing the sort of plug points to be inherited\nfrom the corresponding articulation point or to be of a new sort (the smallest positive\ninteger as yet unused to describe sorts) if the corresponding articulation point had\nnot been assigned a sort. Note that this process terminates as ultimately we would\nobtain a cycle-free structure (into which no forbidden pattern can embed).\nDenote the resulting T -colored \u03c3-structure by (G, gT ) and call it the gadget . Note\nthat (G, gT ) is valid w.r.t. (F , T ) as no forbidden pattern embeds into (G, gT ) (recall\nthat (F , T ) is normal). Note also that (G, gT )\nr\n\u2192(T , tT ), where r is the homomorphism\nwhich identifies plug points of the same sort and otherwise leaves elements fixed.\nPreparing for plugging. Suppose that the gadget (G, gT ) has pi plug points of sort\ni for i = 1, 2, . . . , k (and possibly other elements that have not been assigned a sort).\nFor each i = 1, 2, . . . , k, define the signature \u03c3i as consisting of the relation symbol\nPi of arity pi. For each i = 1, 2, . . . , k and each mi \u2265 pi, define the \u03c3i-structure Q\nmi\ni\nto have domain {0, 1, . . . ,mi \u2212 1} and relation P\nQ\nmi\ni\ni defined as\n{(u1, u2, . . . , upi) : u1 < u2 < \u00b7 \u00b7 \u00b7 < upi}.\nLemma 40. Fix b \u2265 2, fix i \u2208 {1, 2, . . . , k}, and suppose that mi \u2265 b(pi \u2212 1) + 1.\nFor every mapping h : |Qmii | \u2192 {0, 1, . . . , b \u2212 1}, there must exist at least one tuple\nP\nQ\nmi\ni\ni (u1, u2, \u00b7 \u00b7 \u00b7 , upi) such that h(u1) = h(u2) = . . . = h(upi).\nProof. Suppose otherwise for the mapping h. So, there exist at most pi \u2212 1\ndistinct elements x of |Qmii | for which h(x) = j for any j \u2208 {0, 1, . . . , b \u2212 1}. Thus,\n|Qmii | = mi \u2264 b(pi \u2212 1), which yields a contradiction.\nNow define the signature \u03c3 to consist of the relation symbol P of arity p =\n\u03a3ki=1pi. For any m1,m2, . . . ,mk for which mi \u2265 pi, for each i = 1, 2, . . . , k, define\nthe \u03c3-structure Q to have a domain consisting of the disjoint union of the domains\n|Qm11 |, |Q\nm2\n2 |, . . . , |Q\nmk\nk | and relation P\nQ defined as\n{(u1,u2, . . . ,uk) : ui \u2208 |Qmii |\npi and ui1 < u\ni\n2 < \u00b7 \u00b7 \u00b7 < u\ni\npi\nfor each i = 1, 2, . . . , k}\n(the notation is such that uij is the jth component of the tuple u\ni). So, in a sense,\nQ is a sort of \u201camalgamation\u201d of Qm1i ,Q\nm2\n2 , . . . ,Q\nmk\nk (note that we have suppressed\nthe parameters \u201cm1,m2, . . . ,mk\u201d in the denotation of Q for ease of readability).\nLemma 41. Fix b \u2265 2 and suppose that mi \u2265 b(pi\u22121)+1 for each i = 1, 2, . . . , k.\nFor every mapping h : |Q| \u2192 {0, 1, . . . , b \u2212 1}, there must exist at least one tuple\nPQ(u1,u2, . . . ,uk) such that h(ui1) = h(u\ni\n2) = \u00b7 \u00b7 \u00b7 = h(u\ni\npi\n) for all i = 1, 2, . . . , k.\nProof. The proof is immediate from Lemma 40.\nThe girth of a structure is the length of its shortest cycle (and so if there are no\ncycles, then the structure has infinite girth). The following theorem is due to Feder\nand Vardi [15] (and generalizes a result due to Erdo\u00a8s; see [15]).\nCONSTRAINTS, LOGIC AND FORBIDDEN PATTERNS 157\nTheorem 42. Fix two positive integers r and s. For every structure B of size\nn, there exists a structure B\u2032 (over the same signature) of size na (where a depends\nsolely on r and s) such that:\n\u2022 the girth of B\u2032 is greater than r;\n\u2022 B\u2032 \u2192 B; and\n\u2022 for every structure C of size at most s (over the same signature), B \u2192 C if\nand only if B\u2032 \u2192 C.\nFurthermore, B\u2032 can be constructed from B in randomized polynomial time.\nRemark 43. We have already mentioned that Ga\u00b4bor Kun has derandomized Theo-\nrem 1. To be more precise, he achieved this by giving a deterministic polynomial-time\nalgorithm for the B\u2032 in the above theorem.\nFor each forbidden pattern (A, aT ) of F , define \u03b3A to be the length of the longest\ncycle of A. Define \u03b3 to be the maximum of {\u03b3A : (A, a\nT ) \u2208 F}.\nFix b \u2265 2. By applying Theorem 42, there is a \u03c3-structure Q\n\u2032\nof girth greater\nthan \u03b3 for which Q\n\u2032\n\u2192 Q and for which for every structure C of size at most b, Q \u2192 C\nif and only if Q\n\u2032\n\u2192 C (of course, we assume thatm1,m2, . . . ,mk satisfy the hypothesis\nof Lemma 41).\nLemma 44. For every mapping h : |Q\n\u2032\n| \u2192 {0, 1, . . . , b \u2212 1}, there must exist at\nleast one tuple PQ\n\u2032\n(u1,u2, . . . ,uk) such that h(ui1) = h(u\ni\n2) = \u00b7 \u00b7 \u00b7 = h(u\ni\npi\n) for all\ni = 1, 2, . . . , k.\nProof. The condition in the statement of the lemma (and also the statement of\nLemma 41, with the same value b) is equivalent to there not being a homomorphism\nfrom Q\n\u2032\nto the \u03c3-structure with domain {0, 1, . . . , b\u2212 1} and relation\nP = {0, 1, . . . , b\u2212 1}p \\ {(bp11 , b\np2\n2 , . . . , b\npk\nk ) : bi \u2208 {0, 1, . . . , b\u2212 1}\nfor every i = 1, 2, . . . , k}\n(where bpii is the pi-tuple with each component equal to bi). The result follows by\nLemma 41 and the properties of Q\n\u2032\ndetailed above.\nBuilding the witness family. Fix some \u03c3-structure B of size b. We are now in a\nposition to build a \u03c3-structureWB which will act as a witness for B (see Definition 36).\n\u2022 Initialize the domain of WB to be that of Q\n\u2032\n.\n\u2022 For every tuple PQ\n\u2032\n(u1,u2, . . . ,uk), where each ui \u2208 |Q\n\u2032\n|pi , plug a copy of\nthe gadget G by identifying the pi sort-i plug points of G with the pi \u201csocket-\npoints\u201d ui of |Q\n\u2032\n| for each i = 1, 2, . . . , k.\nAll such copies of the gadget should be disjoint, except that two copies of the gadget\nmay have plug points in common within WB and except where the gadget (possibly)\ncontains a tuple RG(t) with every element of t a plug point. Let us label every tuple\nof every relation RWB with the name of the tuple of PQ\n\u2032\nto which the copy of the\ngadget from which it comes corresponds. As just mentioned, there may be difficulties\nwhere the gadget contains a tuple RG(t) with every element of t a plug point, as this\ntuple might require more than one label. In such a case, simply arbitrarily choose one\nlabel from the set of potential candidates. Finally, note that WB = WB\u2032 whenever\n|B| = |B\u2032|; i.e., the definition ofWB depends solely upon b and not on the tuples of B.\nProposition 45. The structure WB is a witness for B.\nProof. We begin by proving that there exists a homomorphism WB\nwT\n\u2192T .\nFrom above, Q\n\u2032\n\u2192 Q via some homomorphism q. Recall that the domain of Q\nis the disjoint union of |Qm11 |, |Q\nm2\n2 |, . . . , |Q\nmk\nk |. Hence, we can partition |Q\n\u2032\n| into\n158 FLORENT MADELAINE AND IAIN A. STEWART\ndisjoint subsets S1, S2, . . . , Sk, where for each i = 1, 2, . . . , k, Si = {u \u2208 |Q\n\u2032\n| : q(u) \u2208\n|Qmii |}. By definition of P\nQ, if PQ(u1,u2, . . . ,uk) holds, where ui is a pi-tuple of\nelements, then ui \u2208 Spii for i = 1, 2, . . . , k. In particular, in any copy of the gadget\nG, plug points of sort i are always identified with \u201csocket elements\u201d from Si for\ni = 1, 2, . . . , k. Consequently, the homomorphism G\ngT\n\u2192T , under which plug points of\nthe same sort are always mapped to the same element of |T |, can be extended to a\nhomomorphism WB\nwT\n\u2192T .\nSuppose that (WB, w\nT ) is not valid w.r.t. (F , T ). So, some biconnected, non-\nconform forbidden pattern (A, aT ) embeds into (WB, w\nT ). As no forbidden pattern\nembeds into the gadget and each forbidden pattern is biconnected and nonconform,\nthere must exist a cycle C in WB of length less than \u03b3 and involving tuples from at\nleast two copies of the gadget within WB (we reiterate that each forbidden pattern\nis biconnected, and so if there were no such cycles, then we would have an articula-\ntion point) or equivalently, involving tuples labeled with at least two distinct tuples\nof PQ\n\u2032\n(according to our labeling process as detailed prior to the statement of this\nproposition). However, the cycle C of WB yields a closed path of tuples in Q\n\u2032\n(by\nfollowing the labels). Continuing, this closed path of tuples in Q\n\u2032\nyields a cycle in Q\n\u2032\nof length at least 2 and less than \u03b3; this contradicts the fact that Q\n\u2032\nhas girth greater\nthan \u03b3. Thus, (WB, w\nT ) is valid w.r.t. (F , T ).\nIf WB \u0002\u2192 B, then we are done. So, suppose that WB\nh\n\u2192B. The homomorphism\nh induces a map h\u02c6 : |Q\n\u2032\n| \u2192 {0, 1, . . . , b \u2212 1}, and so by Lemma 44, there exists a\ntuple PQ\n\u2032\n(u1,u2, . . . ,uk), where ui \u2208 |Q\n\u2032\n|pi and h\u02c6(ui1) = h\u02c6(u\ni\n2) = \u00b7 \u00b7 \u00b7 = h\u02c6(u\ni\npi\n) for\ni = 1, 2, . . . , k. Thus, by construction ofWB, h(WB) contains a homomorphic image of\nthe gadget G where all plug points of the same sort are mapped to the same element.\n(\u22c6) Consequently, h(WB) contains a homomorphic image of the structure T , via\nsome homomorphism h\u02dc.\nSuppose that h(WB)\nf\n\u2192T . So, T\nf\u25e6h\u02dc\n\u2192T and, by Theorem 35, there exists a forbid-\nden pattern (A, aT ) \u2208 (F , T ) such that (A, aT )\nf\u02dc\n\u2192(T , f \u25e6 h\u02dc). Hence, we have that\n(A, aT )\nh\u02dc\u25e6f\u02dc\n\u2192 (h(WB), f), and h(WB) \u0002\u2208 FPP(F , T ), as required.\nThus, we have proven Theorem 38. Lemma 37 immediately yields Corollary 39.\n6. MMSNP versus CSP. We now deal with the disconnected case before turn-\ning to the more general situation involving MMSNP and CSP.\n6.1. Normal sets of representations.\n6.1.1. The disconnected case. We first turn to the situation when a represen-\ntation is not necessarily connected. Let (F , T ) be a representation such that there\nexists a disconnected forbidden pattern (A, aT ) \u2208 F ; that is, (A, aT ) is the disjoint\nunion of two colored structures (B, bT ) and (C, cT ). Define F \u2032 = (F \\ {(A, aT )}) \u222a\n{(B, bT )} and F \u2032\u2032 = (F \\ {(A, aT )}) \u222a {(C, cT )}. Trivially, we have that\nFPP(F , T ) = FPP(F \u2032, T ) \u222a FPP(F \u2032\u2032, T ).\nBy iterating this construction, we can transform (F , T ) into a set of connected repre-\nsentations so that a structure is in FPP(F , T ) if and only if it is in at least one of the\nforbidden patterns problems corresponding to the derived connected representations.\nNext, we compute the normal representation of each connected representation,\njust as we did in section 4. Finally, we enforce the following property on our set of\nnormal representations:\nCONSTRAINTS, LOGIC AND FORBIDDEN PATTERNS 159\n(p7) For any two normal representations (F \u2032, T \u2032) and (F \u2032\u2032, T \u2032\u2032), we have that\n(F \u2032, T \u2032)\u0003 (F \u2032\u2032, T \u2032\u2032).\nThis property is enforced by simply removing the normal representation (F \u2032, T \u2032)\nfrom the collection should there exist another (different) normal representation\n(F \u2032\u2032, T \u2032\u2032) for which (F \u2032, T \u2032)\u2192(F \u2032\u2032, T \u2032\u2032).\nConsequently, we may assume that any representation (F , T ) corresponds to a\ncollection N of normal representations (possibly containing only one such representa-\ntion) for which property p7 holds; we call N the normal set corresponding to (F , T ).\nBy Proposition 26, the problem FPP(F , T ) is the union of the forbidden patterns\nproblems of the representations in the normal set N; that is,\nFPP(F , T ) =\n\u22c3\n{FPP(F \u2032, T \u2032) : (F \u2032, T \u2032) \u2208 N}.\n6.1.2. Finite unions of forbidden patterns problems. The notion of a nor-\nmal set extends naturally to finite unions of forbidden patterns problems: Given a\nfinite set of representations, we split every disconnected representation into a set of\nconnected representations as above, take the union of all of these sets, and simplify\nthese sets so as to enforce p7. We write FPP(N) for\n\u22c3\n(F,T )\u2208N FPP(F, T ).\nProposition 46. Let N be a normal set that contains a representation (F \u2032, T \u2032)\nsuch that F \u2032 \u0002= \u2205. Then T \u2032 is a no instance of FPP(N).\nProof. By Theorem 35, if T \u2032 is valid w.r.t. (F \u2032, T \u2032), then F \u2032 = \u2205. Thus, T \u2032 is\nnot valid w.r.t. (F \u2032, T \u2032).\nSuppose that T \u2032 is valid w.r.t. (F \u2032\u2032, T \u2032\u2032), where (F \u2032\u2032, T \u2032\u2032) is a representation in N\ndistinct from (F \u2032, T \u2032). That is, there exists a homomorphism r : T \u2032 \u2192 T \u2032\u2032 such that\nfor every forbidden pattern (A\u2032\u2032, aT\n\u2032\u2032\n) \u2208 F \u2032\u2032, (A\u2032\u2032, aT\n\u2032\u2032\n) \u0003 (T \u2032, r). In particular, if\n(A\u2032\u2032, aT\n\u2032\u2032\n) \u2208 F \u2032\u2032, then there does not exist a homomorphism aT\n\u2032\n: A\u2032\u2032 \u2192 T \u2032 for which\nr \u25e6 aT\n\u2032\n= aT\n\u2032\u2032\n. Consequently, r is (trivially) a recoloring of (F \u2032, T \u2032) to (F \u2032\u2032, T \u2032\u2032).\nThis yields a contradiction, and so T \u2032 is not valid w.r.t. (F \u2032\u2032, T \u2032\u2032). The result\nfollows.\n6.2. Finite unions.\nDefinition 47 (strong witness family). Let N be a set of representations. A\nfamily of structures W is said to be a strong witness family for N if and only if\nW \u2286 FPP(N) and for any finite set of structures {B1,B2, . . . ,Bn} (over the underlying\nsignature), there exists W \u2208 W such that for every 1 \u2264 i \u2264 n, either W \u0003 Bi or for\nsomeW\nh\n\u2192Bi, the homomorphic image h(W) does not belong to FPP(N) (the structure\nW is said to be a strong witness for B).\nLemma 48. If a set of representations N has a strong witness family, then the\nproblem FPP(N) is not a finite union of constraint satisfaction problems.\nProof. Let W be a strong witness family for some representation (F , T ). Assume\nfor contradiction that\nFPP(N) =\n\u22c3\n(F,T )\u2208N\nFPP(F, T ) =\n\u22c3\n1\u2264i\u2264n\nCSP(Bi)\nfor some finite set of structures {B1,B2, . . . ,Bn}. By definition, there exists a strong\nwitnessW \u2208 W . SinceW is a yes instance of FPP(N), we have thatW \u2208 CSP(Bi) for\nsome 1 \u2264 i \u2264 n. Hence, by definition of a strong witness, there is a homomorphism\nW\nh\n\u2192Bi such that h(W) \u0002\u2208 FPP(N). However, h(W) \u2208 CSP(Bi) = FPP(N), which is\nabsurd.\n160 FLORENT MADELAINE AND IAIN A. STEWART\nWe can extend the main result of the previous section to finite unions of forbid-\nden patterns problems and, in particular, to disconnected representations. We first\ndeal with the case when the normal set corresponds to a finite union of constraint\nsatisfaction problems.\nTheorem 49. Let N be a normal set of the form {(\u2205, T1), (\u2205, T2), . . . , (\u2205, Tn)}.\nThen FPP(N) =\n\u22c3\n1\u2264i\u2264n CSP(Ti). Moreover, if\n\u22c3\n1\u2264i\u2264n\nCSP(Ti) =\n\u22c3\n1\u2264i\u2264m\nCSP(T \u2032i ),\nthen the following hold:\n(i) for every 1 \u2264 i \u2264 m, there exists 1 \u2264 j \u2264 n such that T \u2032i\u2192Tj;\n(ii) for every 1 \u2264 i \u2264 n, there exists 1 \u2264 j \u2264 m such that Ti is the core of T\n\u2032\nj ;\n(iii) m \u2265 n.\nProof. Property (i) follows directly from the fact that T \u2032i \u2208 CSP(T\n\u2032\ni ). We now\nprove (ii). Using a similar argument as above, there exists T \u2032j such that Ti\u2192T\n\u2032\nj . By\n(i), there exists some Tk such that T\n\u2032\nj\u2192Tk. By composition, Ti\u2192Tk. Recall that, by\ndefinition of the normal set, there is no homomorphism between any Ti and Tk for\nany i such that 1 \u2264 i < k \u2264 n. Moreover, every Ti is automorphic. Thus, i = k,\nand it follows that Ti is homomorphically equivalent to T\n\u2032\nj . This proves that Ti is\nthe core of T \u2032j . Property (iii) follows from (ii) since Ti and Tk, for any i, k such that\ni \u0002= k, cannot be the core of the same T \u2032j ; otherwise, they would be isomorphic (by\nuniqueness of the core). This concludes the proof.\nWe can now precisely characterize when a normal set does not give rise to a finite\nunion of constraint satisfaction problems.\nTheorem 50. The following are equivalent:\n(i) the normal set N contains a representation (F \u2032, T \u2032), with F \u2032 \u0002= \u2205;\n(ii) the problem FPP(N) is not a finite union of constraint satisfaction problems;\n(iii) there exists a strong witness family for N.\nProof. The implication (ii) =\u21d2 (i) is the contrapositive of the (trivial statement\nin the) previous theorem. The implication (iii) =\u21d2 (ii) holds by Lemma 48. We\nnow prove that (i) =\u21d2 (iii).\nThe case when N is a singleton is a direct corollary of the proof of Theorem 38,\nas the construction of a witness family can be easily adapted to obtain a strong\nwitness family. Indeed, as is pointed out just before the statement of Proposition 45,\nthe construction of WB depends only on the size of B. So, for a set of structures\nB = {B1,B2, . . . ,Bn}, we build WBi , where Bi is a structure with the largest domain\nwithin this set. Now, for any structure C such that |C| \u2264 |Bi|, if WBi\nh\n\u2192C, then\nh(WBi) contains a homomorphic image of the structure chosen as a basis for our\ngadget, namely, T \u2032 (see (\u22c6) in the proof of Proposition 45), which is not a yes instance\nof FPP(N) (otherwise, T \u2032 would also be a yes instance of FPP(N), which would\ncontradict Theorem 35). This means that WBi is a strong witness for B.\nSuppose now that N is not a singleton. By Proposition 46, T \u2032 is not valid w.r.t.\n(F \u2032\u2032, T \u2032\u2032) for any (F \u2032\u2032, T \u2032\u2032) \u2208 N. Thus, we may choose T \u2032 as the basis of our gadget\nand proceed as in the case of a singleton in order to get a strong witness family for\nN.\n6.3. The main result. We need a last definition before we can state the main\nresult of this paper. Let \u03a6 be a sentence of MMSNP. We call a normal set of \u03a6 the\nnormal set of the set of representations obtained from \u03a6 as follows: First, \u03a6 is logically\nequivalent to a finite set of primitive sentences, which we can build effectively as in\nCONSTRAINTS, LOGIC AND FORBIDDEN PATTERNS 161\nthe proof of Proposition 11; second, each such primitive sentence captures precisely\na forbidden patterns problem (again, this is effective; see Theorem 12); finally, we\ncompute the normal set of this set of representations. The main result of this paper\nis an exact characterization of the strict inclusion of MMSNP in CSP.\nTheorem 51. Let \u03a6 be a sentence of MMSNP. The problem defined by \u03a6 is in\nCSP if and only if its normal set consists of a singleton (\u2205, T ).\nProof. The result follows from the definition of the normal set of \u03a6 and from\nTheorems 49 and 50.\n7. Concluding remarks. Building upon a previous attempt by Feder and Vardi\nto provide a logical characterization of constraint satisfaction problems, we have in-\ntroduced a new class of combinatorial problems, the forbidden patterns problems,\nand shown that they provide a combinatorial characterization of the logic MMSNP.\nFurthermore, we have provided a complete classification as to when forbidden pat-\nterns problems are in CSP, and there exists an effective procedure to decide whether\na given forbidden patterns problem (or problem described by a sentence of MMSNP)\nis in CSP or not.\nWe end by describing two directions for further research. Tardif and Nes\u02c7etr\u02c7il [31]\nhave characterized duality pairs, which correspond essentially to forbidden patterns\nproblems with a single color (the target as only one element) that are also constraint\nsatisfaction problems. Their elegant proof relies on a correspondence between these\nduality pairs and the notion of density (with respect to the partial order given by the\nexistence of a homomorphism). This correspondence exists essentially because one\ncan define the notion of the exponential of a structure (in graph theory, this notion\nplays an important role in relation with Hedetniemi\u2019s conjecture [29]). It turns out\nthat a notion of the exponential of a representation can also be defined [24]. In a\nforthcoming paper, we will elaborate on this and delineate the relationship between\nthe two approaches.\nAnother direction for further research relates to the containment problem and\nis as follows. A homomorphism problem is given by its template; hence, given two\nhomomorphism problems CSP(A) and CSP(B) over the same signature, it is decidable\nwhether CSP(A) \u2286 CSP (B). As a matter of fact, the containment problem for\nhomomorphism problems is nothing other than the uniform homomorphism problem,\nknown to be NP-complete (as we noted in Remark 5). We would like to extend\nthis result to the more general containment problem for forbidden patterns problems\n(given by their representations). Indeed, Feder and Vardi proved in [15] that the\ncontainment problem for MMSNP is decidable; hence by Theorem 13, it follows that\nthe containment problem for forbidden patterns problems is decidable. However, to\nthe best of our knowledge, nothing has been proved about the complexity of the\ncontainment problem for MMSNP.\nWe know that the existence of a recoloring implies the containment of the corre-\nsponding problems, and this provokes the following question: \u201cDoes the existence of\na recoloring correspond to the containment of the corresponding problems?\u201d However,\nwe can answer this question negatively. Indeed, the major inconvenience of forbidden\npatterns problems, in comparison with homomorphism problems, is that the inclusion\nof two problems does not necessarily reduce to the question of the existence of a recol-\noring; for, in [24], an example is given where a representation is transformed into an\nequivalent representation, using Feder\u2013Vardi reductions, but such that the representa-\ntions are not equivalent with respect to recolorings. However, we think that the right\nnotion of a morphism for representations should constitute a finite sequence of recol-\n162 FLORENT MADELAINE AND IAIN A. STEWART\norings and Feder\u2013Vardi reductions. More precisely, we believe that the following ques-\ntion can be answered affirmatively: \u201cDoes the existence of a recoloring correspond to\nthe containment of the corresponding problems in the case of normal (connected) repre-\nsentations?\u201d In [24], a few restricted cases for which an affirmative answer to the above\nquestion is obtained, and this leads us to propose the following conjecture (where for\nany representation R, normal(R) is a normal representation equivalent to R).\nConjecture 52. Let R1 and R2 be two nontrivial connected representations.\nFPP(R1) \u2286 FPP(R2) if and only if normal(R1)\u2192 normal(R2).\nAcknowledgment. The first author thanks Etienne Grandjean for his continual\nsupport.\nREFERENCES\n[1] M. Benedikt and L. Segoufin, Regular tree languages definable in FO, in Proceedings of the\n22nd International Symposium on Theoretical Aspects of Computer Science (STACS\u201905),\nV. Diekert and B. Durand, eds., Lect. Notes Comput. Sci. 3404, Springer-Verlag, Berlin,\n2006, pp. 327\u2013339.\n[2] M. Bodirsky and V. Dalmau, Datalog and constraint satisfaction with infinite templates,\nin Proceedings of the 23rd International Symposium on Theoretical Aspects of Computer\nScience (STACS\u201906), B. Durand and W. Thomas, eds., Lect. Notes Comput. Sci. 3884,\nSpringer-Verlag, Berlin, 2006, pp. 646\u2013659.\n[3] A. A. Bulatov, A dichotomy theorem for constraints on a three-element set, in Proceedings of\nthe 43rd IEEE Symposium on Foundations of Computer Science (FOCS\u201902), 2002, pp. 649\u2013\n658.\n[4] A. A. Bulatov, Tractable conservative constraint satisfaction problems, in Proceedings of the\n18th IEEE Symposium on Logic in Computer Science (LICS\u201903), 2003, pp. 321\u2013330.\n[5] A. A. Bulatov and V. Dalmau, Towards a dichotomy theorem for the counting constraint\nsatisfaction problem, in Proceedings of the 44th IEEE Symposium on Foundations of Com-\nputer Science (FOCS\u201903), 2003, pp. 562\u2013573.\n[6] A. A. Bulatov, A. A. Krokhin, and P. Jeavons, Constraint satisfaction problems and finite\nalgebras, in Proceedings of the 27th International Colloquium on Automata, Languages\nand Programming (ICALP\u201900), U. Montanari, J. D. P. Rolim and E. Welzl, eds., Lect.\nNotes Comput. Sci. 1853, Springer-Verlag, Berlin, 2000, pp. 272\u2013282.\n[7] A. K. Chandra and P. M. Merlin, Optimal implementation of conjunctive queries in re-\nlational databases, in Proceedings of the 9th ACM Symposium on Theory of Computing\n(STOC\u201977), 1977, pp. 77\u201390.\n[8] J. Diaz, M. Serna, and D. M. Thilikos, The complexity of restrictive H-coloring, in Pro-\nceedings of the 28th International Workshop on Graph-Theoretic Concepts in Computer\nScience (WG\u201902), L. Kucera, ed., Lect. Notes Comput. Sci. 2573, Springer-Varlag, Berlin,\n2002, pp. 126\u2013137.\n[9] M. Dyer and C. Greenhill, The complexity of counting graph homomorphisms, Random\nStructures Algorithms, 17 (2000), pp. 260\u2013289.\n[10] R. Fagin, Generalized first-order spectra and polynomial-time recognizable sets, in Complexity\nof Computation, R. M. Karp, ed., SIAM-AMS Proc. 7, 1974, pp. 43\u201373.\n[11] T. Feder, Classification of homomorphisms to oriented cycles and of k-partite satisfiability,\nSIAM J. Discrete Math., 14 (2001), pp. 471\u2013480.\n[12] T. Feder and P. Hell, List constraint satisfaction and list partition, manuscript.\n[13] T. Feder, P. Hell, and J. Huang, List homomorphisms and circular arc graphs, Combina-\ntorica, 19 (1999), pp. 487\u2013505.\n[14] T. Feder, P. Hell, and J. Huang, Bi-arc graphs and the complexity of list homomorphisms,\nJ. Graph Theory, 42 (1999), pp. 61\u201380.\n[15] T. Feder and M. Y. Vardi, The computational structure of monotone monadic SNP and\nconstraint satisfaction: A study through Datalog and group theory, SIAM J. Comput., 28\n(1998), pp. 57\u2013104.\n[16] H. Gaifman, H. Mairson, Y. Sagiv, and M. Y. Vardi, Undecidable optimization problems\nfor database logic programs, J. ACM, 40 (1993), pp. 683\u2013713.\n[17] G. Hahn and C. Tardif, Graph homomorphisms: Structure and symmetry, in NATO Sci. Ser.\nC Math. Phys. Sci. 497, Kluwer, 1997, pp. 107\u2013166.\nCONSTRAINTS, LOGIC AND FORBIDDEN PATTERNS 163\n[18] P. Hell and J. Nes\u02c7etr\u02c7il, On the complexity of H-coloring, J. Combin. Theory Ser. B, 48\n(1990), pp. 92\u2013110.\n[19] P. Hell and J. Nes\u02c7etr\u02c7il, Graphs and Homomorphisms, Oxford Lecture Ser. Math. Appl.,\nOxford University Press, London, 2004.\n[20] P. Jeavons, D. A. Cohen, and M. Gyssens, Closure properties of constraints, J. ACM, 44\n(1997), pp. 527\u2013548.\n[21] P. G. Kolaitis and M. Y. Vardi, Conjunctive-query containment and constraint satisfaction,\nJ. Comput. System Sci., 61 (2000), pp. 302\u2013332.\n[22] R. E. Ladner, On the structure of polynomial time reducibility, J. ACM, 22 (1975), pp. 155\u2013\n171.\n[23] B. Larose, C. Loten, and C. Tardif, A characterisation of first-order constraint satisfaction\nproblems, in Proceedings of the 21st IEEE Symposium on Logic in Computer Science\n(LICS\u201906), IEEE, 2006, pp. 201\u2013210.\n[24] F. R. Madelaine, Constraint satisfaction problems and related logic, Ph.D. thesis, University\nof Leicester, Leicester, 2003.\n[25] F. R. Madelaine and I. A. Stewart, Some problems not definable using structure homomor-\nphisms, Ars Combin., 67 (2003), pp. 153\u2013159.\n[26] C. H. Papadimitriou, Computational Complexity, Addison-Wesley, Reading, MA, 1994.\n[27] A. Puricella and I. A. Stewart, A generic greedy algorithm, partially-ordered graphs and\nNP-completeness, in Proceedings of the 27th International Workshop on Graph-Theoretic\nConcepts in Computer Science (WG\u201901), A. Brandstaedt and V. B. Le, eds., Lect. Notes\nComput. Sci. 2204, Springer-Verlag, Berlin, 2001, pp. 306\u2013316.\n[28] A. Puricella and I. A. Stewart, Greedy algorithms, H-colourings and a complexity-theoretic\ndichotomy, Theoret. Comput. Sci., 290 (2003), pp. 1897\u20131913.\n[29] N. Sauer, Hedetniemi\u2019s conjecture \u2013 a survey, Discrete Math., 229 (2001), pp. 261\u2013292.\n[30] T. J. Schaefer, The complexity of satisfiability problems, in Proceedings of the 10th ACM\nSymposium on Theory of Computing (STOC\u201978), 1978, pp. 216\u2013226.\n[31] C. Tardif and J. Nes\u02c7etr\u02c7il, Duality theorems for finite structures (characterizing gaps and\ngood characterizations), J. Combin. Theory Ser. B, 80 (2000), pp. 80\u201397.\n\n"}